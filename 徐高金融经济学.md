##第五讲 均值——方差分析（Mean-Variance Analysis）
马科维茨 1952 Portfolio Selection $\longrightarrow $ CAPM $\longrightarrow$ First Revolution
“投资者如果既关心投资品的收益率又关心投资品的风险，那么他该如何做决策？”
Mean：用资产的历史数据的均值刻画未来该资产的回报率的高低
Variance：用资产的历史数据的方差来刻画该资产的不确定性(风险)；
Mean-Variance Analysis；
在马科维茨提出之前，投资决策如同点菜，不关心菜品之间的相互影响，只单单的局限于一种菜品本身的品质。但是，正真影响消费者效用的是一桌菜整体情况。换言之，之前的投资决策忽视了资产之间相互联系的关系，即covariance，协方差。

概念关系理清楚：
risk-free $r_f$(无风险资产$r_f$)
price 90; 
state A 100(0.5);
state B 100(0.5);

risky $\tilde{r}$ (风险资产 $\tilde{r}$)
price 80; 
state A 120(0.5);
state B 80(0.5);

ex-ante rate of return(事前回报率)(我们关注的回报率)：
=在0期计算的回报率=Expected rate of return(期望回报率) (注：$\tilde{r}$为随机变量)
$E(\tilde{r})=0.5(\frac{120}{80}-1)+0.5(\frac{80}{80}-1)=25\%$
$E(r_f)=11\%$
ex-post rate of return(事后回报率)(可观测到的数据)：
在1期计算的回报率=without uncertainty(确定事件)
$E(r_a)=(\frac{120}{80}-1)=50\%$
$E(r_b)=(\frac{80}{80}-1)=0\%$
$E(r_f)=11\%$

且$E(\tilde{r})=0.5E(r_a)+0.5E(r_b)$
risk premium(风险溢价)=$E(\tilde{r})-r_f$

均值——方差分析是用
historical ex-post rate of return $\longrightarrow$ Mean $\longrightarrow$(代表) $E(\tilde{r})$ = Expected rate of return

historical ex-post rate of return $\longrightarrow$ Variance $\longrightarrow$(代表) riskiness of $\tilde{r}$

$Q$：为什么无风险资产的方差为零？
Variance($r_f$)=0 
但是国债的收益率的历史数据的方差绝对不是0，均值——方差分析中将无风险资产的收益率认为是0。因为，在0期的时候，国债上标明的收益率是等于你持有到期后所获得收益率，期望收益率等于国债所标的收益率，期间不存在不确定性。

用历史数据来推测未来时，不要忘记会存在幸存者偏差：(Black Swan 黑天鹅情况)


存在Mean-Variance之后，在$E(r)-\sigma$平面上可以表示所有的资产。

如何组合portfolio？
$(w_1,w_2,w_3,...,w_n)$
n number of asset 
$w_i$ share of wealth on asset
$\sum_{i-1}^{n}w_i=1$
$w_i>0$ long 做多
$w_i<0$ short 做空

一种风险资产和无风险资产的组合：
portfolio $r_p =r_f+\tilde{r_s};(1-w,w)$
$$\bar {r_p}=E((1-w)r_f+w\tilde{r_s})\\=(1-w)r_f+wE(\tilde{r_s})\\=(1-w)r_f+w\bar r_s\\=r_f+w(\bar r_s-r_f)\\=r_f+\frac{\bar r_s-r_f}{\sigma _s}\sigma _p $$

$${\sigma_p}^2=D((1-w)r_f+w\tilde{r_s})\\=w^2D(\tilde{r_s})\\=w^2{\sigma_s}^2$$

在$E(r)-\sigma$平面上可以表示为一根直线。

一种风险资产和另一个风险资产的组合：
portfolio $r_p =\tilde{r_1}+\tilde{r_2};(w,1-w)$
$$\bar {r_p}=w\bar r_1+(1-w)\bar r_2$$

$${\sigma_p}^2=D(w\tilde{r_1}+(1-w)\tilde{r_2})\\=w^2D(\tilde{r_1})+(1-w)^2D(\tilde{r_2})+2w(1-w)cov(\tilde{r_1},\tilde{r_2})\\=w^2{\sigma_1}^2+(1-w)^2{\sigma_2}^2+2w(1-w)\sigma_{12}$$

在$E(r)-\sigma$平面上可以表示为一根双曲线，且可以向两边延伸，如果存在买空和卖空的情况下。

双曲线的弯曲程度取决于两个资产的协方差，相关系数等于-1，构成的双曲线交纵轴为$r_f$；相关系数为1时，连接两个资产的直线。

两个风险资产组合后可以找到最小方差组合；
diversification 分散化；

efficient frontier有效前沿：

添加无风险资产后，可选择的区域从一个双曲线区域变成了一个锥形区域，此时最因该选择的部分变成了锥形区域最上面的那一条直线，无风险资产与之前的有效前沿相切与M点(市场组合)(CML资本市场线)。

不同偏好的投资者选择了相同的风险资产组合M，不同的风险偏好决定了投资者以多少的比例持有市场组合M和无风险资产。即，不论投资者的风险偏好如何，都应该以相同的方式持有市场组合，区别在于持有的比例如何。

资本市场线$CML:\bar r-r_f=\frac{\sigma}{\sigma_M}(\bar {r_M}-r_f)$

共同基金分离定理(Mutual Fund (Separation) Theorem)：
(1)$M$
(2)$(r_f,r_M);(1-w_i,w_i)\ for \ i$
结论：
(1)共同基金标准化，不关注投资者的风险偏好；
(2)共同基金分离定理推论：对于任意两个有效前沿上的风险资产组合，将他们再次组合之后，一定还是在有效前沿之上，不会超出有效前沿范围之外。

但是距离我们之前讨论的问题：贴现率$(r)$如何计算？还有一步之遥，而这一步是从市场组合M为起点而跨出的。

##第六讲 CAPM
Capital Asset Pricing Model
根据Mean-Variance，投资者持有风险资产的方式都是一样的，以市场组合M的方式进行持有。
那么市场组合M是什么？囊括市场上所有的风险资产：股票，债券，房地产，等一系列风险资产，即M就是市场本身。

反证：如果求解出来的市场组合与现实世界中的市场不一致，那就说明，现实世界中的风险资产的供给和需求不一致，即市场不出清。市场不出清会导致市场价格调整，进而导致市场资产的收益和方差变化，使得优化问题的解与市场的情况相一致。

CAPM推导：

$Assumptions：$
Market:
(1)No transaction costs,taxes;
(2)Perfect competition
(3)Infinitely divisible 
Investor:
(1)Mean-Variance preference
(2)No limit on short selling 
(3)Common believe

Equilibrium 均衡
资产市场的均衡，要求
(1)所有人达到效用的最优化
(2)资产市场中的资产供需相等，即市场出清

在均衡的条件下，即上述两条都可以实现的情况下，价格水平所满足的关系式。

$Claim：$
$Everyone\ holds\ M\ in\ equilibrium.$
which means:
(1)每个人持有市场组合时效用是最大化的。也就是说，当这个人持有别的市场组合时，其效用不会最大化。

假设：投资者偏好为
$u(r)=E(r)-A\sigma^2(r),A>0$，A衡量风险厌恶程度；

假设存在另外一个资产组合$r_p=(M,r_i);(1-w,w)$
计算$u(r_p)=E(r_p)-A\sigma^2(r_p)$
证明对于任意资产$r_i$，都存在$u(r_p)\le u(r_M)$

但是此时这个效用函数还解释不了，为什么凭空出来了这么一个玩意。

(2)均衡的时候，人们都持有市场组合M。这就意味着该风险市场组合提供了市场中最好的收益和方差的组合，你找不到比它更好的了。
收益和风险的配比由夏普比来刻画：Sharp Ratio
承担每单位风险所获得收益率的效率。

$$SR_i=\frac{\bar{r_i}-r_f}{\sigma_i}$$

即，市场组合提供了最高的夏普比。

假设存在一个风险资产$i$，它与市场组合M的再组合出的portfolio，不可能超过市场组合所提供的夏普比。

而市场组合的夏普比就是资本市场线$CML$的斜率：$k=\frac{\bar {r_M}-r_f}{\sigma_M}$

上面这句话也可以表达为，假设存在一个风险资产$i$，它与市场组合M的再组合出的portfolio的曲线，不可能超过资本市场线$CML$。

但是风险资产和市场组合$M$再组合出的曲线与$M$相交，那就意味着这根曲线与$CML$曲线相切与$M$点。

$Prove:$
$CML:E(r)=r_f+\frac{E(r_M)-r_f}{\sigma_M}\sigma$
假设一个风险资产$\tilde{r_i}$，与市场组合$\tilde{M}$再次组合成为风险资产组合$\tilde{r_p}$
$\tilde{r_p}=w\tilde{r_i}+(1-w)\tilde{r_M}$

$$E(\tilde{r_p})=wE(\tilde{r_i})+(1-w)E(\tilde {r_M})\\=w(E(\tilde{r_i})-E(\tilde{r_M}))+E(\tilde{r_M})$$

$$\sigma^2(r_p)=D(w\tilde{r_i}+(1-w)\tilde{r_M})\\=w^2\sigma^2_{r_i}+(1-w)^2\sigma^2_{r_M}+2w(1-w)\sigma_{iM}\\=w^2(\sigma^2_i+\sigma^2_M)+2w(\sigma_{im}-\sigma^2_M)+\sigma^2_M$$

计算黄线的斜率，即求解参数方程在$w=0$时的斜率:
$$\frac{dE(r_p)}{d\sigma_{r_p}}=\frac{\sigma_M[E(r_i)-E(r_m)]}{\sigma_{iM}-\sigma^2_M}$$
上述斜率等于资本市场线的斜率，即

$$\frac{\sigma_M[E(r_i)-E(r_m)]}{\sigma_{iM}-\sigma^2_M}=\frac{E(r_M)-r_f}{\sigma_M}$$

化简后得到，资产定价式：
$$E(r_i)-r_f=\beta_i[E(r_M)-r_f]，\beta_i=\frac{\sigma_{iM}}{\sigma^2_M}\\CAPM核心方程$$

找市场组合$M$的方法：在给定风险资产的前提下，求解风险资产所能构成的最高夏普比的资产组合，即为市场组合$M$。

CAPM方程在**以$\beta$为横轴，$E(r_i)$为纵轴的平面**内表示为一条过$(0,r_f)$的一条直线。
$SML$证券市场线：$E(r_i)-r_f=\beta_i[E(r_M)-r_f]，\beta_i=\frac{\sigma_{iM}}{\sigma^2_M}$
市场组合$M$的$\beta$为1，期望为$E(r_M)$

证券市场线和资本市场线的区别:

证券市场线SML：$E(r_i)-r_f=\beta_i[E(r_M)-r_f]，\beta_i=\frac{\sigma_{iM}}{\sigma^2_M}$

资本市场线CML：$\bar r-r_f=\frac{\sigma}{\sigma_M}(\bar {r_M}-r_f)$
$$Expected\ rate\  of\ return=Time\ value\ of\ money +risk\ premium\\risk\ premium =measurement\ of\ risk *price\ of\ risk$$
SML和CML在描述风险价格上是一样的，均是市场组合的超额收益$E(r_M)-r_f$，但是在对于风险的度量上存在差异，一个是$\beta$一个是$\frac{\sigma}{\sigma_M}$。

SML中，对风险的衡量用$\beta$表示，即体现在期望回报率中，作为期望回报率补偿的风险不是$\sigma$，而是$\beta$。

均衡分析中，所有的经济变量都是同时决定的。没有因果，或者说互为因果，不存在单向的因果关系。价格决定人的行为，人的行为决定价格，相互影响，达成均衡的结果。

资本市场线CML是衡量持有无风险资产和市场组合的情况下，投资组合可以取到的所有期望收益。
即，资本市场线CML仅仅对那些能取到最高夏普比的资产成立(也就是同市场组合有相同夏普比的资产)。也就是说CML反映的是那一根线上的可能的投资组合的期望收益率。

SML反映的是所有(风险资产、无风险资产、CML线上的资产也成立)资产的期望收益率，并不要求该资产是否由无风险资产和市场组合M构成。 


##第七讲 CAPM的讨论
CAPM(SML)：$E(r_i)-r_f=\beta_i[E(r_M)-r_f]，\beta_i=\frac{\sigma_{iM}}{\sigma^2_M}$
$Risk\ Premium = measure\ of\ risk\ *price\ of\ risk$

在均值方差模型中，假定刻画收益和风险的指标是期望收益率和方差，但是，我们在推导出CAPM之后，得到的SML中，用来度量风险的指标是$\beta$，为什么会出现这样的转变？ 

通过$diversification$，消灭掉一部分风险，使得投资者承担的风险减少。市场只会对那些无法消除的风险予以补偿。

分散化投资的极致是什么？应该是$Entire\ Market$，也就是市场组合M。也就是说市场组合的波动才是投资证需要承担的风险，不在市场组合波动范围内的风险，市场不予补偿。

对于任意资产$i$，其风险$\sigma_i$可以分为两个部分，其中一个部分是$correlated\ to\ \sigma_M$和$uncorrelated\ to\ \sigma_M$，前者无法通过分散化消除，后者可以通过分散化将其消除掉。
无法通过分散化投资消除的风险称之为系统性风险。系统风险决定资产定价。可分散化地风险被称为个体风险。

三个问题：
2.是否存在$\beta<0$的资产？
这个问题换句话说就是：是否存在一种资产的波动率$\sigma_{iM}<0$，即资产的收益与整个市场组合M(宏观经济)变动相反?
存在。比如保险，尤其是失业保险。失业状况和宏观经济密切相关，在经济景气的时候，参保人缴纳保费。当经济萧条的时候，参保人失业，失业保险补偿参保人一定的金额。正好和宏观经济变动方向相反。

3.对于两种资产$i$和$j$，如果其期望收益率$E(r_i)$和$E(r_j)$相同，且$\sigma_i<\sigma_j$，投资人是否总是会选择资产$i$而非资产$j$。

$Estimation \ of\ CAPM：$
$\tilde{r_i}=r_i-r_f$
$\tilde{r_M}=r_M-r_f$
SML：$E(\tilde{r_i})=\beta_iE(\tilde{r_M})$
根据计量经济学的计量方程：
$\tilde{r_i}=\alpha_i+\beta_i\tilde{r_M}+\tilde{\varepsilon _i}$
利用$OLS$(最小二乘法)对$\beta$进行回归；得到$\hat{\beta_i}=\frac{\sigma_{iM}}{\sigma^2_M}$

$Var(\tilde{r_M})=Var(\alpha_i+\beta_i\tilde{r_M}+\tilde{\varepsilon _i})\\=\beta^2_iVar(\tilde{r_M})+Var(\tilde{\varepsilon _i})+2\beta_icov(\tilde{r_M},\tilde{\varepsilon _i})\\=\beta^2_iVar(\tilde{r_M})+Var(\tilde{\varepsilon _i})(OLS要求协方差为零)\\=\beta^2_i\sigma^2_M+\sigma^2_\varepsilon$

CAPM的用法：
(1)公司股票定价中贴现率的确定；
(2)均值方差模型中估计任意$i$个资产的收益率以及方差和协方差，共计估计$N+\frac{N(N+1)}{2}$个参数。

$\sum=\begin{bmatrix}
  \sigma^2_1\ \sigma_{12}\ ... \sigma_{1N}\\
  \sigma_{21}\ \sigma^2_2\ ... \sigma_{1N} \\
  . . . . .\\
  \sigma_{N1}\ \sigma_{12}\ ... \sigma^2_N\
\end{bmatrix}$

而对于任意两个资产$i,j$的协方差可以表示为：
$\sigma_{ij}=cov(\tilde{r_i},\tilde{r_j})\\=cov(\alpha_i+\beta_i\tilde{r_M}+\tilde{\varepsilon _i},\alpha_j+\beta_j\tilde{r_M}+\tilde{\varepsilon _j})\\=\beta_i\beta_jcov(\tilde{r_M},\tilde{r_M})\\=\beta_i\beta_j\sigma^2_M$

此时方差和协方差矩阵可以表示为：
$\sum=\sigma^2_M\begin{bmatrix}
  \beta_1\beta_1 \ \beta_1\beta_2\ ...\ \beta_1\beta_N\\
   \beta_2\beta_1 \ \beta_2\beta_2\ ...\ \beta_2\beta_N\\
  . . . . .\\
    \beta_N\beta_1 \ \beta_N\beta_2\ ...\ \beta_N\beta_N\\
\end{bmatrix}$

估计参数的数量变为$N+N+1$

(3)$Investment\ Performance\ Evaluation$
夏普比：$SR_i=\frac{\bar r_i-r_f}{\sigma_i}$
$only\ apply\ to\ fully\ diversified\ funds$

$Jensen's \ Alpha$(詹森阿尔法)：(不追求分散化投资的基金衡量指标)风险资产距离证券市场线的垂直距离。

找到一个$Alpha$为正的基金，你就可以将其与市场组合M重新组合，达到一个比市场组合还要高的夏普比，即打败市场组合。

但是真实的市场并不是一直保持均衡，如果存在一个基金的$Alpha$为正，即意味着之前的市场并不是完全均衡的。市场组合会将该组合纳入市场体系中，此时$Alpha$又变成了零。因此，寻找$Alpha$并非是一蹴而就的，而是一个不断地反复的过程。

(4)$Alpha-Beta\ Separation$
假设存在规模为1个亿的基金：
$r_\alpha=r_f+0.03+1.5(r_M-r_f)+\varepsilon$
该基金的Alpha为0.03
假设存在规模为1亿的组合$r_H$
$r_H=-0.5r_f+r_M=r_f+1.5(r_M-r_f)$
(基本思想是以无风险利率借5千万资金，以1亿5千万购买风险资产，实现$r_H$的收益率)
将$r_\alpha$和$r_H$组成为$\bar r_p$，实现无风险的0.03收益率。

$Limitation\ of\ CAPM$

(1)Partial Equilibrium 部分均衡
只研究资产市场这一个市场的均衡，很多东西都是假设外生给定，更加深层次的问题无法回答。要转化为一般均衡才能讨论。$\longrightarrow$ C-CAPM
(2)Static Model 静态模型，只有一期，不会涉及到资产的动态变化问题。$\longrightarrow$ I-CAPM
(3)Single Index Model 单因素模型。现实数据的解释能力不强。$\longrightarrow$ Multi-factor APT


##第八讲 期望效用理论
CAPM
Preference  M-V
Decision  Portfolio Optimization
Equilibrium  Partial (Asset Market)
Asset Pricing  CAPM(SML)


Preference: (微观经济学) 
(1)Rational:
Complete $\longrightarrow$ $\forall x,y\in X，x\succeq y \ or\  y\succeq x$
Transitivity $\longrightarrow$ $x\succeq y,y\succeq z\rightarrow x\succeq z  $
(2)Continuous $\longrightarrow$ $x^n\succeq y^n，\lim_{n \to \infty}x^n  \succeq \lim_{n \to \infty}y^n $
$\longrightarrow$ 可以找到一个 $u(\cdot )$
$ s.t. \\ x\succeq y \Leftrightarrow u(x)\ge u(y)$

但是均值-方差分析并不满足上述微观经济学中的偏好假定，至少在完备性上并不满足。

但是上节课在给CAPM证明时，提出过这么一个效用函数$U(r)=E(r)-A\sigma^2(r)$，但是，它的提出并没有一定的根据，至少在现在为止还是十分可疑的。

同时在均值-方差分析之中还丢掉了许多信息，比如对于随机变量$\tilde{x}$来说，其$n$阶矩的表达式为$E(\tilde{x}-c)^n$。随机变量的所有信息既可以通过密度函数进行表示，同样也可以通过$n$阶矩来表示，二者是相互等价的。但是均值-方差模型仅仅反映了一阶矩和二阶矩的情况。此时，丢掉了三阶矩和四阶矩的信息，造成信息的浪费。


C-CAPM
Preference  Expected Utility
Decision  Decision  under uncertainty
Equilibrium  General (whole economy)
Asset Pricing  C-CAPM

Expected Utility Theory(期望效用函数理论)
圣彼得堡悖论引发的启示，人们在不确定性下的决定并不是根据期望回报(Expected Payoff)所决定的，而是由期望效用(Expected Utility)所决定的。

冯诺依曼-摩根斯坦的工作就是证明：在不确定情况下，人们的选择可以使用**期望效用函数**来衡量。进而建立起期望效用理论这个框架。

Step 1：$Modelling\ choice\ set\ under\ uncertainty$
Step 2：$Modelling\ Preference\ under\ uncertainty$
Step 3：$Finding \ Expected\ Utility\ function$

第一步：在不确定性条件下进行建模，找到在不确定性条件下我们究竟在比较什么?

类比：
在确定性条件下，我们在一个选择集中对不同的消费束进行比较，确定消费者更偏好于哪个消费束。
比如存在如下消费束$A(2,1)$和$B(1,2)$分别代表：1、消费两个苹果和一个梨；2、消费一个苹果和两个梨。
在确定性条件下我们比较的是这两个消费束。且$A,B\in X$，即属于我们的选择集之中。

反推：
在不确定条件下，我们的选择集里东西是我们拿到各种消费束的概率。
$Def:Simple\ Lottery$(简单彩票)
$L=(p_1,p_2,...,p_N)，p_n\ge 0，\sum^N_{n=1} p_n=1$

Example:
对于两个消费束：$A(2,1)$和$B(1,2)$
存在简单彩票
$L_1(0.5,0.5)$表示$A$出现的概率为0.5和$B$出现的概率为0.5。
$L_2(0.25,0.75)$表示$A$出现的概率为0.25和$B$出现的概率为0.75。
刻画不确定性就是使用lottery来刻画。

$Def:Compound\ Lottery$(复合彩票)

Example:
$Compound\ lottery$
$(L_1,L_2;0.5,0.5)$表示存在0.5的概率拿到$L_1$这张彩票，存在0.5的概率拿到$L_2$这张彩票。而对$L_1$来说，存在0.5的概率拿到消费束$A$，存在0.5的概率拿到消费束$B$。反之，对于$L_2$也作此分析。得到复合彩票可以等价于一个简单彩票。$(L_1,L_2;0.5,0.5)=L_3(0.375,0.625)$。

综上，我们研究的不确定情况下的选择就在一个$L$中，即彩票空间，$Space\ of\ simple\ lottery$。

$Preference$ 满足
$Complete+Transitivity+Continuous\rightarrow u(\cdot)$，存在效用函数来刻画偏好，不过效用函数的形式是未知的。
如果想要得到期望效用函数——期望效用函数等于用确定条件下的效用函数以发生概率为权重的加权平均。
需要额外添加一条公理：独立性公理

$Def：Independence\ Axiom:$
$A,B,C\in L,\forall \ \alpha \in (0,1)\\ A\succeq B \Longleftrightarrow \alpha A+(1-\alpha)C \succeq \alpha B+(1-\alpha)C$。

但是独立性公理要求条件还是比较强的，假设$A、B、C$代表牛肉、苦瓜和猪肉，虽然牛肉偏好于苦瓜，但是不代表添加了猪肉之后，牛肉+猪肉依旧偏好于苦瓜+猪肉。

独立性公理的目的就是推导期望效用定理：
期望效用定理：
若选择集属于彩票空间，且$Complete+Transitivity+Continuous+Independence\ Axiom$，则对于任意一个彩票$L$，其效用可以写为$U(L)=\sum^N_{n=1}p_n \cdot u(x_n)$。
其中，$u(x_n)$是在第$n$种状态下，拿到的消费束$x_n$的效用。整个彩票的效用是：确定性状态下各种情况的效用值乘以发生的概率后进行加总。

之所以提出独立性定理，是为了搞出来上述的效用函数形式。搞出这个效用函数形式之后，对于不确定状况下的分析就会简便。

确定性效用函数已知，从确定向不确定的转变就是将确定性的效用乘以一个概率后求和便完事了。

$Measurement\ of\ Risk\ Aversion$
运用上述的期望效用理论来刻画人们的风险厌恶水平，如何用具体的指标明确的刻画这个东西。

假设在以消费$C$为横轴和以效用值$U$为纵轴的平面内，描述两条效用函数曲线。其中效用函数$u$和效用函数$v$的曲线表示在同一平面，且曲线$u$较曲线$v$来说较为平坦，不妨设两个效用函数相切于一点$A$，此时对应的消费数量为$C$。

这时，在该体系中增加不确定性。假设消费者有0.5的概率以$C+\Delta$数量进行消费，同时也有0.5的概率以$C-\Delta$数量进行消费。这时对消费者来说，在不确定性的情况下其期望效用为$E(u(C\pm\Delta))=0.5U(C+\Delta)+0.5U(C-\Delta)$，即两个确定情况下的加权平均。

在引入不确定性之后，虽然消费者的期望消费还是$C$。但是效用水平从$U(c)$下降到$E(u(C\pm\Delta))$，下降的原因是因为效用函数曲线是弯的，(如果效用函数曲线是直线就不会存在这种问题了)，即消费者是风险厌恶的，不确定性的添加减少了消费者的效用水平。

而效用曲线的弯曲程度决定了消费者的风险厌恶情况，而效用曲线的弯曲程度是因为消费者的边际效用递减速度所决定的。

**考虑图中的两条不同的效用函数曲线可以得出，对于效用函数弯曲程度大的效用来说，添加同样的不确定性之后，弯曲程度大的效用函数效用水平$E(v(C+\Delta))$下降程度越大。**

究其原因是因为$C+\Delta$的消费对效用水平的提升不足以弥补$C-\Delta$对效用水平的拉低。


Certainty Equivalence 确定性等值
在去除不确定情况下，让消费者达到效用水平为$E(u(C\pm\Delta))$时的，确定的消费数量$CE_u$。显然，$CE_u$和$C$之间存在一定的差距，这一差距$\left | C-CE_u\right |$就是消费者为了消除不确定性所愿意牺牲的消费数量，称之为风险溢价$Risk\ Premium$。
根据$\left |C-CE_u\right |$和$\left |C-CE_v\right |$的大小关系可得，风险厌恶程度高的消费者为了规避不确定性愿意支付更高的风险溢价。

总结就是：边际效用下降得越快，效用函数就越弯曲，风险溢价就越大，消费者就越风险厌恶。

但是上述的风险溢价不太好用，它既受到效用函数弯曲程度的影响，也受到$\Delta$的影响，同时也受到$C$的影响。希望找到一个指标来单独衡量效用函数的弯曲程度。

$Coefficient\ of\ Absolute\ Risk\ Aversion$ 
绝对风险规避系数(ARA)
假设给你一个确定的效用$U(y)$，同时也存在一个赌局，以$\pi$的概率拿到$U(y+h)$，以$1-\pi$的概率拿到$U(y-h)$。
假设$\exist \ \pi^*$使得消费者参与这个赌局无差异，则成立下述等式：
$U(y)=\pi^* \cdot U(y+h)+(1-\pi^*) \cdot U(y-h)$
当一个人的风险厌恶程度很高的情况下，只有当$\pi^*$的值很大的情况下，他才会觉得这两者无差异。此时$\pi^*$就是消费者风险刻画的一个指标。

$Taylor\ Expansion$
$$u(y)=\pi^*[u(y)+hu'(y)+\frac{1}{2}h^2u''(y)]+(1-\pi^*)[u(y)-hu'(y)+\frac{1}{2}h^2u''(y)]\\0=(2\pi^*-1)hu'(y)+\frac{1}{2}h^2u''(y)\\\pi^*=\frac{1}{2}+\frac{h}{4}[-\frac{u''(y)}{u'(y)}]$$
$R_A(y)=-\frac{u''(y)}{u'(y)}  \ (ARA)$  绝对风险厌恶系数
ARA和消费者的收入水平存在很大的关系。

相对风险规避系数
修改一下赌局的规则，赢钱的数量不再是一个给定的数值，而是收入的份额$\theta$。
$$U(y)=\pi^* \cdot U(y+\theta y)+(1-\pi^*) \cdot U(y-\theta y)\\\pi^*=\frac{1}{2}+\frac{\theta}{4}[-\frac{yu''(y)}{u'(y)}]$$
$R_R(y)=-\frac{yu''(y)}{u'(y)}  \ (RRA)$  相对风险厌恶系数

对于上述两个风险规避系数来说：
$R_A(y)=-\frac{u''(y)}{u'(y)}  \ (ARA)$  绝对风险厌恶系数
$R_R(y)=-\frac{yu''(y)}{u'(y)}  \ (RRA)$  相对风险厌恶系数
二阶导才是重要的，因为二阶导描述了边际效用变化的快慢程度。同时，一阶导永远是正数，而二阶导却是负数，在前面添加一个负号来讨论其绝对值，风险系数越大，效用函数曲率越大，效用函数弯曲程度越弯。

探讨几个效用函数：
$CARA：U(c)=-e^{-\alpha c}，R_A(y)=\alpha$。
$CRRA：U(c)=\frac{c^{1-\gamma}-1}{1-\gamma}，R_R(y)=\gamma$；当$\gamma=1$时，$U(c)=ln(c)$。
$Linear \ U(c)=\alpha c$，风险规避系数为零，不惧怕风险，风险中性。

对于二次型的效用函数和$CARA+log-normal\ return$都可以推出该效用函数$U(r)=E(r)-A\sigma^2(r)$，因此给出这个效用函数不过是期望要用函数的一个特例而已。

##第九讲
在不确定性偏好理论研究在不确定性条件下人的行为。
对于金融分析来说，不确定性为有两个，一个是资产投资行为(组合优化问题)(Portfolio Optimization)，另一个是消费-储蓄问题(Consumption-Saving)。
储蓄是对资产的需求。
储蓄是将现在的资源留到未来，转移资源的方式就是购买资产，资产是一种对未来经济利益的索取权，通过买卖资产就完成了资源在不同时点之间的转移。研究对资产的需求的时候，我们就要研究人愿意做多少储蓄。储蓄决定了我们对资产的需求，自然决定资产的价格。

今天的研究只限于在风险资产 $\tilde{r}$ 和无风险资产$r_f$之间：
假设人们是风险厌恶的，即$u''(\cdot)<0$
(1)人在什么情况下会购买风险资产？
假设一个人非常厌恶风险，只依靠其养老金生活，承受不了风险资产变动的造成的损失。是否风险资产的期望收益$E(\tilde{r})-\Delta=r_f，\Delta>0$，才会吸引投资者购买风险资产。

假设存在两种资产$(\tilde{r},r_f)$，投资者的总财富水平为$w_0$，其中投在风险资产上的财富为$a$，$w_0-a$的资产投放在无风险资产上。
以下来求解$a$的数值：
$\underset{a}{max}\ E[u(\tilde{w})]=\underset{a}{max}\ E\{u[w_0(1+r_f)+a(\tilde{r}-r_f)]\}\\=\underset{a}{max}\ \sum^N_{n=1}p_n \cdot u[w_0(1+r_f)+a(r_n-r_f)]$
求导：
$F.O.C： \\ E\{u'[w_0(1+r_f)+a(\tilde{r}-r_f)](\tilde{r}-r_f)\}=0 $

定理9.1：
在风险厌恶的条件下，即$u''(\cdot)<0$。
(1) $a^*>0 \Longleftrightarrow E(\tilde{r})>r_f$.
(2) $a^*=0 \Longleftrightarrow E(\tilde{r})=r_f$.
(3) $a^*<0 \Longleftrightarrow E(\tilde{r})<r_f$.

证明第(1)个定理：
Define $V(a)=E\{u[w_0(1+r_f)+a(\tilde{r}-r_f)]\}$

此时画出时期为0和时期为1的数轴，此时$a$的值在0期就被确定下来了。最后，$\tilde{r}$的确定只有在期末的时候才能知道它变成了那个$r_n$。在0时点时，只有根据$Eu(\cdot)$来做决策。

$F.O.C\\ V'(a^*)=0\\ V''(a)=E[u''\{ [w_0(1+r_f)+a(\tilde{r}-r_f)](\tilde{r}-r_f)^2\}]<0$
$V'(a)$为减函数，且要求$a^*>0$，则可以推出$V'(0)>0$。
$V'(0)=E\{u'[w_0(1+r_f)](\tilde{r}-r_f)\}>0\\=u'[w_0(1+r_f)]E(\tilde{r}-r_f)>0 \\ \rightarrow E(\tilde{r})>r_f$

解释：只要风险资产的期望收益率略微搞出无风险资产一点点，投资者就因该购买一些风险资产。
阿罗——普拉提近似：(idea)
对于持有无风险资产的人来说，增加持有一些风险资产会对其效用带来两方面的影响，第一个是会使得其期望效用上升，因为风险资产的期望回报率大于无风险利。这一影响会与$a$呈正比。另一方面，期望效用会下降，是因为承担的风险会上升，其影响与$a^2$呈正比。上述均是在$a$很小的时候成立。
只要风险资产的期望回报率高于无风险资产，所有人都会购买风险资产，不管这个人的风险厌恶程度有多么的高。因此，只要我们假设风险资产的期望收益是大于无风险利率的，可以假设所有人都会持有风险资产，不存在有人不持有风险资产的角点解之类的情况。


定理9.2
$E(\tilde{r})>r_f，u''(\cdot)<0$
(1) ${a^*}'(w_0)>0 \Longleftrightarrow R'_A(\cdot)<0$    (DARA)
DARA：绝对风险规避系数递减
$R_A(y)$是$y$的函数。也就是说，随着财富的增加，绝对风险规避系数是下降的。即，随着财富的增加，越不畏惧风险，所以应该把更多的财富投入到风险资产上。也就契合了${a^*}(w_0)$是$w_0$的函数，且随着$w_0$的增加，$a^*$也随之增加，即${a^*}'(w_0)>0$。

从常识上很容易理解，但是给出具体证明还是比较繁琐的，讲义和补充材料会给出具体的证明。

在证明之中存在一个技巧：
对于$E[u''(\tilde{w})(\tilde{r}-r_f)]$，要求判断其正负号。
将上述期望拆成其定义：
$\sum_{n=1}^Np_n()$一项一项去讨论其正负号，最后讨论其最终的正负号。

定义9.3
Def：定义一个弹性：
$$e(w_0)=\frac{\mathrm{d} a^*}{a}/\frac{\mathrm{d} w_0}{w_0}$$
表示我初始财富$w_0$增加1%，则投在风险资产上的数量增加百分之几？

定理9.3
$E(\tilde{r})>0，u''(\cdot)<0$
(1) $e(w_0)>1\Longleftrightarrow R'_R(\cdot)<0$。($DRRA$)
(2) $e(w_0)=1\Longleftrightarrow R'_R(\cdot)=0$。($CRRA$)
(3) $e(w_0)<1\Longleftrightarrow R'_R(\cdot)>0$。($IRRA$)

在财富越多的时候，相对风险规避系数越小。相对风险规避系数对财富的导数是小于零的，是一个减函数。财富越多，相对风险规避系数越小，我越不在乎与我财富呈等比例的风险，我就越应该在风险资产上**投资的比例**就越大。

$e(w_0)>1$表示，总财富增加1%，我投资在风险资产上的财富增加超过百分之1。投资在风险资产上财富增长的速率比总财富增长的速率要快。所以，财富越大，投资在风险资产上的比例就越大。

随着经济的增长，人的财富和全社会的财富会不断增加，如果大家都是$DRRA$，那么在现实世界中，在风险资产上投资的比例会不断地增加，风险资产占总资产的比重在不断增加。

反之，若大家都是$IRRA$，风险资产占总资产的比重在不断减少。但是，现实生活中，风险资产占总资产的比重保持相对稳定，只能说，人们均是$CRRA$，因此在经济分析中$CRRA$的效用函数用的是最多的，因为它可以最好的与现实相吻合。

$CRRA$的效用函数可以写为：$u(c)=\frac{c^{1-\gamma}-1}{1-\gamma}$。
当$\gamma=1$时，由洛必达法则可以推出$CRRA$效用就是对数效用函数。

$Special\ Case：$
$Risk\ neutral$ 风险中性： $u(c)=\alpha c$
对于一个风险中性的人来说，若$E(\tilde{r})>r_f$，则$a\rightarrow +\infty$。
上述特例说明：对于风险中性的人来说，他持有所有的风险资产，以无风险利率来借款。

Saving 储蓄：
储蓄将现在的资源转移到未来。之所以会牺牲现在的消费进行储蓄，是因为在未来可以获得更多的消费。
所以储蓄一定存在一个回报。
假设在确定性情况下：($without\ uncertainty$)
给定初始财富$w$，讨论两期模型，$w=(w-s)(消费)+s(储蓄)$。储蓄获得的总回报率是$R=(1+r)$，当$R$上升时，问题是储蓄$s$是上升还是下降。

$\underset{s}{max} \ u(w-s)+\delta u(sR)$
$F.O.C：\\-u'(w-s)+\delta u'(sR)R=0\\ \delta u'(sR)R=u'(w-s)$

现在我们想知道$\frac{ds}{dR}$到底是正的还是负的?
将上述一阶条件对$R$求导可得，注意其中$s$是$R$的函数$s(R)$：
$\delta [Ru''(sR)(s+\frac{ds}{dR})+u'(sR)]=-u''(w-s)\frac{ds}{dR}$.
$$\frac{ds}{dR}=\frac{\delta u'(sR)+\delta s R u''(sR)}{-u''(w-s)-\delta R u''(sR)}$$
分母大于零，导数大于零还是小于零取决于上面的分子。
分子可以写为：
$\delta u'(sR)+\delta s R u''(sR)\\=\delta u'(sR)[1+\frac{sRu''(sR)}{u'(sR)}]\\=\delta u'(sR)[1-R_R(sR)]$ 

$\frac{ds}{dR}>0 \Longleftrightarrow R_R(sR)<1$替代效应占优
$\frac{ds}{dR}<0 \Longleftrightarrow R_R(sR)>1$收入效应占优

假设给定消费者的预算约束，在根据消费者的偏好情况划分为替代效应和收入效应进行讨论。 

经济学直觉：这套东西是期望效用理论给我们带来的一个副产品。

- $Inter-temporary$ (跨期状态下最大化效用)
$max \ u(w_1)+\delta u(w_2)\\ s.t. \ w_1+w_2=w$
$F.O.C： \ u'(w_1)=\delta u'(w_2)$

- $Maximization\ under\ uncertainty$(不确定状况下最大化效用)
$max p_1u(w_1)+p_2u(w_2)\\ s.t. \ w_1+w_2=w$
$F.O.C： \ p_1u'(w_1)=p_2 u'(w_2)$

这两个一阶条件的形式是类似的，都是在两个不同的时间和状态下取得一种边际效用的平衡，进而取得效用最大化。只不过一个是贴现效用和，一个是期望效用。
之所以形式一样是因为：在不确定情况下优化的是期望效用这个具体的不确定的形式，期望效用是不同状态下效用值的平均；而跨期效用是不同时间下的效用的加权平均，所以形式是一样的，所以经济含义也类似。
在讨论跨其效用时，我什么时候达到最优的状态呢?
是我两期(现在和未来)的边际效用取得了一种平衡，如果不是这样，可以将消费重新分配来增加我的贴现效用和。
consumption smoothing 消费平滑的效应在起作用

同样在不确定情况下，也要在不同的状态下实现消费的平滑，才能达到最优状态。

而消费平滑的力量，可由**相对风险规避系数**来刻画。为什么？因为相对风险规避系数刻画了我的边际效用下降的速度。如果我边际效用下降的越快，那么不平滑的消费带来的效用损失不论在跨期状态还是不确定状态都会变大。这种情况下，如果风险厌恶程度很高，我就会非常希望平滑我的消费。

绕了一圈回到上面的结论：
$\frac{ds}{dR}>0 \Longleftrightarrow R_R(sR)<1$替代效应占优
$\frac{ds}{dR}<0 \Longleftrightarrow R_R(sR)>1$收入效应占优
假设风险厌恶程度很高，即$R_R(sR)>1$时：
未来的消费会因为储蓄率的上升而上升，我就会有很强的动力去平滑它。把未来更多的消费转移到现在来。此时，收入效应会起到很强的作用，消费平滑的动力就很强，更高的回报率会降低储蓄。

反之风险厌恶程度很小，即$R_R(sR)<1$时：
消费平滑的动力没有那么强，这是替代效应会占据主导。此时，更高的回报率会带来更高的储蓄。
无论是跨期还是跨状态，都是消费平滑的力量在起作用。而消费平滑的力量由相对风险规避系数来刻画。

但是，不同时期下的消费平滑和不同状态之间的消费平滑真的是基于同样的思维吗？其实是未必的。但是其相似的数学表达使得**相对风险规避系数**这一个指标同时控制不同的经济力量，一种是跨时期的消费平滑力量，一种是不同状态下的消费平滑力量。
同一个变量控制两个不同的经济变量，应该要坏事。(为后面的问题埋下伏笔)。 $Equity\ Premium\ Puzzle $ 风险溢价之谜

在回到储蓄的问题：
储蓄存在的两种效应，一个是替代效应一个是收入效应，两个效应谁会起主导取决于哪个效应的消费平滑力量更强。
讨论完确定情况下的消费问题，现在可以讨论不确定状况下的消费问题。

$Saving\ under\ Uncertainty$
依旧讨论储蓄的决定问题，但是第二期存在不确定性：
$\underset{s}{max}\  u(w-s)+\delta E[u(sR)]$
此时，并不讨论储蓄回报率对储蓄地影响，而是储蓄回报率存在的不确定性，即风险对储蓄造成的影响。
风险度由一阶随机占优决定。
$F.O.C：\ u'(w-s)=\delta E[Ru'(sR)]$.
假设$R$的风险度越高，即将$R$做一个保均展形，均值不变，把密度函数压扁，即偏离均值的可能性变得更大了。保均展形对于原来的参数就更具有风险。
那么储蓄$s$会因为$R$风险的增加而发生怎样的变化？
$u'(w-s)=\delta E[Ru'(sR)]$.
对于等式的左边：($u''(\cdot)<0 \ \&$ 存在一个负号)
$\frac{d LHS}{d s}>0$
对于等式的右边：
如果我们能推出随着$R$的风险扩大的同时，等号右边是上升的，则可以推出$s$是上升的。
所以现在关心的问题是，随着$R$的风险扩大，等式右边的这一堆式子究竟是上升还是下降。
Def：$g(R)=Ru'(sR)$
$g(R) \ need\ to\ be\ a\ convex\ function$，$g''(\cdot)>0\ in\ order\ to\ have\ \sigma^2(R)\uparrow \rightarrow s \uparrow$
直接证明不好证，画图理解意思就好。
对于一个凸函数，横轴单位为$R$，纵轴单位为$E[g(R)]$为画图。
在$R\pm\Delta$和$R\pm2\Delta$处的$E[g(R)]$的位置上，显然$E[g(R\pm2\Delta)]$要明显大于$E[g(R\pm\Delta)]$，可以说增加不确定性确实增加了$E[g(R)]$的值。

得到上述结论后，对$g(R)$求其二阶导可得：
$g''(R)=2su''(sR)+s^2Ru'''(sR)\\=su''(sR)[2-P_R(sR)]：P_R(y)=-\frac{yu'''(y)}{u''(y)}$ (相对审慎系数 Prudence)
当相对审慎系数$P_R(sR)>2$时，$\rightarrow g''(R)>0\rightarrow \sigma^2(R)\uparrow\rightarrow s\uparrow$。

储蓄风险的上升，会使得未来的消费(未来的消费来自于储蓄)有更大的可能会倒霉，所以那些审慎的人会为倒霉的情况做好准备，增加储蓄。
同样，储蓄风险的上升会导致对未来的投资可能会变得无利可图，因为倒霉的概率可能会变大，这一想法会导致储蓄的数量会下降。

$CRRA$效用函数：
$u(c)=\frac{c^{1-\gamma}-1}{1-\gamma}$
$R_R(c)=\gamma，P_R(y)=\gamma+1$
当$\gamma=1$时，$CRRA$是对数效用函数$log(c)$，其$R_R(c)=1，P_R(c)=2$。此时$R_R(sR)=1$，替代效应和收入效应相互抵消。储蓄不会因为回报率高低的变化而变化。同样，当$P_R(sR)=2$时，意味着储蓄回报率风险的变化对储蓄没有影响。
因此，当我们假设对数效用函数时，储蓄率就会变成一个常数。因为，无论是回报率的高低还是回报率的风险均不会影响储蓄。

##第十讲 
对资产市场进行数理化的设定：
$Assumptions：$
(1)消费品$non-storable$(不存在消费品储藏)
(2)$endowment\ economy$ (禀赋经济) (所有的消费品都是外生给定的，即没有生产活动)
(3)储蓄行为通过买卖资产来完成。

时间分为两期现在称为0期，未来称为1期；(静态模型)
我们已知0期的状态，但是对1期的状态还是未知的。
假设1期的状态可能有$S$种可能性：共计存在$s$种$state$。且$s\in S$，其中$S$是全体$s$组成的一个集合，为有限集。同时，滥用一下符号，$S$还表示未来可能的数目。且对于每一种状态$s$发生的概率为$\pi_s$，且$0<\pi_s\le1，\sum^S_{s=1}p_s=1$。

此时，对于一个随机变量$\tilde{r}$，可以写成：$\tilde{r}=(r_1,r_2,r_3,...,r_S)^T$，该向量中对应的是这个随机变量在对应状态下的取值，所以$r_1$是世界处于$s_1$状态下时，$\tilde{r}$的取值。
世界有$S$种状态，所以随机变量有$S$种可能性，将$\tilde{r}$的$S$种可能性一一罗列出来。同时也知道每个状态的概率。所以就将这个随机变量描述出来了。

假设一个资产$Asset\ j$是一个随机变量，随机变量的不同状态就是该资产在不同状态下的$Payoff$。表示这个随机变量就是把它的支付向量表示出来就可以了，可以写成：
$X^j=\begin{bmatrix}
 x_1^j\\
 x_2^j\\
 \vdots \\
 x_S^j
\end{bmatrix}$
表示$x_j$这个资产在不同种情况下的支付。
假设$1\le j\le J$，即存在$J$种资产。可以把$J$种资产的支付向量均写出来，将所有资产都描述出来了。即资产市场也就被表示出来了。
$X=\begin{bmatrix}
  x_1^1 \ x_1^2 \ \dots \ x_1^J\\
  x_2^1 \ x_2^2 \ \dots \ x_2^J\\
   \vdots \ \\
  x_S^1 \ x_S^2 \ \dots \ x_S^J
\end{bmatrix}_{S \times J}$
该矩阵就是支付矩阵，就是整个资产市场的支付矩阵，描述资产市场就可以用这个支付矩阵。
支付矩阵中的数字都是在1期的，未来的支付。当然，在0期的时候，资产会存在一个价格$P=[p_1,p_2,..,p_J]at\ period\  0$。

$Asset Pricing：$资产定价问题：
给定一个1时刻的支付矩阵$X$，找出0时刻的价格$P$。

人在资产市场上做的是组合优化问题，即$Portfolio\ Optimization$。如何刻画$Portfolio$？
刻画Portfolio：
假设$\theta=(\theta_1,...,\theta_J)^T$是一个$J$维的列向量。该向量中的元素表示每一种资产持有的数量。
投资组合本身也是一个资产，对于资产组合的描述可以用资产的支付向量来描述。该资产组合的支付向量可以表示为：
$\begin{bmatrix}
 \theta_1\cdot x_1^1+\theta_2\cdot x_1^2+...+\theta_J\cdot x_1^J \\
 \theta_1\cdot x_2^1+\theta_2\cdot x_2^2+...+\theta_J\cdot x_2^J \\
 \vdots \\
  \theta_1\cdot x_S^1+\theta_2\cdot x_S^2+...+\theta_J\cdot x_S^J 
\end{bmatrix}\\=\begin{bmatrix}
\sum^J_{j=1}\theta_j\cdot x_1^j\\
\sum^J_{j=1}\theta_j\cdot x_2^j\\
 \vdots\\
\sum^J_{j=1}\theta_j\cdot x_S^j 
\end{bmatrix}\\=X\theta
$.
该列向量的每一行表示在不同状态下，该资产组合所获得的支付。比如第一行是在第一种情况发生的前提下，投资组合持有的资产的支付。
同样，该资产组合0时刻的**价值**可以表示为：
$\begin{bmatrix}
\sum^J_{j=1}\theta_j\cdot p_j\\
\sum^J_{j=1}\theta_j\cdot p_j\\
 \vdots\\
\sum^J_{j=1}\theta_j\cdot p_j 
\end{bmatrix}\\=P\ \theta
$.

之后引入一个概念：完备市场 $Complete\ market$。
完备市场：如果任何一个一期的消费计划都可以通过某个资产组合来实现，那么这个资产市场是完备的。
对于$\forall \ c=(c_1,c_2,...,c_S)^T$，前面是指各期的计划。能否构造一个资产组合，使得这个资产组合的支付恰好等于我想要的消费的计划？ (其中c可正可负)
即，对于$\forall \ c=(c_1,c_2,...,c_S)$，若 $\exist \ \theta=(\theta_1,...,\theta_J)^T，\\s.t. \ c_s=\sum^J_{j=1} \theta_jx_s^j，s=1,2...,S$，此时称这个市场是完备的。

Example：
(1)
支付矩阵：(行表示状态，列表示资产)
$
\begin{bmatrix}
1 \ 3 \\
2 \ 4 \\
\end{bmatrix}
$
上述支付矩阵存在两种资产，同时该世界存在两种状态。
在状态1时，第一种资产给的支付为1，第二种资产给的支付为3；
在状态2时，第一种资产给的支付为2，第二种资产给的支付为4；
按照定义，看看这个市场是否是完备的？
任意给定$c=(c_1,c_2)$，是否存在$\theta=(\theta_1,\theta_2)$?使得下式成立。  

$
\left\{\begin{matrix}
 c_1=\theta_1+3\theta_2 \\
 c_2=2\theta_1+4\theta_2
\end{matrix}\right.
$

$
\left\{\begin{matrix}
\theta_1=-2c_1+\frac{3}{2}c_2 \\
\theta_2=c_1-\frac{1}{2}c_2
\end{matrix}\right.
$
所以上述支付矩阵代表的市场是一个完备的市场。

(2)
支付矩阵：(行表示状态，列表示资产)
$
\begin{bmatrix}
1 \ 2 \\
2 \ 4 \\
\end{bmatrix}
$

$
\left\{\begin{matrix}
 c_1=\theta_1+2\theta_2 \\
 c_2=2\theta_1+4\theta_2
\end{matrix}\right.
$
上述方程组不一定有解，方程组必须行满秩，则上述的方程才有解。
则在上述市场中，并非任意一个消费计划都存在一个资产组合可将其实现，则这个市场是一个非完备的市场。

考虑上述的两个例子可知，一个是完备市场，一个是非完备市场。现在回过头想想完备市场究竟是什么意思?完备市场的定义是任何一个消费计划都可以通过一个资产组合加以实现。也就是说，在完备市场中，消费者可以在任意两个状态之间，通过构造资产组合来调配消费资源。
完备市场中，总可以通过资产组合的构造和买卖来实现任意状态之间资源的调配。在状态之间调配资源的能力是无限的，当然也要付出成本。消费者在完备市场中所面临的自由度是最大的。

完备市场被非完备市场处理起来都比较容易，事实上，完备市场几乎是一样的。正如，幸福的家庭都是一样的，不幸的家庭各有各的不幸。完备市场都以一样的(和阿罗-德布鲁市场等价)，非完备的市场各有各非完备的状态。

最简单的完备市场：
支付矩阵：
$X=\begin{bmatrix}
  x_1^1 \ x_1^2 \ \dots \ x_1^J\\
  x_2^1 \ x_2^2 \ \dots \ x_2^J\\
   \vdots \ \\
  x_S^1 \ x_S^2 \ \dots \ x_S^J
\end{bmatrix}_{S \times J}$
对于任意的消费计划
$C=(c_1,c_2,...,c_S)^T$，存在一个资产组合$\theta=(\theta_1,...,\theta_J)^T$，使得一个包含$S$个方程和$J$个的未知数的方程组存在解。上述方程组存在解，即行满秩。即系数矩阵，也就是支付矩阵的秩为$S$。
如果一个资产市场是完备的，一定可以找出状态数目$S$这么多的资产，这$S$个资产相互之间是线性无关的。


看一个特例：
假设：
$
\begin{bmatrix}
c_1=\theta_1 \\
c_2=\theta_2 \\
\vdots \ \\
c_S=\theta_S
\end{bmatrix}
$
该方程组肯定是有解的，其对应的资产市场是这样的一个市场：
第1种资产只在第1种状态下的支付为1，其余状态下的支付为零，第2种资产只在第2种状态下的支付为1，其余状态下的支付均为零；以此类推。
$
I=\begin{bmatrix}
1 \ 0\ ...\ 0 \\
0 \ 1 \ ...\ 0 \\
\vdots  \\
0\ 0 \ ...\ 1
\end{bmatrix}_{S\times S}
$
显然上述资产市场是完备的，而且找不到比它更简答的资产市场了，该资产市场称为阿罗德布鲁市场。$Arrow-Debreu \ Market$
这个市场中有$S$种资产，每个资产有一个特殊的名字，称之为阿罗证券。$Arrow\ Securities$。
由$S$个阿罗证券组成的市场就是一个最简单的完备市场，即阿罗——德布鲁市场。所有的完备市场都会等价于阿罗——德布鲁市场。上述表示了每个阿罗证券在1时期的支付，同样每个阿罗证券在0时期都会存在一个价格，将阿罗证券的价格叫做状态价格($State\ Price$)：$\varphi =[\varphi _1,\varphi _2,...,\varphi_S]$，资产定价定的就是阿罗证券的价格，也就是状态价格。给定了状态价格，任何一个资产的价格都可以被表示出来。比如说，给出资产$X^j=(x_1^j,x_2^j,...x_S^j)$，这一资产可以视为阿罗证券的组合，对第一种阿罗证券的持有数量$\theta_1=x_1^j$，以此类推。 
同样，该资产的价格也可以表示为：$p^j=\sum_{s=1}^Sx^j_s\varphi_s$。给出一个资产的支付，我就可以给出一个价格。当然，**其中的核心是状态价格向量$\varphi$。**

Example：
$
X=\begin{bmatrix}
3 \\
2 \\
1
\end{bmatrix}
$
$
I=\begin{bmatrix}
1 \ 0\ 0\\
0 \ 1\ 0\\
0 \ 0\ 1
\end{bmatrix}
$
则$X=3I_1+2I_2+I_3$，其中，$I_i$对应第一个阿罗证券，以此类推。且该资产的价格$P_X=3\varphi_1+2\varphi_2+\varphi_3$

下面看一个特殊的资产：无风险资产，其在各个状态下的支付都是1，无风险资产的价格记为$\rho=\varphi_1+\varphi_2+\varphi_3$
广泛的写的话可以写为：$\rho=\sum_{s=1}^S\varphi_s$
$
X=\begin{bmatrix}
1 \\
1 \\
1
\end{bmatrix}
$

接下来，如何通过均衡定价将$\varphi$计算出来。
一般均衡：所有人和谐的达到了自己的最优：
先求所有消费者最优化，然后再让市场出清，看市场达到均衡时候，所有人的行为是什么样的，然后这种行为产生的资产价格是什么样的。
消费者的优化问题：(两期问题)
消费者选择其资产组合(共存在$J$种资产)，目的是最大化贴现效用和
$$\underset{\theta_1,...\theta_J}{max} \ u(c_0)+\delta\sum_{s=1}^S\pi_s u(c_{1,s})\\s.t. \ c_0=e_0-\sum_{j=1}^Jp_j\theta_j\\c_s=e_s+\sum_{j=1}^J x_s^j\theta_j，s=1,2,...,S $$
其中，$c_0$是指0时刻的消费，这是一个确定的数。
$c_{1,1}...c_{1,s}$是1时刻的情况下，s状态下的消费。
$\sum_{s=1}^S\pi_s u(c_s)$是以不同状态下发生的概率为权重的效用的加权平均，当然也是期望效用$E(u(\tilde{c_1}))$。
考虑到这是未来的效用，人性是不耐的，加上一个贴现因子$\delta$，且$0\le \delta \le 1$。

补充一点：对于效用函数和贴现因子，我们可以假设每个人均有差异，各有各的不同。但是，我们必须假设他们之间有一个是相同的：即$\pi_s$相同，对未来各个状态发生概率的believe(信仰)、认知是一样的。但是为了分析简便，我们假设所有人的效用函数和贴现因子是一样的。

对于约束条件来说，$c_0$等于在0时期的禀赋$e_0$减去用于购买资产的费用，为$\sum_{j=1}^Jp_j\theta_j$。未来在$s$状态下的消费等于$s$期的禀赋$e_s$加上在0时刻购买的资产的支付为$\sum_{j=1}^J x_s^j\theta_j,s=1,2,...,S$。因为存在$S$种情况，所以约束条件共计存在$S+1$个等式。


但是这个优化问题直接处理并不是太方便，它是对应于$1...J$这些资产的一个完备市场。之前我们说过，所有的完备市场都等价于阿罗-德布鲁市场。将上述的优化问题放在阿罗-德布鲁市场中，改写为这样的优化问题。

$$\underset{\theta_1,...\theta_S}{max} \ u(c_0)+\delta\sum_{s=1}^S\pi_s u(c_{1,s})\\s.t. \ c_0=e_0-\sum_{s=1}^S\varphi_s\theta_s\\c_s=e_s+\theta_s，s=1,2,...,S $$
还可以写的更为简洁，将$\theta_s$表示为$c_s-e_s$，上述最优化问题可以写为：

$$\underset{\theta_1,...\theta_S}{max} \ u(c_0)+\delta\sum_{s=1}^S\pi_s u(c_{1,s})\\s.t. \ c_0=e_0-\sum_{s=1}^S\varphi_s(c_s-e_s) $$

求解这个最优化问题，构建拉格朗日函数可得:
$$L=u(c_0)+\delta\sum_{s=1}^S\pi_s u(c_{1,s})+\lambda_1[-c_0+e_0-\sum_{s=1}^S\varphi_s(c_s-e_s)]\\F.O.C： \ \frac{\partial L}{\partial c_0}=0； \frac{\partial L}{\partial c_{1,s}}=0\\u'(c_0)=\lambda_1；\delta \pi_su'(c_s)=\lambda_1\varphi_s$$
(第二个一阶条件中，存在共计$S$个状态，所以每一个都要求导)
$$\longrightarrow \ \frac{\pi_s u'(c_s)}{\pi_{s'}u'(c_{s'})}= \frac{\varphi_s}{\varphi_{s'}}$$
(注：上述等式中，$s$和$s'$是两个不同的状态)
上述等式告诉我们阿罗证券价格反映一个边际效用概念，当一个人达到效用最大化时，他的不同状态下的边际效用满足一个条件。即，边际效用乘上概率之后的比值等于不同状态下阿罗证券价格的比值。


Example：均衡算例：
假设存在这么一个市场，支付矩阵第一行表示a状态，第二行表示b状态。且$a,b$发生的概率均是$\pi_a=\frac{1}{2},\pi_b=\frac{1}{2}$。

$X=\begin{bmatrix}
1 \ \frac{1}{2} \\
1 \  2
\end{bmatrix}
$.

消费者1的效用函数为$u_1=log(c)$，消费者2的效用函数为$u_2=2\sqrt{c}$，上述两个效用函数都是$CRRA$的效用函数。且假设主观贴现率为1。 
消费者1的禀赋为0时刻的1单位消费品。消费者2的禀赋为1张股票，其在1时期a状态下带来0.5的支付，在b状态下带来2的支付。此时该股票在0时刻的价格用阿罗证券表示为$0.5\varphi_a+2\varphi_b$

求解均衡：
$General\ Equilibrium$

Step 1:
$Individual\ Optimization\ Problem$(将所有人的行为表示为价格的函数)

Step 2:
$Market\ Clear$(市场出清)

第一个人的优化问题：
$$max \ log(c_{1,0})+[\frac{1}{2}log(c_{1,a})+\frac{1}{2}log(c_{1,b})]\\ s.t. \ c_{1,0}+\varphi_a c_{1,a}+\varphi_b c_{1,b}=1$$
注：$c_{1,0}$第1个人在0期的消费，$c_{1,a}$第1个人在1期$a$状态下的消费
建立拉格朗日方程可得一阶条件：
$\frac{\partial L}{\partial c_{1,0}}=0:\frac{1}{c_{1,0}}=\lambda_1\\\frac{\partial L}{\partial c_{1,a}}=0:\frac{1}{2c_{1,a}}=\lambda_1\varphi_a\\\frac{\partial L}{\partial c_{1,b}}=0:\frac{1}{2c_{1,b}}=\lambda_1\varphi_b$
将上述表达式中的$c_{1,0}、c_{1,a}、c_{1,b}$的表达式带入最后一个约束式中可得：
$$\frac{1}{\lambda_1}+\frac{\varphi_a}{2\lambda_1 \varphi_a}+\frac{\varphi_b}{2\lambda_1 \varphi_b}=1\\ c_{1,0}=\frac{1}{2};c_{1,a}=\frac{1}{4\varphi_a};c_{1,b}=\frac{1}{4\varphi_b}$$

第二个人的优化问题：
$$max \ 2\sqrt {c_{2,0}}+[\frac{1}{2}log(c_{2,a})+\frac{1}{2}log(c_{2,b})]\\s.t. \ c_{2,0}+\varphi_a c_{2,a}+\varphi_b c_{2,b}=0.5\varphi_a+2\varphi_b$$

之后给出$c_{2,0},c_{2,a},c_{2,b}$均为$\varphi_a$和$\varphi_b$的函数。

市场出清存在，因为消费品不可以储存，每个时刻的每个状态的总消费均等于这个时刻这个状态的总禀赋。在0时刻，消费者1和消费者2的消费数量等于消费者1在0时刻的禀赋1；在1时刻a状态下，消费者1和消费者2的消费数量等于消费者2的股票在a时刻的支付为0.5；由此可得：
$$c_{1,0}+c_{2,0}=1\\c_{1,a}+c_{2,a}=0.5\\c_{1,b}+c_{2,b}=2$$
求解方程组
$\varphi_a\approx 0.81;\varphi_b\approx 0.32\\ risk\ free \ securities\ price: \varphi_a+\varphi_b=1.13\\ stock \ price=1.04 $

上述给出了一个资产定价的例子，均衡求解的过程对应着真实市场运行的逻辑。所有人基于其所面对的价格来选择其最优化的行为，每个人的行为都是阿罗证券价格的函数。且每个人做出的决策在市场出清的约束下能够达到宏观层面上的和谐。不存在所有人都想在第1期增加消费但是资源却不足以满足的情况。通过价格的调整使得每个人的行为与市场的约束契合起来。

##第十一讲
把均衡求出来之后要进行探讨，分析。均衡代表这现实社会发展的状态，因此存在对均衡的一系列问题。
(1)均衡是否存在？(大佬的问题)
可以证明，在相当宽泛的条件下均衡还是存在的。
(2)均衡是不是好？怎么来评价什么是“好”？
$G.E\ in \ a\ Complete\ Market$
$Pareto\ Optimal$ 帕累托有效 是一个效率的评价(Efficiency)
(3)均衡中资产价格满足什么样的性质和规律



回答第(2)个问题，均衡是不是有效的？是不是达到最好的呢?
用中央计划者($Central\ Planner$)的方法，假设中央计划者是仁慈的并且关心所有人。他希望所有人过得足够好，且他还掌握所有人的偏好信息，同时他对资源的配置有绝对的掌控力，他可以任意的调配资源。
对于central planner在分配资源的时候，面临的约束是最少的，只面临物理的约束。那显然，在面临最少的约束下所能达到的配置水平应该是所有人福利能达到最高的上限。也就是他能给出一个帕累托最优的配置。
以Central planner的配置为标准，比较均衡配置是否能达到Central Planner所能达到的上限，借此来判断均衡的配置是否为帕累托最优。

Central Planner的优化问题：
假设Central Planner选定每个人的消费计划，且总共为两期，0期是现在，1期是未来，且未来有$S$种状态。且他决定第$k$个人在0期、1期第1种状态、1期第2种状态...1期第$S$种状态的消费，且$k$从1到$K$。且每个人在Central Planner心中的地位不一样，致使存在一个衡量重要程度的系数$\mu_k\ge 0$，$\delta$为效用贴现因子。同时假设消费平还是不可储存的。

$$\underset{\{c_{k,0},c_{k,1},...,c_{k,S}\}^K_{k=1}}{max} \sum_{k=1}^K\mu_k[u_k(c_{k,0})+\delta \sum_{s=1}^S\pi_s u_k(c_{k,s})]\\ s.t. \ \sum^K_{k=1}c_{k,0}\le\sum_{k=1}^Ke_{k,0}\\ \sum^K_{k=1}c_{k,s}\le\sum_{k=1}^Ke_{k,s},s=1,2,...,S$$

$\mu_k$的取值随意给定，当然可以所有人都一样，也可以将所有资源全部集中在一个人身上，但是给定一个参数，我都可以计算出在该参数下帕累托最优的解。

求解这个问题：(约束条件中，不等式中大的减小的)
$$L=\sum_{k=1}^K\mu_k[u_k(c_{k,0})+\delta \sum_{s=1}^S\pi_s u_k(c_{k,s})]\\+\eta_0[\sum_{k=1}^Ke_{k,0}-\sum^K_{k=1}c_{k,0}]+\sum_{s=1}^S\eta_s[\sum_{k=1}^Ke_{k,s}-\sum^K_{k=1}c_{k,s}]$$
$P.O.$:
$\frac{\partial L}{\partial c_{k,0}}=0：\mu_k u'_k(c_{k,0})=\eta_0\\\frac{\partial L}{\partial c_{k,s}}=0：\delta\mu_k\pi_s u'_k(c_{k,s})=\eta_s\\ c_{k,0}={u'_k}^{-1}(\frac{\eta_0}{\mu_k})\\ c_{k,s}={u'_k}^{-1}(\frac{\eta_s}{\delta\mu_k\pi_s})$

$G.E$:
在均衡下，求解出居民的最优消费函数为：
$u'_k(c_{k,0})=\lambda_k\\\delta\pi_su'_k(c_{ks})=\lambda_k\varphi_s\\ c_{k,0}={u'_k}^{-1}(\lambda_k)\\ c_{k,s}={u'_k}^{-1}(\frac{\lambda_k\varphi_s}{\delta\pi_s})$

$If\ \lambda_k=\frac{\eta_0}{\mu_k},\varphi_s=\frac{\eta_s}{\eta_0}$，$P.O=G.E$.
但是这个前提条件的经济含义是什么?$\lambda_k$是拉格朗日乘子，也就是影子价格，放松约束条件带来的目标函数地上升幅度。一般均衡中求解的目标函数是消费者的效用，约束条件是消费者的总消费不可超出其财富，这里的总消费是指各期的总消费折到现在。$\lambda_k$表示$k$这个消费者财富的影子价格，决定于$k$这个消费者所拥有的财富。$\varphi_s$是指阿罗证券的价格。

只要给出一组$\mu_k$，就可以找出一个对应的帕累托最有效的资源配置，通过完全完备的市场中调整所有人的财富，使得在市场中的一般均衡所实现的资源配置等于这个帕累托有效地配置。
给一个帕累托有效配置，就一定会找到一个市场均衡来实现这个帕累托有效配置，实现的前提是可以随意调节所有人的初始财富。上述就是福利经济学第二定理。

福利经济学第一定理：市场均衡就是帕累托最优的。

福利经济学第一定理+福利经济学第二定理$\longrightarrow$ $P.O \Longleftrightarrow  G.E$.

方法论的结论：分析一般均衡的过程中，求解一般均衡确实比较麻烦，但是通过帕累托最优等价于一般均衡，可以计算这个Central Planner的帕累托最优，简便计算，方便分析。

达到均衡的时候，不同的人在不同状态下，他的消费是一个什么样的状况？
定理：在完备市场中达到均衡的时候，所有人的消费的波动只与全社会和全市场的总禀赋波动相关，而与其自己的波动无关。
证明：用中央计划者的结果：

在$s$状态下的总消费：
$C_s=\sum_{k=1}^Kc_{k,s}$
$c_{k,s}={u'_k}^{-1}(\frac{\eta_s}{\delta\mu_k\pi_s})$
$C_s=\sum_{k=1}^K{u'_k}^{-1}(\frac{\eta_s}{\delta\mu_k\pi_s})$
假设消费者风险厌恶，即$u''(\cdot)<0$。可得${u'_k}^{-1}(\cdot)$是一个单调函数。上述式子将拉格朗日乘子$\eta_s$与总消费$C_s$联系起来了。将$\eta_s$写为$C_s$的函数形式，且因为消费品不可储存，$C_s=e_s$。
$\eta_s=g(C_s)=g(e_s)$，将其带回原来的式子可得第$k$个人在$s$状态下的消费，自变量是$e_s$，即在$s$状态下的所有人的总禀赋，注意不是这个人在$s$状态下的个人的禀赋。
$c_{k,s}={u'_k}^{-1}(\frac{g(e_s)}{\delta\mu_k\pi_s})$
命题得证。
补充：但是$\mu_k$不是确定的一个数，它是存在这个一个关系：$\lambda_k=\frac{\eta_0}{\mu_k}$，即$\mu_k$是个人在0时期的总财富的一个函数。$\mu_k(\lambda_k)=\mu_k(e_{k,0}+\sum_{s=1}^S\varphi_se_{k,s})$。
所以说，$\mu_k$并非单独决定于$e_{k,s}$，而是决定于0时期的总财富。$\mu_k$与个人禀赋在未来各个状态的分布是无关的，只与总禀赋在未来的各个状态的分布有关。

举个例子：
在整个经济中存在两个人，且者两个人的未来的禀赋分布相反，状态$a$时，消费者1比较多，消费者2比较少；状态$b$时，情况相反。但不管怎样，两个人在不同状态下的总的禀赋是一样的。此时，每个人的禀赋在不同状态下是存在差异的，因为总禀赋在各个状态下时同样的，每个人在各个状态下的消费是一样的，没有波动。

类比CAPM，个体资产的风险是可以通过分散化投资予以消除掉，承担风险所获得的风险溢价仅仅是系统性风险才会得到是市场的补偿。

每个人禀赋的分布状态$\{ e_{k,0},e_{k,1},...,e_{k,S}\}$可能是不同的，但是没关系，最后决定每个人消费的是这个东西$\{ e_0,e_1,...,e_S\}$，即总禀赋的波动，也就类似于系统性的风险。前面个人的禀赋波动可以被完备市场给分散掉。

定理11.4：
任给两个状态$s,s'$，若$c_s>c_s'$。$Then\ \forall$ 消费者$k$，$c_{ks} >c_{ks'}$.
$c_s$是指在$s$状态下的总消费。
即如果某个状态下的总消费数更高，对于任意一个人来说，在总消费更高的状态下，他的个人消费也会更高。

所有人的消费都只决定于总禀赋，所有人的消费都因该是正相关的，总禀赋高的情况，所有人的消费都高；总禀赋低的情况下，所有人的消费都低。

定理11.5：(Wilson Theorem)
$T(c)=\frac{1}{R_A(c)}=-\frac{u'(c)}{u''(c)}$为绝对风险容忍度。
$$\frac{dc_{k,s}}{de_s}=\frac{T_k(c_{k,s})}{\sum_{k=1}^KT_k(c_{k,s})}$$

总禀赋变动一个幅度，对这个人在$s$状态下的消费的影响幅度。
分母等于所有人的风险容忍度之和，分子是$k$这个人的风险容忍度。也就表示了$k$这个人在总体中所占的比例是有多大。

一个人风险容忍度越大的人，即风险厌恶度小，在总禀赋变动的情况下，他承担了更多的风险，故他的消费的波动越大。但是需要注意，当总禀赋变动时，所有人的消费变动都是正相关的，换句话说，他们消费的增减方向相同，无非变动幅度存在差别。

假设两者的初始财富是一样的，承担风险更高的人的平均消费会更高一些。而承担风险更少的人，其消费的平均水平可会会低一些。
当然如果初始财富水平比较低的人，其平均消费水平可能会在低一些，但是消费的增减变动方向还是与上面两者是正相关的。

可能每个人在不同时期的禀赋不同，但是通过完备市场之后，所有人的消费都是正相关的，但是消费的波动幅度和绝对水品是不一样的。完备市场达成均衡之后会使得所有人的消费就像一个人一样，完全同步，这就达到了风险的分散。但是现实世界中并不是这样，所有状态下所有人的消费都一致。

(3)完备市场的均衡中资产价格满足什么样的性质和规律

消费者的优化问题：(两期问题)
消费者选择其资产组合(共存在$J$种资产)，目的是最大化贴现效用和
$$\underset{\theta_1,...\theta_J}{max} \ u(c_0)+\delta\sum_{s=1}^S\pi_s u(c_{1,s})\\s.t. \ c_0=e_0-\sum_{j=1}^Jp_j\theta_j\\c_s=e_s+\sum_{j=1}^J x_s^j\theta_j，s=1,2,...,S $$
求解：将约束条件带入至目标函数内：
$$\underset{\theta_1,...\theta_J}{max}\ u(e_0-\sum_{j=1}^Jp_j\theta_j)+\delta\sum_{s=1}^S\pi_s u(e_s+\sum_{j=1}^J x_s^j\theta_j)\\F.O.C :p_ju'(c_0)=\delta\sum_{s=1}^S\pi_su'(c_s)x_s^j\\1=\delta\sum_{s=1}^S\pi_s\frac{u'(c_s)}{u'(c_0)}(\frac{x_s^j}{p_j})\\\frac{x_s^j}{p_j}=(1+r_s^j)\\1=\delta\sum_{s=1}^S\pi_s\frac{u'(c_s)}{u'(c_0)}(1+r_s^j)$$
上述式子对任何人均成立，即消费者最优化问题的一阶条件。
$$1=\delta_k\sum_{s=1}^S\pi_s\frac{u'_k(c_{k,s})}{u'_k(c_{k,0})}(1+r_s^j)\\1=E[\delta\frac{u'_k(\tilde{c_{k,1}})}{u'_k(c_{k,0})}(1+\tilde{r_j})]$$其中，$c_0$是确定的0期消费，而$c_1$是1期消费，且是一个随机变量，$r_j$是资产$j$的收益率，同样也是随机变量。
很显然的，我们看到了资产的回报率放在了期望符号中，此时我们就得到了期望回报率。这也就是给出了资产的定价方程，这是根据消费者的一阶条件所得到的，决定于消费者的消费的波动。上述式子中决定于不同状态下的边际效用比值。

如何给资产定价：在完备市场的一般均衡中，随便找一个人，告诉我你在各个状态下的消费，就可以给所有的资产定价了。
为什么可以这么做？在均衡中，所有人都没有偏离均衡的动力，显然每个人认可均衡中的价格，所以你的边际效用比就一定和资产的价格存在一定的关系，据此我们就可以给资产定价。

道理说得通，但是实践上不可用。第一，拿不到每个人的微观的消费数据。第二，在微观层面每个人不都是理性的。
我们希望资产定价可以和宏观层面的经济数据联系起来，前面又提及所有消费者的消费都是完全正相关的，均像一个人一样。如何把宏观数据与这个联系起来？
可以假设存在代表性消费者$Representative\ Consumer$，是我们的分析不会存在太大的偏差。
定理11.6：
如果消费者的效用函数是$HARA$的(CARA效用函数是HARA的一种)，可以不失一般性的认为这个经济里面只有一个消费者，这个消费者的消费等于$C=\sum_kc_k$。
上述的定价方程可以将$k$拿掉，其含义也变成是代表性消费者的消费，且代表性消费者的消费$c_1,c_0$就是经济中的总消费。
$$1=E[\delta\frac{u'(\tilde{c_{1}})}{u'(c_{0})}(1+\tilde{r_j})]$$通过这样的方式，我们将宏观经济中的总量变量与资产价格定价就联系起来了。这是就可以分析，给定宏观经济增长的数据后，无风险资产的价格应该是多少就可以直接算出来了。这样就找到了宏观经济变量与资产价格联系起来的方法。
定义：随机变量$\tilde{m}=\delta\frac{u'(\tilde{c_1})}{u'(c_{0})}$，随机折现因子 $Stochastic\ Discount\ Factor\ SDF$。所以，所有资产的定价都会归结到找随机折现因子。**所以利用随机折现因子可以将式子写成：$$1=E[\tilde m(1+\tilde{r_j})]$$资产定价核心方程。**
上式在所有的定价方程里面都会出现，不同的资产定价理论的不同点在于增么去找到这个随机折现因子。
在C-CAMP中，随机折现因子有一个具体的形式，就是我的代表性消费者的边际效用比，即$\tilde{m}=\delta\frac{u'(\tilde{c_1})}{u'(c_{0})}$。

不要看这个式子简单，所有的资产定价都是围绕这个式子，还玩出各种花样。

上述等式对任何资产均成立，当然对于无风险资产同样成立，将无风险资产带入上式可得：
$1=E[\tilde{m}(1+r_f)]\rightarrow 1+r_f=\frac{1}{E(\tilde{m})}$
且，对于上面两个等式相减可得：
$0=E(\tilde{m})+E(\tilde{m}\tilde{r_j})-E(\tilde{m})-E(\tilde{m}r_f)\\0=\sum_{s}\pi_sm_sr_s^j-\sum_s \pi_s m_s r_f\\0=\sum_s \pi_sm_s(r^j_s-r_f)\\0=E[\tilde{m}(\tilde{r_j}-r_f)] \ 注：[E(XY)=E(X)E(Y)+Cov(X,Y)]\\0=E(\tilde{m})E[\tilde{r_j}-r_f]+Cov(\tilde{m},\tilde{r_j}-r_f)\\0=E(\tilde{m})[E(\tilde{r_j})-r_f]+Cov(\tilde{m},\tilde{r_f})\\0=\frac{E(\tilde{r_j})-r_f}{1+r_f}+Cov(\tilde{m},\tilde{r_f})\\ E(\tilde{r_j})-r_f=-(1+r_f)Cov(\tilde{m},\tilde{r_j})$
将$m$的具体形式带入到上式之中，可得：
$E(\tilde{r_j})-r_f=-(1+r_f)Cov(\delta\frac{u'(\tilde{c_1})}{u'(c_0)},\tilde{r_j})$
如果：
(1):$Cov(\delta\frac{u'(\tilde{c_1})}{u'(c_0)},\tilde{r_j})>0$，属于雪中送炭型资产；
边际效用与资产回报率呈正相关，边际效用高时，资产回报率高；边际效用低时，资产回报率低。由于边际效用递减，当消费处于很低的状态时，边际效用高。
此时，消费越低，资产回报越多；消费越高，资产回报越少。称为雪中送炭型的资产。这一资产非常好，大家都想要，价格水涨船高，故资产期望回报率很低。
(2):$Cov(\delta\frac{u'(\tilde{c_1})}{u'(c_0)},\tilde{r_j})<0$，属于锦上添花型资产；
边际效用与资产回报率呈负相关，边际效用高时，资产回报率低；边际效用低时，资产回报率高。由于边际效用递减，当消费处于很低的状态时，边际效用低。
此时，消费越低，资产回报越少；消费越高，资产回报越多。称为锦上添花型的资产。这一资产非常差，大家都不想要，价格非常低，故资产期望回报率很高。

期望回报率的决定因素:资产回报率与你的边际效用之间的关系。


取一个二次型的效用函数：$u(c)=-ac^2+bc(a>0)\\u'(c)=-2ac+b$。
假设市场组合$M$(整个市场，整个经济)：$X_s^M=e_s，\tilde{r_M}=\frac{\tilde{c_1}}{p_M}-1$
$M$这个组合在$s$状态下的回报就是整个经济状态下的总禀赋。
总禀赋在1期对应的总消费除以资产价格减1得到资产回报率。

随机折现因子：$\tilde{m}=\delta\frac{-2a\tilde{c_1}+b}{-2ac_0+b}$，将随机折现因子带回到上面的式子中去，可得：
$$E(\tilde{r_j})-r_f=-(1+r_f)Cov(\delta\frac{-2a\tilde{c_1}+b}{-2ac_0+b},\tilde{r_j})\\E(\tilde{r_j})-r_f=\frac{2a\delta(1+r_f)}{-2ac_0+b}Cov(\tilde{c_1},\tilde{r_j})\\E(\tilde{r_j})-r_f=\frac{2a\delta(1+r_f)p_m}{-2ac_0+b}Cov(\frac{\tilde{c_1}}{p_m}-1,\tilde{r_j})\\E(\tilde{r_j})-r_f=\Delta Cov(\tilde{r_M},\tilde{r_j})$$上面这个式子对于所有资产均是成立的，将$r_M$带入可得：
$$E(\tilde{r_M})-r_f=\Delta Cov(\tilde{r_M},\tilde{r_M})$$两式相比之后，就可以得到我们熟悉的方程：

$$\frac{E(\tilde{r_j})-r_f}{E(\tilde{r_M})-r_f}=\frac{\Delta Cov(\tilde{r_M},\tilde{r_j})}{\Delta Var(\tilde{r_M})}$$

CAPM核心方程：$$E(r_j)-r_f=\beta_j[E(r_M)-r_f]，\beta_j=\frac{\sigma_{jM}}{\sigma^2_M}$$

CAPM是C-CAPM的一个特例。当我们的效用函数是二次型的效用函数时，或者是效用函数为CARA，且回报率服从正态分布的前提下。
用C-CAPM反过头来看CAPM，能够解释之前我们无法解释的问题。市场组合到底是什么？蕴含的风险到底是什么？

市场组合的回报是总禀赋，所以市场组合就是对这个经济里面所有产出的一种索取权，所以市场组合就是宏观经济。市场组合的波动就是宏观经济的波动。这种宏观经济的波动是每个人都无法逃避的，总量在波动。但是在总量波动外还有自己个人的波动，比如运气好收入多，运气差收入少，没关系，通过完备的资产市场可以将自己收入的波动给他分散掉，每个人在完备市场中承担的只是宏观经济的波动，超过宏观经济波动的波动都可以通过完备的市场加以分散掉，最后每个人的消费都是正相关的，与宏观经济的波动正相关，这是你无法逃避的风险，这一风险是由市场中所有资产所共同提供的风险。所以资产里面所包含的，与宏观经济正相关的风险，称之为系统性风险。除此之外的风险可以被分散掉，因此在资产定价上就没有必要给它以回报上的奖励。所以最后对资产的回报，去决于$\beta$，就是各类资产与宏观经济之间的衡量，且市场组合就是宏观经济。宏观经济的波动使我们无法逃避的系统性的风险。

既然市场组合与宏观经济联系起来了，那么在什么样的宏观经济状况下，我的各类资产应该有什么样的回报率的状况。可以拿这些推导到现实中比对是不是这样。这个模型可以用现实去检验。但是，CAPM无法用现实去检验，因为不知道市场组合是什么，你没法检验。你说该式子检验出来不成立，可以说式子本身就不对，也可以说市场组合选择的就不对，所以没法说CAPM被证伪了。
在C-CAPM中，将资产价格与宏观经济指标、各期消费联系起来了，这时就逃不掉了。在这样的消费情况下，资产价格就因该是这样的，在与现实中进行比较。这时我们就可以看出谜题($Puzzle$)了。


##第十二讲：
回顾：
在一定的前提条件之下，建立起$P.O\Longleftrightarrow  G.E$之间的关系。
上述关系的建立是依据福利经济学第一和第二定理所保证的。
给出两点结论：
(1)均衡是好的，以经济学所用的帕累托最优为标准来衡量均衡是好的。
(2)构建起他们两的等价关系之后，我们可以用帕累托最优来研究一般均衡，因为其二者是等价的。(帕累托最优是一个比均衡更简单的一个问题)

沿着该思路分析完备市场中的均衡是什么样的状况。
任何一个消费者在任何状态下的消费都是该状态下总禀赋的一个函数，而非消费者个人禀赋的函数，$c_{ks}(e_s)$。对于任意两个消费者，他们的消费$c$是完全正相关的，因此看起来就像是一个人。消费正相关，但是消费的波动却不相同，由其风险厌恶度影响。同时，将风险划分为$systematic$和$idiosyncratic$风险。
因此引入一个代表性消费者，他的消费就是总消费，他的行为就像是所有消费者消费的加总，当然，他的引入也是存在一定的前提条件的，消费者效用函数是HARA的(CARA是HARA的特例。)

资产价格和宏观的一些指标(主要是消费)联系在一起。最后联系起来的一个核心方程为：
$$p_j=E[\delta\frac{u'(\tilde{c_{1}})}{u'(c_{0})}\tilde{x_j}]\Longleftrightarrow 1=E[\delta\frac{u'(\tilde{c_{1}})}{u'(c_{0})}(1+\tilde{r_j})]$$
决定资产价格的是系统风险，而非个体风险。系统风险就是总禀赋，社会总消费的波动，超过总消费的波动可以在完备市场中被分散掉。个体性的风险是没有必要承担的，因此市场是不会奖励你承担这样的风险，在期望回报率中予以补偿的只有系统性风险。
任何一个资产的系统性风险由什么来衡量？由相关性。由它的回报与总消费之间的相关性来衡量。虽然作为期望——$E[\delta\frac{u'(\tilde{c_{1}})}{u'(c_{0})}(1+\tilde{r_j})]$——期望回报之间存在两个随机变量，第一个随机变量是我的消费，第二随机变量是资产的回报率，其实是它俩的乘积的一个期望。这就引入了相关性的概念。(两个乘积的期望展开后会出现一个协方差)。在二次型的效用函数的假定下，上述式子就直接化为CAPM的证券市场线的形式。
系统风险(总消费的波动)与各类资产算含有的风险就是它与总消费之间的相关性加以衡量。这一部分是对资产定价有影响的东西。
这个式子可以写的更加单(以随机折现因子来表示)：
$p_j=E[\tilde{m}\tilde{x_j}]\Longleftrightarrow 1=E[\tilde{m}(1+r_f)]$

任何一个资产定价理论，最后归结为如何给出一个随机折现因子的表达式。在C-CAPM中，随机折现影子就是跨期的边际效用比。在其他的理论中，随机折现因子就会表达为其他的表达式，而不同的表达式反映出来的是不同的决定资产价格的力量。就看研究者向分析哪一方面的力量了。找出决定$\tilde{m}$的经济力量。实践中，也是使用这个式子为资产定价的，要把$\tilde{m}$与你可以观测到的数据联系起来。
我们未来资产定价的核心主旋律。我们从特殊的均值方差模型到不那么特殊的C-CAPM，再到最一般的$1=E[\tilde{m}(1+r_f)]$定价式。
在后续的无套利定价中，我们直接从这里开始。证明在无套利条件下上述等式的成立。然后再说$\tilde{m}$是什么东西，再把$\tilde{m}$找出来。

回顾结束，开启本节课的任务：
对C-CAPM理论中的下式进行分析：
$$p_j=E[\delta\frac{u'(\tilde{c_{1}})}{u'(c_{0})}\tilde{x_j}]$$这个式子把一些经济变量联系在一起。这些经济变量就需要满足这些条件。在这个一般均衡之中，所有变量他是相互联系的，因果关系的都是相互的，你影响我，我也反过来影响你，最后同时被决定。
分析的时候，根据我的研究课题，针对某种因果关系予以分析。
在研究资产定价问题时，假设给定$\tilde{c_1},c_0$。然后来找出资产的期望回报率$E(\tilde{r_j})$是多少。
当然也可以反着用，弗里德曼、莫迪利安尼的生命周期、持久收入假说：给定$\tilde{r_j}$，来分析$c_0,c_1$是什么样的，都是可以的。
当然在金融领域，我们可能会花费更多的注意力集中在第一个方向上，分析如何进行资产定价。

接下来，我们来分析这个式子，看看这个式子能够告诉我们什么东西。
显然这个式子成立：
$E(\tilde{r_j})=r_f+(E(\tilde{r_j})-r_f)$
等式右边第一项是无风险利率，也就是资金的时间价值，当然这里的资金是广义的，没有提及中央银行或者是货币，当然你可以理解为资源的时间成本。第二项，就是超额收益，也可以说是风险溢价。
也就是说，弄清楚资产的期望收益率，首先需要搞清楚无风险利率，其次还要搞清楚超额收益。

- **1.对于无风险利率，他是如何决定的？它包含了哪些经济的力量，这是我们需要分析的问题。**

$1=E(\tilde{m})(1+r_f)$.

$Def$：消费的增长率$\tilde{g}=\frac{\tilde{c_1}}{c_0}-1$，由此可知$\tilde{c_1}=c_0(1+\tilde{g})$。
$Var(\tilde{g})=E(\tilde{g}^2)-E^2(\tilde{g})=E(\tilde{g}^2)-\bar g$。
消费增长率的量级大概为中国：10%；美国：1%-2%。
上述等式就可以也为：
$Var(\tilde{g})\approx E(\tilde{g}^2)$。

用上面的玩意把随机折现因子给写一下：
随机折现因子可以表达为：$\tilde{m}=\delta\frac{u'[c_0(1+\tilde{g})]}{u'(c_0)}$。
然后研究这个式子的性质，但是我们并没有函数$u$的具体形式，金融学经常使用到的泰勒展开(二阶)：
$u'[c_0(1+\tilde{g})]$在$c_0$处进行泰勒展开可得：
$\tilde{m}=\delta\frac{u'[c_0(1+\tilde{g})]}{u'(c_0)}\\= \frac{\delta}{u'(c_0)}[u'(c_0)+u''(c_0)(c_0\tilde{g})+\frac{1}{2}u'''(c_0)(c_0\tilde{g})^2+...]\\=\delta[1-(-\frac{c_0u''(c_0)}{u'(c_0)})\tilde{g}+\frac{1}{2}(-\frac{c_0u''(c_0)}{u'(c_0)}\tilde{g} \cdot -\frac{c_0u'''(c_0)}{u''(c_0)}\tilde{g})]\\=\delta(1-R_R(c_0)\tilde{g}+\frac{1}{2}R_R(c_0)P_R(c_0)\tilde{y}^2)$.

$E(\tilde{m})=\delta[1- R_R \ \bar g +\frac{1}{2} R_R \ P_R\ \sigma_g^2]$.

$r_f=\frac{1}{E(\tilde{m})}-1\\=\frac{1-\delta[1- R_R \ \bar g +\frac{1}{2} R_R \ P_R\ \sigma_g^2]}{\delta[1- R_R \ \bar g +\frac{1}{2} R_R \ P_R\ \sigma_g^2]}\\ \approx \frac{1-\delta}{\delta}+R_R\bar g-\frac{1}{2}R_RP_R\sigma_g^2；\rho=\frac{1-\delta}{\delta} \\ r_f=\rho+R_R\bar g-\frac{1}{2}R_RP_R\sigma_g^2$

近似：$\frac{a}{1+x}\approx a$，当$x$很小的时候成立。

此时，无风险利率$r_f$就可以表示为：
$$r_f=\rho+R_R\bar g-\frac{1}{2}R_RP_R\sigma_g^2$$(1) 其中，$\rho$取决于人性的不耐($impatience$)，人越是不耐心，对于过去的效用贴现到现在的折现率$\delta$就越小，反之$\rho$就越大，$\rho$反应人的不耐心程度。人越是不耐心，无风险利率就越高。
其现实含义是指：人越是不耐心，越是不愿意储蓄，因此想要我去主动储蓄，你的无风险利率必然要高，给我一点甜头，我才会愿意把钱拿去储蓄。
所以人性不耐会使得利率存在。
假设$\delta=0.98$，$\rho=\frac{1-\delta}{\delta}\approx 0.02$.


(2)上式第二项，消费的平均增长率越高，无风险利率会越高。
消费增长率无非是未来消费除以现在消费，消费的平均增长率高是什么意思？那就是未来的消费多。未来的消费多的话为什么有必要将现在的消费储蓄下来转移到未来呢？未来的消费越多，我现在储蓄的意愿就越低。既然储蓄意愿低，为了平衡不愿意储蓄的意愿，无风险利率必须高，才能使得我愿意去储蓄。

同时，$\bar g$前面乘上了一个相对风险厌恶系数，也就是说全社会的平均风险厌恶度越高，无风险利率会越高。
消费平滑：越是风险厌恶，我的边际效用下降的越快，越愿意在不同时间和不同状态下平滑我的消费。
我的消费平滑意愿很强，且同时假设消费是增长的，未来的消费比现在的消费要多，那我就非常有动力去将过去的消费转移到现在。这意味着通过减少储蓄，增加当期消费来得以实现。
所以给定同一个消费增长率的均值，社会平均代表消费者越是风险厌恶，其消费平滑意愿就越强，就愿不愿意去做储蓄。要想吸引他们去储蓄，就必须要提高无风险利率，才能抵消其不愿储蓄的念头。
综上，上式第二项对应着是$Economic\ growth$对应的无风险利率。

(3)上式第三项是$-\frac{1}{2}R_RP_R\sigma_g^2$，也就是我们之前说的预防性储蓄动机($Precautionary\ Saving$)。如果未来越不确定，消费增长的波动率越大，使得我预防性储蓄的动力就越强，此时无风险利率下降。既然我已经通过预防性储蓄动机进行多储蓄了，就不需要这么高的利率来激励我储蓄。

现在回过头来对上述内容做一些评论和解释：
(1) 很多同学会存在质疑，上述的省略是不是太不严谨了。这么做是不是太不合适了。实际上，上述的近似的真实目的就一个，凑出来这个等式。 
对于一些问题来说，不同专业的人看待的问题是不一样的。例如Python在运行多进程问题时，可能以为自身设计问题而出现锁死的情况。对于数学家来说，需要找到一种设计机制，完美的规避这个问题，不会再次发生锁死情况。但是对于工程师来说，考虑程序锁死发生的概率为十年一次的时候，就不会在这个问题上费时间和经历，大不了锁死之后在重启一下子呗。
上述简化在分析问题上量级上的影响有多大？当然会把数据带入分析后发现其实影响并不是特别大，对于分析问题来说，这种近似是可以接受的。
当然，另一种解释是，这里我们分析的是离散时间，当将时间间隔缩小到非常短的时候，可以理解为连续时间，此时上面的近似在连续的时间下面就变成严格相等了。

(2)这里的无风险利率是一个真实的无风险利率。现实生活中，我们说地无风险利率指的是国债收益率，那是个名义利率，即以货币计价的利率。但是上述模型中并没有引入货币，也不引入货币，计价物使用的是消费品，这里的无风险利率，它是指的以消费品计价的真实利率，名义上的无风险利率还要在上述利率的基础上加上通胀预期。但是这并不影响我们分析无风险利率到底由什么力量决定的。

(3)无风险利率再决定因素上不仅仅取决于人的主观因素(人性不耐)，还包括客观因素，即消费在不同时间和不同状态下的分布。同样一个主观耐性程度一样的人，在不同情况下可能他接受的利率是不一样的。比如，他预期明年丰收，消费水平会很高，此时的无风险利率就很很高；反之过了几年，明年预期很差，消费会下降，此时无风险利率会很低。

(4)$Equilibrium$ 均衡：就是两种力量之间相互平衡。
在刚才分析过程中，人越是不耐性，就会减少储蓄，而为了吸引人们储蓄，就会提高无风险利率。

(5)这套分析无风险利率的框架是在上节课的分析框架下进行的，我们在这套框架中假定了消费品是不可储存的，即$non-storable\ goods$。也就是说从技术角度来看，消费品无法储存到下一期。那么为什么可以讨论储蓄这个话题呢?
这里的区别在于宏观层面上是无法完成储蓄的，但是具体到微观的个人却可以完成储蓄。比如，大家都种果树，在0期我收获果子，但是这些果子不可以储存到1期，如何完成储蓄?将0期的果子分给别人食用，并签订一份借贷协议。到1期的时候，别人家用果子来偿还0期的债务，从而实现储蓄的目的。

但是在宏观层面，假设大家都想在0期把果子借给别人吃，然后让别人在第1期还果子给自己，那此时会发生什么？
储蓄的价格变动，也就是无风险利率的变动。
均衡通过价格的调整使得所有人的理性都和谐的达到，同时保证所有人的理性行为与他所面临的约束条件是契合的。
无风险利率会越来越低，同时让你觉得储蓄完全没有意义。可能你今天借10个果子给邻居，邻居签协议的时候只保证1期还你2个果子，你爱借不借，反证有的是人会借给他果子吃。
微观层面和宏观层面相互联系的机制就是价格机制。探讨了一堆，其实就是在讨论价格机制这个东西是由什么决定的。

下面给这个式子一个具体的代数求解：
给出$CRRA$效用函数$u(c)=\frac{c^{1-\gamma}-1}{1-\gamma}$
$R_R=\gamma，P_R=\gamma+1$，
中国数据：
$r_{f_{CN}}=2\%+2 \times 9.7\%-\frac{1}{2}\times2\times3\times0.05\%\\=2\%+19.4\%-0.15\%\\=21.25\%$.
先不说数据的真实与否，看着三个组成部分的量级大小，显然第三项在量级上和前两项几乎不是一个概念，量级太小了，分析利率决定时第三项可以忽略不计了。对于中国这种经济增长、消费增长的国家来说，无风险利率的大头还是来自于未来消费的增长。
但是回到现实情况来说，这个数据和现实中的无风险利率差的十万八千里。现实中，国债收益率减去通货膨胀率得到的真实无风险利率大小大约是0%。
这就引发了一个$puzzle$，即$Risk-free\ Rate \ Puzzle$。



- **2.对于风险溢价，我们现在来分析风险溢价**

$E(\tilde{r_j})-r_f=-\frac{\delta(1+r_f)}{u'(c_0)}Cov(u'(\tilde{c_1}),\tilde{r_j})$
上节课分析过这个式子：
雪中送炭型资产：资产的回报率与边际效用呈现正相关，当你边际效用高的时候(意味着消费水平非常低)，资产的回报率也高；当你边际效用低的时候，资产的回报率也低。显然这是一个好的资产，价格也会越高，期望回报率就会越低。

锦上添花型资产：资产的回报率与边际效用呈现负相关，当你边际效用高的时候(意味着消费水平非常低)，资产的回报率也低；当你边际效用低的时候，资产的回报率高。显然这是一个糟糕的资产，价格也会越低，期望回报率就会越高。

这里我们看到的是曾经讲过的问题的重现，决定资产风险溢价的是其包含的系统性风险，这种系统性风险是其回报率与某个东西的一个相关性。这个东西就是总消费的波动，这个是无法通过市场来分散掉的，是每个人必须承担的风险。每个风险所包含着这一块风险的大小决定了这个资产风险溢价是高还是低。个体风险可以被分散掉的，就不会在风险溢价中得到体现。

对上述式子在做出一定的变形：
给出$CRRA$效用函数$u(c)=\frac{c^{1-\gamma}-1}{1-\gamma}$
随机折现因子$\tilde{m}=\delta\frac{[c_0(1+\tilde{g})]^{-\gamma}}{c_0^{-\gamma}}=\delta(1+\tilde{g})^{-\gamma}$
上式可以写成：
$E(\tilde{r_j})-r_f\\=-\delta(1+r_f)Cov[(1+\tilde{g})^{-\gamma},\tilde{r_j}]\\ \approx-\delta(1+r_f)Cov[1-\gamma\tilde{g},\tilde{r_j}]\\=\gamma\delta(1+r_f)Cov[\tilde{g},\tilde{r_j}]\\=\gamma(1+\delta\gamma\bar g)Cov[\tilde{g},\tilde{r_j}]$.

近似：$(1+\tilde{g})^{-\gamma}\approx 1-\gamma\tilde{g}$ 根据泰勒展开可得
上述倒数第二个式子中，将$r_f$用对应的效用函数的表达式带入可得

美国经济学家对上述式子做了检验，用1889-1978年的数据得到：
$6.2\% =\gamma(1+0.999\times1.8\%\times\gamma)\times0.3\% \rightarrow \gamma \approx16$.

举个例子：赌局
$\frac{1}{2}\ win \ 50\%$
$\frac{1}{2}\ lose \ 50\%$
假设你有1万块钱，抛硬币，正面向上财富值为15000元；反面向上财富值为5000元。

再假设你付出一定比例的财富们就可以规避这个赌局。
假设$x$分别为25%、41%、46%、47%。
上述比例对应的相对风险规避系数分别为：
$\gamma： \ 2、5、10、15$。

显然，让一个人相对风险规避系数超过5都是非常不正常的事情。
因此，给定一个合适的相对风险规避系数就解释不了观察到的风险溢价。或者也可以说，其实美国股市的风险没有那么高，以至于没有理由美国的股市有这么高的回报率，这么高的风险溢价。
而且就算接受$\gamma=16$，那么美国的无风险利率为：
$r_f=\rho+\gamma \bar g =28.9\%$.

这又碰到了一个谜题：$Equality\ Premium\ Puzzle$

对于C-CAPM来说，辛辛苦苦推了半天，搞出个这两个谜题，完全与现实情况不相吻合。但这两个谜题是金融领域的一个重大进展。

评价：
(1)
CAPM没有看出谜题，因为检验CAPM时需要同时检验两个东西，一是证券市场线SML是否成立，其次是市场组合的选择是否选对了。这两者同时被检验。假设我选择A股市场的上证综指为市场组合，对其数据进行检验，发现与现实情况不符。两种解释:一是CAPM这个理论存在问题；二是，你没有选择正确的市场组合。这两个东西区分不开，总可以说市场组合选的不对，一定意义上来说，这玩意不可以被证伪。但是C-CAPM模型就非常明确的告诉你风险溢价和无风险利率与总消费是相关的，但是确实与现实情况对不上。所以能够看出谜题的原因，我们能够通过理论知道这玩意应该是什么。比如无风险利率$r_f=21.25\%$，相当于理论变成一把尺子，你可以说尺子不太准确，但是总是比没有尺子要好得多。尺子的出现比没有尺子要好。
(2)
有了尺子，虽然不太准确，存在问题，至少找到了优化的方向，比无头苍蝇要好的多得多。出现了上述谜题之后，无数的人就这个问题提出看法，改进方向，促进发展。
(3)
为什么存在这个谜题，因为我们用同一个指标去衡量两种不同的经济力量，一个是跨期的消费平滑，一种是跨期的消费平滑。但是在我们的理论框架中，只使用一个指标进行刻画。引发后续人们的思考，如果用两个不用的指标来刻画这两股不同的经济力量，是否可以解决这个问题。但是基本结论是，上述的谜题确实给我们提出了不同的研究方向。

C-CAPM学完后，资产价格满足一定的规律，即资产与总消费的相关性。所以在形式上与CAPM的形式是类似的。
但是C-CAPM是一个相对来说比较抽象的模型，他做出了一些看起来并非合理的假设，比如所有人都是理性的，但是本学期最后一讲会回到这个话题，但是现在还是提一提。现实生活中会有人根据上述的模型求解均衡，预判未来的资产价格吗？但是怎么理解这个呢？“市场中纷繁复杂，但是有一个看不见的手，引导人们达到一个和谐的状态”。求解均衡的过程就是在求解那只看不见的手。它是价格机制通过引导那些自利的人去做出这种行为，以达到微观行为和宏观约束相契合的状态。每个人看起来都是为自己的，但是也都是基于价格来选择对自己最优的行为的。而价格的调整会引导所有人的最优行为已达成与宏观约束相一致的和谐的状态。这就是均衡和看不见的手。那些不理性的人做不出最优的选择，要么变得理性，要么不断亏钱，最后亏光了，被市场淘汰。所以最后，现实市场会向理性人假设去收敛。

同样，对于我们投资也有一定的指导意义，这涉及到我们投资的方法论。
当我们买卖资产的时候，比如说去买股票的时候，你能够买股票就意味着有人在卖股票，换句话说，你认为这只股票的价格比较低，而你的对手认为这只股票的价格比较高。那如果这样的话谁是对的呢？要么有人对的，要么有人错，所以对的那个人赚钱了，错的那个人亏钱了，所以这就是一个零和博弈，我赚的就是他亏的。在交易的时候总要去想，我在想什么，别人在想什么，别人在想我在想什么，无限循环下去。没有为社会创造价值，就是一种赌博。
这种投资方法就要求你要考虑别人是怎么想的，市场是怎么想的。如同凯恩斯所说的“选股票就如同选美比赛”，不是依据我的标准选择最好看的姑娘，而是我猜想市场上大多数人是如何选择最好看的姑娘。这样的思维要求你去猜别人的思维，去猜别人是怎样想我的...，逻辑链不断循环。这种投资方式就非常博弈性，非常短期。
但是正常的思路是什么？C-CAPM就告诉你，看到交易发生时，双方对于资产的评价确实是不一样。但是两者都是对的，因为对资产价格评价除了资产本身的特点之外取决于这个人自身的一些条件，比如一个人的消费。假设一个人未来的消费比现在的消费要多得多，他就会想办法将未来的资源移到现在来，这个时候就不会买资产，甚至将通过借贷把未来的消费移到现在来，对这种人来说，他不愿买资产，他认为资产的价格应该很低。对于另一个人，现在收入比较多，但是未来收入很低，他就会考虑买资产，将现在的消费转移到未来。这是他就会考虑买资产，哪怕价格很高。
通过资产的买卖来调节双方的禀赋在不同时期的分布。或者说调节双方的消费流在时间轴上的分布。双方都通过这种分布的调整获得效用的最大化。交易中无论交易双方都是正确的，只是通过交易来达成资源的配置。最后，如果大家像C-CAPM中一样，消费完全的正相关了，那么大家对资产的评价就都是一样了，那就没有交易了。但是总有不断地新信息的加入使得交易不断进行。总在向均衡收敛的过程中。如何把握资产价格的走向？通过金融学的分析方法，把握市场的长期走向，那是看不见的手把握市场的走向。


##第十三讲
从这一讲开始，以另一种方式分析金融定价，上半学期讲的是均衡定价Equilibrium Pricing，也被称为绝对定价。其含义是资产的价格从无到有，给出一堆假设：偏好，消费等，就可以为资产定出价格。好处是把市场的运行机制描述的很清楚，给我们一些启示。风险的分类，系统性，非系统性，区别，联系。但是缺点是用这个来选股，指导投资实践是非常不合适的。你不可能提出一系列假设，然后算出均衡价格。你的假设合理吗？可行度有多大？与市场的真实情况相一致吗？
这个东西在现实中不好用，在计算更精确的定价时我们需要一个更为精确的方法，这个方法就是称为无套利分析:($Non-Arbitrage\ Pricing$)。无套利分析基于一个核心思想：$Law\ of\ One\ Price$。即，一价定律。
所以，这种无套利定价通过资产价格之间的关系，基于一些已有的资产价格的信息，定出其他资产价格的信息。这就是相对定价：($Relative\ Pricing$)。

今天我们要讲的是相对比较特殊的无套利定价理论。($APT：Arbitrage\ Pricing\ Theory$)(套利定价理论)

在CAPM中推导出来一条证券市场线：$SML：E(\tilde{r_i})-r_f=\beta_i(E(\tilde{r_M})-r_f)，\beta_i=\frac{\sigma_{iM}}{\sigma_M^2}$。
这个玩意写成计量的模型为单因子模型：
$Single\ Index\ Model：\tilde{r_i}-r_f=\alpha_i+\beta_{i,M}(\tilde{r_M}-r_f)+\tilde{\varepsilon_i}$.
但是，这玩意拿到现实数据拟合非常糟糕，中国的数据拟合不出一条直线出来。计量的研究人员发现拟合的效果非常差的时候就回往里面添加解释变量。一个不够加两个，两个不够加三个，然后在讲个故事解释这事。

最有名的经济学家就是1993年提出的三因子模型的尤金法玛：
三因子模型：
$\tilde{r_i}-r_f=\alpha_i+\beta_{i,M}(\tilde{r_M}-r_f)+\beta_{is}\tilde{SMB}+\beta_{ih}\tilde{HML}+\tilde{\varepsilon_i}$.
$SMB$上市公司规模；$HML$股票的价格
三因子模型对于现实的解释力就比原来强很多了。
这一思想被提出之后，有越来越多的相似的想法一一产生，形成了多因子模型(Multi-factor Model)，所谓因子就是那些会影响资产价格的那些不确定性的来源。文献中提出的因子包括几百个因子，只要这些因子可以得到时间序列数据，计算机总是可以给你求出个相关系数。但是，这些因子是否靠谱，可信？回归方程是否有意义？这需要一个理论来支撑。否则，计量经济学的意义和数据挖掘就等价了。正如一位经济学家所言：“If you torture the data long enough, it will confess”。但是就算发现了这个数据有意义吗？能指导实践吗？

给他一个理论的支撑：就是APT。
从直觉上理解：如何在回归方程中随便的扔入一些观测的序列？
回到均衡定价的框架下面：C-CAPM的定价方程式如何给出来的？是通过消费者效用最大化推出来的：
$max \  u(c_0)+\delta E[u(\tilde{c_1})]\\ s.t. \  c_1=(1+\tilde{r_w}) (w_0-c_0) $
显然最大化两期效用和，且第二期是一个期望效用。
然后约束条件是初始的财富$w_0$，但是0期需要消费掉一些$c_0$，剩下的留于储蓄。储蓄放在资产上面，且资产的回报率为$\tilde{r_w}$，且也是一个随机变量。可以将$\tilde{r_w}$视为市场组合的收益率。

$F.O.C：1=E[\delta \frac{u'(\tilde{c_1})}{u'(c_0)}(1+\tilde{r_w})]$
将效用函数写为二次型效用形式：
$u(c)=-\frac{1}{2}(a-c)^2\\ u'(c)=a-c$ 边际效用永远是正的，要求$a$是一个非常非常大的数。
可以将边际效用带入随机折现因子：
$\tilde{m}=A-B\tilde{r_w}$ 随机折现因子是一个线性的表达式。
$\Longrightarrow E(\tilde{r_j})=r_f+\beta_j \lambda_w$

其实上式和SML相同，无非是将市场组合的风险溢价改写为$\lambda_w$。

在上述的框架中，我的消费者消费的不确定性来源是来自于市场组合的回报率的不确定性。但是如果消费者还面对另外一种不确定性，是他工资收入的不确定性。上述消费者面对的约束条件可能要改一改了。
假设消费者在第0期有$y_0$的收入，在第1期有$y_1$的收入，且$y_1$的收入是一个随机变量，并且假设收入的不确定性与市场组合收益率的不确定性是相互独立的。
$s.t.\ \tilde{c_1}=(1+r_w)(w_0-c_0+y_0)+\tilde{y_1}$


此时最大化的一阶条件是不变的，且效用函数也是不变的。
$F.O.C：1=E[\delta \frac{u'(\tilde{c_1})}{u'(c_0)}(1+\tilde{r_w})]$
$u(c)=-\frac{1}{2}(a-c)^2\\ u'(c)=a-c$
但是此时的随机折现因子的表达式发生变化：
$\tilde{m}=A'-B'\tilde{r_w}-C'\tilde{y_1}$
此时资产定价的式子可以写为：
$E(\tilde{r_j})=r_f+\beta'_{j,w}\lambda'_w+\beta'_{j,y}\lambda'_y$
和之前的期望回报等式相比，除了无风险利率和市场组合带来的收益之外，还存在另外一个因素，即工资收入的不确定性所带来的风险形成的风险溢价。
换句话说，之前我们在多因子模型中添加的那些因子，说白了在C-CAPM的框架下，就是会最终影响到你的消费，因而要你承担不同的风险的来源。这是因子的经济含义，即你要承担的系统性风险的来源。这个来源在单因子模型中就是市场组合，在多因子模型中可以认为是别的东西，比如工资性收入和一些其他的因素。所以往里面加的因子的经济含义是：我确实认为这些不确定性会带来我消费者消费的波动，因而会增加我消费者必须要承担的风险，而且注意这种风险是不可以通过分散化投资来分散掉的。所以它一定会影响总消费的波动的，所以这些因子是可以加进去的，这些因子是合理的。

添加进去的因子会影响到我的消费，进而影响到我的随机折现因子，进而影响到资产的期望回报率，所以因子模型用C-CAPM是可以论证的。确实加因子是有道理的，但是不是所有的因子都可以往里面加。

对于三因子模型来说，加进去的SMB、HML这两个因子时，他要给出一个逻辑，为什么加进去这两个东西？这两个东西能够对系统性风险造成影响。进而能够获得风险溢价的补偿。上述是对多因子模型的经济道理上的解释。

接下来一步要论证，加因子可以，但是因子的形式如何确定？为什么是一个线性的形式？为什么不加一个平方、立方形式的因子。

$APT$对此就开始了论证：
$APT$的的基本思想为：认为我们看到的现实世界中的各种资产是由一组共同的因子(不确定性的来源)所影响的。当这些资产都受到共同的一组因子的影响之后，不同的资产的期望回报率之间会具有一种线性的关系。而这种线性的关系就是我们马上要推导出来的。当然，推导这个结论之前还要假设市场中没有套利的机会。

所以说，$APT$可以认为是这样一个理论：
在市场没有套利机会的时候，一些受到共同一组因子影响的资产，他们这些资产的期望回报率之间应该满足一个线性的关系。

所以$APT$没有说存在哪些因子会影响资产的以往收益率，也没说你如何去选择这些因子。所以说，这个理论的约束性不是特别的大。只要你的因子确实是影响了系统性的风险，那么我APT理论就可以为你得出的线性的关系做理论上的支撑。

在$APT$理论中，我们要了解如下几个概念：
(1)$Factor\ risk$ 因子风险：因子代表着不确定性 
(2)$Loading$ 载荷：不同资产对不同因子的风险暴露是不一样的。说的更加单一点，不同资产对于不同因子前面的$\beta$是不一样的。$\beta$就是其风险暴露或者是风险因子载荷。
(3)在解释完之后一定还存在一些不可以被解释的东西，这个东西称之为个体风险($idiosyncratic\ risk$)。

最简单的情况推导：两种资产，一个因子：
$\tilde{r_i}=\bar r_i+\beta_i\tilde{f}\\\tilde{r_j}=\bar r_j+\beta_j\tilde{f}$
其中$\bar r_i=E(\tilde{r_i})$，$\tilde{f}$是共同的因子，且因子对资产的影响的程度是不一样的，也就是说其载荷$\beta_i\ne \beta_j$。按照道理来说，上式还存在一个$\varepsilon_i$，但是考虑到从最简单的形式进行推导，就舍去了其存在。还有一个假设条件： $E(\tilde{f})=0$

所以现在的目的是要证明：资产的期望回报率$\bar r_i、\bar r_j$之间存在什么样的关系。

推导过程：
假设两个资产构成一个组合$p$：$(r_i,r_j)(w,1-w)$，组合$p$的回报为:
$\tilde{r_p}=w\tilde{r_i}+(1-w)\tilde{r_j}\\=w(\bar r_i+\beta_i\tilde{f})+(1-w)(\bar r_j+\beta_j\tilde{f})\\=[w\bar r_i+(1-w)\bar r_j]+[w\beta_i+(1-w)\beta_j]\tilde{f}$

选一个权重，使得这个组合在因子$\tilde{f}$上的载荷变成0；
$w_0=\frac{\beta_j}{\beta_j-\beta_i}$，使因子的影响变成零。此时该组合变成一个无风险组合，风险因素被消掉了。
$$\tilde{r_{p_0}}=\frac{\beta_j\bar r_i-\beta_i\bar r_j}{\beta_j-\beta_i}$$此时组合$p$成为了消除风险的资产组合，在市场上无套利机会的时候，这个回报率就一定等于$r_f$。解得：$$\frac{\bar r_i-r_f}{\beta_i}=\frac{\bar r_j-r_f}{\beta_j}=\lambda$$所以上述等式对于任意资产均成立，将上述分式定义为$\lambda$.
$$\lambda=\frac{\bar r_j-\bar r_i}{\beta_j-\beta_i}$$

现在我们给出另外一个组合：这个组合会使得对因子$\tilde{f}$的载荷为1，这个组合的系数称为$w_1$。
$$w_1\beta_i+(1-w_1)\beta_j=1\\w_1=\frac{1-\beta_j}{\beta_i-\beta_j}$$

权重带回到资产组合$r_p$中，可得
$\tilde{r_{p_1}}=[w_1\bar r_i+(1-w_1)\bar r_j]+\tilde{f}\\=[\frac{1-\beta_j}{\beta_i-\beta_j}\bar r_i +(1-\frac{1-\beta_j}{\beta_i-\beta_j})\bar r_j]+\tilde{f}\\=[\frac{\bar r_i-\beta_j\bar r_i+\beta_i\bar r_j-\bar r_j}{\beta_i-\beta_j}]+\tilde{f}\\=\frac{\beta_j\bar r_i-\beta_i\bar r_j}{\beta_j-\beta_i}+\frac{\bar r_i-\bar r_j}{\beta_i-\beta_j}+\tilde{f}\\=r_f+\lambda+\tilde{f}$.
两边取期望可得：
$\bar r_{p_1}=r_f+\lambda\\ \longrightarrow \lambda=\bar r_{p_1}-r_f \\ \longrightarrow \bar r_i-r_f=\beta_i(\bar r_{p_1}-r_f)$.
在两个资产，一个因子的条件下，得到的资产的期望回报率的表达式如下：$$\bar r_i-r_f=\beta_i(\bar r_{p_1}-r_f)$$ 回忆一下整个证明过程中我们在干嘛？
我们有两个资产和一个因子，资产数目大于因子数目，所以我可以构造一个组合，使得因子的载荷为0，将因子给消掉。这就是一个无风险资产，因为无套利，它的回报率就因该等于$r_f$。从这开始，将各个资产的期望回报率就联系起来了，共同等于一个数$\lambda$。

这个共同的数究竟是多少呢？我就又构建一个资产组合，使它的因子载荷为1。通过这个组合就计算出了$\lambda$的数值。所以因子载荷为1的组合称之为$factor\  portfolio$，因子组合。所以，因子组合给出了因子的溢价，即$\lambda$为$factor\ premium$。
所以最后资产期望回报率表示为这个资产的因子载荷$\beta$(对因子风险的暴露)乘上这个因子的价格(就是对应的因子组合$p_1$它的超额期望回报率)。这就是资产的期望回报率的表达式，这个式子与CAPM的SML存在类似之处。CAPM是资产的超额收益对市场组合的$\beta$和市场组合的超额收益的关系。但是形式虽然相同，但是本质上是不一样的。在CAPM的SML中，市场组合的含义是非常清楚的——市场上所有风险资产的组合，尽管在现实生活中找不到市场组合到底是什么。但是在APT推出的式子中，这个因子组合是什么含义是不清楚的。换句话说，你随便找出一个因子，我都可以将资产价格表示为这样的形式，相较于SML来说，他的灵活性就大很多。况且它俩基于的前提假设也是不相同的，SML是基于市场处于均衡的情况下推导出来的，但是APT只要求市场没有套利机会就可以了，即市场是无套利的就可以，不要市场是出清的。

现在，将这个思想向更$general$的方向拓展：
$$\tilde{r_i}=\bar r_i+\sum_{k=1}^K \beta_{i,k}\tilde{f_k}+\varepsilon_i,\ i=1,2,...,N；N\gg K\\E[\tilde{f_k}]=0；E[\tilde{f^2_k}]=1；E[\tilde{\varepsilon^2_i}]=\sigma^2_\varepsilon<+\infty\\E[\tilde{f_k}\tilde{f_{k'}}]=E[\tilde{\varepsilon_i}\tilde{\varepsilon_j}]=E[\tilde{f_k}\tilde{\varepsilon_i}]=0$$


因为资产的数量远远大于因子的数量，可以构建一个资产组合$r_p$，使得该组合对于所有因子的载荷均为0，得到该组合的权重。
$$\tilde{r_p}=\sum_{i=1}^Nw_i \tilde r_i=\\ \sum_{i=1}^N w_i\bar r_i+(\sum_{i=1}^Nw_i\beta_{i,1})\tilde{f_1}+...+(\sum_{i=1}^Nw_i\beta_{i,K})\tilde{f_K}+\sum_{i=1}^Nw_i\tilde{\varepsilon_i}$$要求对所有因子的 $loading$ 都等于0，可得$K$个方程，$N$个未知数，因此该方程是一定有解的，虽然不一定有唯一解，但是只要有解就可以。找出以一组解就可使得对所有因子的载荷为0。该组合可以写为：
$$\tilde{r_{p_0}}=\sum_{i=1}^N w_{0,i}\bar r_i+\sum_{i=1}^N w_{0,i}\tilde{\varepsilon_i}$$但是这玩意不是一个无风险的东西。因子风险消除掉之后，还存在残差的风险。可以计算一下这个组合的方差是多少：
$\sigma^2(\tilde{r_{p_0}})=(w^2_{0,1}+w^2_{0,2}+...+w^2_{0,N})\sigma^2_\varepsilon$.
当$N$特别大的时候，每个权重为$\frac{1}{N}$。所以，上式的量级为：
$\underset{{n \to \infty}}{lim}=(\frac{1}{N})^2\times N\times \sigma^2_\varepsilon=0$.
当N的数量越来越大的时候，$\tilde{r_{p_0}}$的方差越来越小。此时，它就近似于一个无风险资产了，所以存在一个概念为极限套利。
$$\tilde{r_{p_0}}\approx\ \sum_{i=1}^N w_{0,i}\bar r_i=r_f$$所以上式就和之前的式子一样，将资产的期望回报与无风险利率联系起来了。

当然，也可以将上述的资产的持有比例进行调节，使得资产的回报率对因子1的载荷为1，而其他因子的载荷为0。
所以可以构建$K$个因子组合，各个因子组合分别对$1-K$个因子的载荷为1，这些因子组合就给出了每个因子的风险溢价。
最后，类似的：
$$\bar r_i=r_f+\sum_{k=1}^K\beta_{i,k}\lambda_k$$.其中，$\lambda_k$是$k$这个因子组合给出的风险溢价。
所以上式给出了期望回报率的表达式，任何一个资产的期望回报率都是$K$个因子的线性关系式，即$K$个因子的加权平均。
所以这个形式就告诉你，只要市场是无套利的，把因子用线性的方式加起来来解释你的期望回报率是对的。

上述是将APT的理论介绍完了，下面对其进行评论：
(1)APT给出了一个解释资产期望回报率的一个非常灵活的框架。没有具体的说因子是什么，也没说如何去找那些因子。这话反过来说，你找什么因子，只要你的故事讲得通都可以。这个东西出来后，大家就开始疯狂的找因子了，你有市场组合，尤金法玛搞出了三因子模型，别的人可以添加别的因子。
(2)从推导过程中可知，APT模型告诉我们，市场中系统性风险的来源不仅仅是来自于市场组合或是总禀赋，还有一些其他的来源，只要这些来源能够影响到你的总消费，影响到消费者必须承担的系统性风险，就会在资产的期望回报率里面会有一块风险的补偿。其实对于K个不确定性来源(因子)都在期望回报率中给出了补偿。你要承担这些风险就必须给你补偿。补偿的数量是这个资产对这个因子的风险暴露乘以这个因子对应的风险价格(就是这个因子组合的超额回报率)。
(3)这些因子是可以被观测到的，比如三因子模型中提出的那两个。还有一些因子可能是你观测不到的，比如你知道这些资产中有个共同的因素在影响资产的价格，但是你观测不到，这种因子叫做潜在因子(latent factor)，当让不能通过线性回归来估计，可能用别的方法来估计。

当然，这个东西出来之后大家可以去尝试，用GDP，PMI，CPI，上证综指等一系列数据去拟合当期的资产(股票)的回报率，而且经常性的会发现拟合优度相当的好，拟合优度甚至可以达到0.9。但是，千万不要用这种方式来指导未来选股和炒股。一般情况下用观测值来解释样本内的同期数据解释力都很强。但是，用观测到的因子变量去解释未来股票的价格，你会发现这样的预测的拟合优度会大幅下降至0.2，当然，0.2都算很不错的拟合优度了。
金融和计量里面经常碰到这些问题，同期测试的拟合优度都很高，但是用来预测未来，拟合优度就非常的低。即，你可以通过数据挖掘找到非常有价值的信息，但是依靠这些信息绝大部分时间都是挣不到钱的。

介绍一下APT能拿来干什么？
(1)对冲：
在多因子模型中实现$\alpha$和$\beta$的分离。
假设这是一个资产拟合出来的一个方程：
$$\tilde{r_0}-r_f=\alpha_0+\sum_{n=1}^N\beta_{n}\tilde{r_n}+\tilde{\varepsilon_0}$$其中，这$N$个因子我选择的是其他的资产，其实我是在用$N$种资产的回报率来解释第$0$种资产的回报率。
假设这$N$种资产在市场上都可以买到，且都是可以交易的。那么上式中求和的部分可以视为一个组合。按照$\beta_n$为权重去买这些资产，就形成了一个组合。这个组合可以用来对冲掉$r_0$中的系统性风险。这个$r_0$的风险来自于两块，一块是来自于由因子所共同构成的一种系统性的风险，一块是个体性风险。用所构成的组合将$r_0$中的风险给对冲掉，如果说$\alpha_0$是大于零的，且$\tilde{\varepsilon_0}$比较小。你买入一个$r_0$，买出一个组合，就可以得到一个$\alpha_0+\tilde{\varepsilon_0}$的回报。你就把资产组合的$\alpha$给分离出来了。分离出来之后，就可以将$\alpha$加入到别的资产中去，增加别的资产的回报率。
(2)因子选股
每个因子代表了对资产解释的一个角度，比如PMI(采购经理人指数)。不同的资产对PMI这个宏观因子的暴露程度是不一样的。或者说，不同的资产对PMI的敏感度是不一样的。所以这个时候，你预期某个时期PMI很好，这个时候，你就应该买那些对PMI风险暴露度比较大的股票，或是做空那些对PMI暴露度较小的股票。但是PMI时涨时跌，所以不算是特别好的因子。如果能够发现一个因子，对其暴露度高的股票持续的跑赢对其暴露度低的股票，你就可以获得持续的收益了。
假设一个例子：
见书上的市值因子的例子

(3)统计套利：
$$\tilde{r_0}-r_f=\alpha_0+\sum_{n=1}^N\beta_{n}\tilde{f_n}+\tilde{\varepsilon_0}$$就是说用一些可以观测的指标去解释各个资产的回报率。所以每个模型就可以给出一个拟合值，这个拟合值就是根据历史经验这只股票应该涨多快。你发现在过去几个月中，涨的速度比你预期的速度要低，所以你估计他会向均值回归，所以未来会涨的比较快，所以你就买入这些股票。反之，如果前几个月涨的速度太快，意味着接下来速度会变慢，所以卖出或是做空这些股票。
所以说，通过因子模型估计每一种股票的平均的回报率，所以比价现在的回报率和平均的回报率的高低，相信其均值回归的力量会发生作用，过去涨的慢的股票未来会涨的快，过去涨的快的股票未来会涨的慢，上述套利方式称之为统计套利。(Statistic Arbitrage)。但是我们需要强调一点，统计套利不是套利，均值回归的力量不是一定会发生的，是不一定的。

APT和我们未来要讲的无套利分析存在差别，与CAPM有点类似。所以呢，他就是均衡定价和无套利定价之间的一个过渡。从中也是可以看出来套利的思想。APT可以作为CAPM的一个总结，即系统性风险不仅仅来源于市场组合，有其他的风险来源，这些风险来源都会在资产价格里面形成风险溢价的补偿。APT是一个对单因子模型的一个扩展，但是其中没有消费者优化问题和市场出清，也没有求解均衡。仅仅就是用到无套利这一个条件。以后讨论资产定价时，就只使用无套利这个基本假设，属于相对定价。

##第十四讲：
上节课的APT并没有很好地体现出无套利的精神来，但是在未来的几讲中将体现出无套利的定价分析，或者说称之为金融工程，即衍生品的定价。
相较于一般均衡来说，无套利定价这套东西比较利索，能告诉你一个金融衍生品的价格到底是多少。

但是套利定价是否太过直接，失去了一些韵味呢？这也是可以讨论的。
介绍基本的概念：
远期：forward 
远期合约：签个合同，一年后，一瓶水卖给你，但是现在签合同的时候不交割，到了约定的期限后，在进行一手交钱一手交货。

远期的出现是有现实基础的，比如农民种粮食，现在种下去，到秋天收获，收入在秋天实现。但是粮食的价格在不停的波动，价格涨赚了，价格跌亏了。在此之中承受着粮食变动的风险。与此同时，粮食收购者买小麦做面粉，但是现在不知道小麦价格是多少，要是小麦价格高，亏钱，小麦价格低，赚钱。双方均有动力去消除这个风险。农民和收购者签订远期合约，把未来小麦的数量和价格均定下来，双方心理都有底了。不管价格变动，我们都按这个价格交易，双方都消除了风险。这个过程中，通过远期协议的签订，双方均减少了其风险，得到了效用的最大化。所以衍生品的存在是有价值的。

在中国市场中，衍生品还不够成熟：有期货，期权。金融衍生品确实闯了祸，但是也是现实经济发展的一个需要。
远期合约存在一个问题：你签了远期合约之后，你只能持有到期，你必须履约，不可以违约，没有什么灵活性。还有一个问题是远期合约如果有一方不履约，你也拿他没有办法。
之后发展成一个标准的远期合约称之为期货。

期货：futures
标准的远期合约：
约定什么资产，什么价格，什么时间进行交货，且在交易所交易。由交易所作双方的对手方。远期合约是农户和收购者之间签订远期合约，但是期货是你和期货交易所签订合约。比如你买一个小麦期货合约，你不是和卖家和买家签合约，而是和期货交易所签合约。由期货交易所与所有人签合约，然后由期货交易所保证所有条约的履约。这样即实现了一个标准化的合约，同时也保证了条约的履约。实现了合约流动性的创造。比如买个期货，三个月后买入小麦，没到期之前，你都可以把合约卖掉，这样到期时就不用真正的买入小麦。随时买卖期货合约，这样就保证了灵活性。

问题是：期货的价格是怎么被定出来的?
$Assumptions：$
标的物：交割的标的是不产生收入的。(铁矿石)
现货价格($spot\ price$)：$S_0$
远期价格($forward\ price$)：$F_0$ 现在为未来交易订立的价格(derivative)
$Risk-Free \ rate(continuous)$：$r$

现在的问题是：
现货价格和远期价格之间的关系问题：
我们来想：
$F_0=S_0 e^{rt}$
假设不是这样，若$F_0>S_0 e^{rt}$，即远期价格比较高，我以$F_0$的价格签订远期合约，在未来$t$卖掉这个标的。并且借入$S _0$的资金买入铁矿石堆在那。期货到期时，我以$F_0$卖出这个铁矿石，转手偿还借款和利息，且$F_0>S_0 e^{rt}$，实现无风险套利。类似的$F_0<S_0 e^{rt}$，分析方法一样。

衍生品是一纸金融合约，是基于一些现有资产形成的一种金融合约。所以它和一些现有的商品不是同一回事，但是有关系。无套利定价的任务就是基于已经给出来的底层资产价格，去推导出这一底层资产衍生出来的资产价格。推导方式就是，他们之间的价格必然满足特定的关系，如果不满足就一定会构造出套利的机会来大肆赚钱。市场是不会给你这么一个大肆赚钱的机会的，所以市场最后一定会是无套利的，所以无套利一定会使衍生品价格与我们的底层资产之间存在一种确定的数量关系。

下面我们还要讲一个问题：
现货价格：现在交易的商品价格(底层商品的价格)铁矿石现在的价格$S_0$
远期价格：$F_0$：现在签一个远期合约，三个月后要以远期价格买入铁矿石要多少钱
预期的未来的现货价格($E(S_T)$)：站在现在时点上，我预期三个月后铁矿石的现货价格是多少

现在的问题是：远期价格$F_0$和预期的未来的现货价格$E(S_T)$是什么关系。
$F_0=E(S_T)$这个等式正确吗？
显然，不正确。因为对于期货合约来说，我在现在签订的三个月的铁矿石价格是确定的$F_0$，不管三个月后发生什么，铁矿石价格就是$F_0$。但是，我预期三个月后的铁矿石价格是一个有不确定的价格，万一三个月后铁矿石价格变动，我买铁矿石的价格也就跟着波动。
所以说，确定的东西和不确定的东西之间存在着一个风险溢价。
假设，三个月后，我需要为我的工厂准备100吨螺纹钢：
获得这100吨螺纹钢有两种方法：
(1)签一个期货合约$F_0$，确定的知道未来以$F_0$的价格买入一单位的商品。上述东西是站在现在决策的，这个决策在未来付出成本为$F_0$是确定的，无风险的。所以这个成本的现值是使用无风险利率去贴现，为$F_0e^{-rT}$。
(2)等到三个月后，我在现货市场上买入这个商品。此时商品价格为$S_T$，显然$S_T$我是不知道的，所以我对三个月后的价格有一个预期为$E(S_T)$。但是这笔钱是不确定的，所以将这笔钱贴现到现在是不能用无风险利率的，用一个与无风险利率相异的贴现因子，为$E(S_T)^e{-kT}$。
对于这两种方式来说，如果要以无套利分析的化，应该是这两个等式相等：$F_0e^{-rT}=E(S_T)e^{-kT} \longrightarrow F_0=E(S_T)e^{(r-k)T}$。所以只有$r=k$时，对未来的现货价格贴现使用的是无风险利率的时候，远期价格才会等于预期的未来的价格。什么时候会选择无风险利率作为贴现因子呢?
当$\beta=0$时，这个组合或者说现金流与市场组合的相关性为0，此时$k=r$，远期价格和我预期的未来的现货价格是相等的。但是一般情况下，$\beta$不等于零，所以远期价格和我预期的未来的现货价格不一定是相等的，中间差了一个风险溢价。

理一下下述问题：
远期价格=市场对于未来的现货价格的预期
但是显然是在错误的，二者之间差了一个风险溢价，一般情况下这个风险溢价不等于0。

但是还要注意一点：
远期价格确实也**代表了**对未来现货价格的预期，尽管它并**不等于**未来现货价格的预期。
虽然$F_0\ne E(S_T)$，但是这二者是存在联系的，这个联系体现在$F_0=E(S_T)e^{(r-k)T}$。我在签订远期合约设定远期价格的时候，我一定是基于对未来现货价格的预期来签订这个期货合约，并定下这个远期价格。所以，远期价格里面包含着对未来现货价格的预期。
同样，现货价格同样包含着对未来现货价格的预期。打个比方说，假设我预期三个月后的螺纹钢价格为10000元/吨，我现在无论如何不会接受3000元/吨的螺纹钢价格。但是我预期三个月后螺纹钢价格为1000元/吨，现在能卖出2000元/吨的螺纹钢我就很开心了。
所以说，现货价格中也包含着对未来现货价格的预期来做得交易。

指出这一点是因为：
远期价格是不是反映了对未来现货价格的预期？是的。如果是，那么为什么远期价格和现在的现货价格存在一个精确的数量关系：$F_0=S_0 e^{rt}$呢？显然，现在的现货价格同样也包含着对未来现货价格的预期。
故：
$F_0，S_0|I$，即远期价格和现货价格都是基于同一个、现在的信息集(包括现在对未来现货价格的预期)来形成的价格。

远期定价就是上面的部分了。

下面进入一个比较复杂的产品定价，期权(Option):
期权是一种权利而非义务，给你一个权利，你可以不用。
比如：
欧式买入期权：(European Call)
欧式：在确定的到期日(maturity date).即行权日才可以执行权利的期权，你只能在这个时点上选择是否执行这个权利，不执行就作废了。
行权价格：exercise price K
underlying asset：标的资产
买入：买入某个资产的权利=(看涨期权)
卖出：Put：卖出某个资产的权利(你可卖也可不卖)=(看跌期权)

美式期权(American Options)：
从签订日开始到到期日结束的这段时间里面，你可以随时选择是否行使期权给你的权利。所以说，美式期权可以永远当成欧式期权来使用，大不了到行权日在实施权利，所以说美式期权的价格至少不低于欧式期权。

美式和欧式期权合起来称之为普通期权(Plain vanilla Options)
奇异期权(Exotic Options)



欧式买入期权(European Call)的payoff图像：

横轴为股票价格$S_T$，纵轴为Payoff，在横轴上标记行权价格K。
在行权价格之前的Payoff为0，而当股票价格大于行权价格时，期权的payoff为$S_T-K$。
当然期权不是白给你的，你是要花钱去买的，假设期权的成本为$c$，把期权的成本考虑进去之后，期权的profit曲线为：在行权价格之前的profit为$-c$，而当股票价格大于行权价格时，期权的profit为$S_T-K-c$，所以想要利润大于零，就需要股票的价格大于$K+c$。

类似的，可以画出一个卖出期权的payoff图像：

横轴为股票价格$S_T$，纵轴为Payoff，在横轴上标记行权价格K。
在股票价格高于行权价格时，你不会以低于市场价的价格去卖出一只股票。所以在行权价格之后的Payoff为0，而当股票价格小于行权价格时，期权的payoff为$K-S_T$。
反之，考虑profit的时候需要考虑期权的价格，然后调整payoff的图像位置。

上述的图像是期权的多头，也就是说我买入期权后，期权带给我的payoff。假设我是一个卖出期权的人，即空头，我的payoff是什么样的状况。
期权的多头，即买入一个期权:
这个的payoff为$max \ \{S_T-K,0\}$
期权的空头，即卖出一个期权：
这个的payoff为$min \ \{K-S_T,0\}$
将上述的空头和多头的payoff图像合并起来可以看出，其两者的payoff均为0。
买卖期权这个事情本身来说，就是一个零和博弈(Zero-Sum game)，一方赚的就是另一方亏的。但是它又不是赌博，一般来说如果利用期权做套期保值(hedge)，我在其他市场上存在资产的风险，我就用期权来对冲风险。若果期权亏了，我会在现货市场上赚回来，那这就不是赌博，这叫做套期保值。期权是作为一个交易的一部分而存在的，期权的交易正好能和其他交易抵消掉。期权的功能就是帮你消除风险。

但是如果你不是套期保值，而是投机。寄希望于通过买卖期权来挣钱，那就是在赌博。

$Put-Call\ Parity$期权买卖权平价
以欧式期权为例：

$call$的价格与 $put$的价格是存在一定关系的：
假设这么一种情况：
我花$c$元去购买一个看涨期权($Call$)，且它的行权价格为$K$，在到期日$T$时，我有一个权利以$K$的价格买入一只股票。
假设我要为以后的行权准备一笔钱。为了在未来能得到$K$，我现在只要准备$Ke^{-rT}$的钱。
所以说，当我手里有一个$call$和现金$Ke^{-rT}$时，这个组合的$payoff$ 为 $max \ \{S_T,K\}$
此时，上述这个组合的价格为：$c+Ke^{-rT}$

假设还存在另外一个组合:
我花$p$元去购买一个看跌期权($Put$)，，且行权价为$K$，以及一只股票$S_0$。等到期权到期的时候，如果股票价格高于行权价格，你就持有这一只股票。如果股票价格低于行权价格，你就卖出股票，获得收益。此时，这个组合的$payoff$ 也为 $max \ \{S_T,K\}$
此时，上述这个组合的价格为：$p+S_0$

因为这两个组合的未来payoff都是一样的，所以两者现在的价格均相等，即：$c+Ke^{-rT}=p+S_0$。这里将期权的买权和卖权联系起来了。这个关系式就叫做$Put-Call\ Parity$。

有同学会问，都有了期货了，干嘛还需要期权呢？
注意一点：对于期权来说，它的payoff曲线不是一个线性的曲线，而是一个非线性的曲线。由于存在非线性的性质，就可以构造出非常好玩的东西出来。
比如构造蝶式价差：

假设买入两个$Call$，行权价格分别为：$K-\varepsilon$和$K+\varepsilon$。所以这两个期权的Payoff为：

以股票价格为横轴，以$Payoff$为纵轴的坐标系内，在$0-K-\varepsilon$的区间上第一个$Call$期权的$Payoff$曲线为直线，在超过$K-\varepsilon$后变成一条向上倾斜的直线。同理，另一个$Call$期权的$Payoff$图像类似。
但这个组合还有另外2个$Call$期权的空头，且以$K$为行权价。

所以这个组合总的行权的$Payoff$为：
以股票价格为横轴，以$Payoff$为纵轴的坐标系内，小于$K-\varepsilon$的地方的Payoff为0，到$K-\varepsilon$至$K$的范围中，只有一只以$K-\varepsilon$为行权价格的期权存在payoff，所以整体的payoff就上去了；在$K$至$K+\varepsilon$的范围中，虽然有正的payoff，但是存在两个Call的空头，使得整体的Payoff下降为0，；到$K+\varepsilon$至$+\infty$的范围中，整体的payoff就又变成0了。

上述就是这个组合的payoff，这种组合叫做蝶式价差(Butterfly)的支付。现在考虑当$\varepsilon$趋于无穷小的时候，该组合就只在$K$处存在支付，因此蝶式价差就如同一个阿罗证券(Arrow Security)。所以用蝶式价差可以构造出一个阿罗证券出来。

所以期权意义何在？我们前面说市场一定要是完备的，只有完备的市场才能达成风险的最优分散。但是市场可能经常是不完备的，因为没有那么多在不同状态下有支付的资产存在在市场上面。但是没有关系，只要期权存在，我就可以用期权来构造出阿罗证券来，构造出各个状态下的阿罗证券来，我就实现了市场的完备化。

所以一个不完备的市场，引入期权就会变成一个完备市场。当然还是存在一定的前提条件的，但是基本的idea就是如上述的那样。因为期权的payoff是一个非线性的资产之后，我就可以让市场变得完备。

其次，在具体交易的时候，如果我们看涨股票，且只有股票一种资产可以交易的时候，我们只能买入一只股票。假设一个人认为股票能涨到10块钱，另一个人觉得股票能涨到20块钱。他们都去购买股票，且真的涨到了10块钱了，没有涨到20块钱。那么这个认为股票涨到10块钱的人和另一个人的收益是一样多的。

但是，如果存在期权就可以挣的不一样多。因为人们可以把对未来的不同的预期通过购买期权来表达出来：预期股票价格为10元的人和预期股票价格为20元的人所做的操作是不一样的，所以其获得的收益也是不一样的。


更为重要的是看这个衍生品是如何定价的：
此时，进入正题：定价

框架：两期模型：未来的$payoff$：
$Stock：$
在1期两种状态下的支付为：$uS_0$和$dS_0$.

$Bond$(无风险债券)：
在1期的支付为：$e^r$

$Derivative：$
在1期两种状态下的支付为$C_u$和$C_d$.

所以支付矩阵可以写为：
$\begin{bmatrix}
 uS_0 & e^r & C_u \\
 dS_0 & e^r & C_d
\end{bmatrix}$

假设处于0时期，股票的价格为$S_0$，债券的价格为$1$，衍生品的价格为$C_0$。且在未来两种情况发生的可能性分别为：$p$和$1-p$。假设上述所有东西的价格我们都知道，但是仅仅一个东西我们不知道，就是期权价格$C_0$。


关于上述问题我们要做几点说明：
(1)关于股票价格变动，我们是在原来的股票价格前面乘以一个数$u$和$d$，且$u$和$d$均大于零。为什么不是加上一个数或是减去一个数？因为如果这么写的话，股票价格有可能为负数。所以用乘以一个正数使得股票价格发生变化。(补一句：几何布朗运动对应的是乘性因子，布朗运动对应的是加性因子)

(2)$C_u$和$C_d$我们是知道的，但是具体的形式不知道。你可以将$C_u$和$C_d$表示为$max \ \{uS_0-K,0\}$和$max \ \{dS_0-K,0\}$，上述定价方式就是给一个$Call$定价，当然其他的表达式就是给其他的衍生品定价。所以，在这个模型中是一个非常宽泛的某个衍生品的价格。

但是，在$C_u$和$C_d$没有给出具体形式的话，如何说这个衍生品是股票的衍生品？因为它和股票价格没有联系呀。衍生品的中“衍生”的含义如何体现？
衍生品中的衍生体现在，当我知道股票价格$uS_0$或$dS_0$时，我就知道衍生品的价格$C_u$还是$C_d$。虽然$C_u$和$C_d$具体是什么我不知道，但是我可以告诉你，只要股票价格是哪种情况，衍生品就是哪种情况。换句话说，股票的价格信息会增加我对衍生品支付的了解。即，对我来说，知不知道股票价格，我来判断衍生品的payoff是不一样的。假设不知道股票价格，我只能说衍生品价格有可能为$C_u$，或者是$C_d$。但是，一旦给出股票价格，我就告诉你衍生品价格为$C_u$，至于具体形式，我们不管他。这种基于股票信息能够帮我们更加了解衍生品的支付，这种东西是衍生品衍生二字的具体体现。

现在的问题是：$C_0$怎么定出来？

$Method \ 1：APT$
弄一堆风险资产，构建一个组合，把这个组合的风险给消除掉，这个组合就变成了无风险组合，无风险组合的回报率就是无风险利率。

我现在有股票和衍生品两种风险资产，用其构建出一个风险资产组合，来把风险消除掉，然后这个组合的收益率等于无风险利率，然后将衍生品价格求解出来。

操作：
构造组合：$(Derivative,Stock)(1,-\Delta)$
组合在0期的价格为$\pi_0=C_0-\Delta S_0$
组合在1期的价格为$\pi_u=C_u-\Delta uS_0$；$\pi_d=C_d-\Delta dS_0$
选择组合中的$\Delta$使得组合是没有风险的。
也就是说在1期如果存在：$\pi_u=\pi_d$ 的时候，组合是没有风险的。即：
$C_0-\Delta S_0=C_u-\Delta uS_0\longrightarrow \Delta=\frac{C_u-C_d}{(u-d)S_0}$.
将上述等式带回到原来的$payoff$中可得：

$$\pi_0=C_0-\frac{C_u-C_d}{u-d}=\frac{(u-d)C_0-C_u+C_d}{u-d}\\\pi_u=C_u-\frac{uC_u-uC_d}{u-d}$$因为这是一个无风险组合，所以一定有：
$$\pi_0e^{r}=\pi_u\\C_0=e^{-r}[\frac{e^r-d}{u-d}C_u+\frac{u-e^r}{u-d}C_d]$$

$Method \ 2：$
在第一种方法中，我们实质上是使用股票和衍生品两种风险资产构造出了无风险组合。之所以可能是因为上述的支付矩阵所代表的市场是一个完备市场(两个状态)。既然是完备市场，就有一个资产是多出来了，那么就可以通过其他两个资产将另一个资产表示出来。这个地方我是用股票和衍生品复制$Bond$。类似的，我们可以用股票和$Bond$来复制衍生品。
通过组合$(Stock,Bond)(\Delta,B)$来复制衍生品。换句话说，这个组合的payoff要等于衍生品的payoff，该如何构建？
$C_u=\Delta uS_0+Be^r$在u状态下衍生品支付等于该组合在u状态下的支付。
$C_d=\Delta dS_0+Be^r$在d状态下衍生品支付等于该组合在d状态下的支付。求解上述二元一次方程组可得：
$\Delta=\frac{C_u-C_d}{(u-d)S_0}；B=\frac{uC_d-dC_u}{e^r(u-d)}$
在这样的组合的选择下。即，$\Delta$和$B$的选择下，这个组合就复制了衍生品在时期1时的支付，换句话说，如果这个市场不存在套利的情况下，该组合在0期的价格与衍生品在0期的价格相等，所以有：$$\Delta S_0+B=C_0 \\ C_0=e^{-r}[\frac{e^r-d}{u-d}C_u+\frac{u-e^r}{u-d}C_d]$$.
换句话说，上述两个方式都是使用两个资产来复制另外一个资产的在1期的payoff，从而根据市场的无套利得到组合价格与另外一个资产的价格相等，从而推导出衍生品的价格。
有意思的是：上面这个衍生品的定价式中
$$C_0=e^{-r}[\frac{e^r-d}{u-d}C_u+\frac{u-e^r}{u-d}C_d]$$.$C_u$这一项前面的系数为$\frac{e^r-d}{u-d}$，$C_d$这一项前面的系数为$\frac{u-e^r}{u-d}$，二者相加的和为1。所以说：衍生品的价格等于衍生品在1期不同情况下的支付的加权平均和，然后再以无风险利率进行贴现，所得到的价格水平。而且这个权重之和为1。那么什么权重为1？概率的权重为1。所以说，可以将上式改写成衍生品未来payoff的期望的帖限值，即：
$$C_0=e^{-r}E^Q[\tilde{C}]$$，只不过这个期望计算时所用的概率并非是现实世界的概率$p$，而是另外一个不知道什么东西的概率。这个概率不是现实世界的概率，而是风险中性世界中的期望，所以用$E^Q$作为区分。


$Method \ 3：$
假想一个世界，这个世界中和现实世界的资产世界一样，即资产的payoff是一样的。只不过这个世界中，各个资产在1期发生不同情况的概率是不一样的。比如称之为$q$。状态$u$发生的概率为$q$，状态$d$发生的概率为$1-q$。

所以支付矩阵可以写为：
$\begin{bmatrix}
 uS_0 & e^r & C_u & q\\
 dS_0 & e^r & C_d & 1-q
\end{bmatrix}$

并且那个世界还有一个重要的特性就是说，那个世界中的所有的人都是风险中性的，换句话说，所有人都不care风险。既然所有人都不在乎风险，那么那个世界中所有人给所有资产定的价格就是那个资产未来期望的支付用无风险利率进行贴现。
此时，0期股票价格为：
$S_0=e^{-r}[quS_0+(1-q)dS_0]\\ q=\frac{e^r-d}{u-d}；1-q=\frac{u-e^r}{u-d}$；
此时，衍生品的价格为：
$C_0=e^{-r}E^Q[\tilde{C}]\\=e^{-r}[qC_u+(1-q)C_d]\\=e^{-r}[\frac{e^r-d}{u-d}C_u+\frac{u-e^r}{u-d}C_d]$

(1)事实上，我们无套利定价的核心内容就是来解释为什么第三种方法是对的。因为所有的衍生品定价，所有的资产定价都是用第三种方法来做的，因为第三种方法太简单了，用股票的价格把风险中性的概率$q$计算出来后，再用风险中性概率$q$去算任何一个资产未来的期望支付，再用无风险利率去贴现，就是它现在的价格。
而解释这玩意为什么对的，就是整个无风险定价地基础。即告诉你这样做是对的，为什么可以这样做。


(2)再看看衍生品定价的公式：$C_0=e^{-r}[\frac{e^r-d}{u-d}C_u+\frac{u-e^r}{u-d}C_d]$，你在其中看见了$p$了吗？真实世界股票上涨和下降发生的概率没有体现。那是否说明，真实世界中股票价格上升与下降的概率$p$对衍生品价格是没有影响的呢?其实也不是，虽然没有看见$p$，但是$p$决定了$u$和$d$，就股票价格未来会涨到$uS_0$和$dS_0$，所以你给出股票价格为$S_0$，股票价格给出是依据股票价格上涨和下降的概率$p$和$1-p$，才能给出$S_0$，虽然$S_0$被约掉，但是其还是体现在$u$和$d$之中。所以说，当$p$发生变动时，随之会带来$u$和$d$的变化，虽然没有直接看到$p$，但是通过$u$和$d$的变化间接的进入到你的衍生品定价方程中。所以说真实世界中的概率$p$对衍生品是有影响的，只是你看不见而已，间接隐含到$u$和$d$之中。

(3)在第二种方法中，我们用股票和债券来复制衍生品，给出了衍生品的价格。但是我们这种方法也同样搞出了一个对冲衍生品的方法。就是假设你卖出一个Call，如果这只股票一直疯狂的往上涨，那这个人就会亏死了，怎么办呢？你就复制一个这个Call的多头，把空头对冲掉就完了。怎么去复制呢，就用股票和债券复制就完了。
所以说，这个复制衍生品推出衍生品价格的方法，同时也给出了对冲衍生品的方法。给出了hedge的方法。

(4)对于$\Delta=\frac{C_u-C_d}{(u-d)S_0}$进行讨论，到底$\Delta$是什么?仔细看的话，$\Delta$是一个导数，这个导数是衍生品价格的变化除以底层资产价格的变化。所以$\Delta=\frac{dC}{dS}$是这个衍生品的价格相对底层资产价格变化的敏感性。如果一个组合的$\Delta$等于0，那就意味着这个组合在底层资产价格发生变化的时候它也不发生变化，这个组合就是一个无风险的组合。此时，再回过头来看第一种方法里面，用衍生品和股票构造了一个组合，这个组合的$\Delta$为0，所以组合的价值不因股票价格的变化而变化，所以$\pi_u=\pi_d$，所以组合被调为$\Delta=0$，你就使得这个组合的价值对于底层资产的价格变化免疫了，不因股票价格的变化而影响到你组合的变化。所以这种调法称之为$Delta\ Hedge$。我通过选择股票和衍生品的数量把一个组合的$\Delta$调成0，调成0之后，我可以让组合能够免疫于股票价格的变动，而使它价值不变，这样就消除掉整个组合的风险，当然这只是一种消除的方法，后面还会讲很多，比如一堆希腊字母。这是一种常用的对冲方法。

这里的三种定价方法，只是将无套利定价的一个引子，后续的课程会逐渐的将无套利定价的整个理论体系逐渐建立，期待着后续的课程吧。



##第十五讲：

上节课给出了一个引子，讲述了单期二叉树中风险中性定价的一个简单的例子。给出了对于衍生品的三种定价方法，其中前两种是类似的，就是利用两种资产来复制第三种资产，进而求解衍生品价格。第一种方法是用股票和衍生品来复制无风险资产，第二种方式是用股票和债券来复制衍生品。前面的两种方法都是比较容易理解的，无非就是复制资产。但是第三种方法比较难以理解，假设所有投资者都是风险中性的，所以在资产定价的时候是不需要风险溢价的，不需要对资产的风险做补偿。所以说他对资产定价就是资产未来的期望回报然后还要折现，人虽是风险中性的，但是人还是不耐心的。既然不耐心，那么资金还是存在时间价值的。所以说风险中性的人会计算资产的期望回报并且将资金贴现到现在作为其对资产的定价。用这么一个假设我们使用股票计算出一个风险中性概率，用这个概率求解了衍生品的期望回报，再用无风险利率贴现就出来了。但是为什么可以这么假设？为什么可以假设投资者风险中性？
上半学期以来，我们一直讲这个均衡定价的时候，我们一个非常核心的主线就是对风险的定价，所以我们讨论很多人在不确定情况下的行为理论，他的风险规避度的衡量，然后在不同风险规避度下的行为，然后给出资产价格。结果到这里，突然告诉你我们在定价的时候假设人们是风险中性的，那么上半学期学习的东西相当于白学了。
第二个就是我们计算的风险中性概率到底是什么东西，与现实世界中的概率存在什么关系？为什么我可以在所谓的风险中性的世界中计算一个期望就把现实世界的资产价格给定出来了。

这节课的目的就是要告诉你们，为什么上节课的第三种方法是正确的，是可以被使用的。之后，我们再计算衍生品价格时，就直接计算风险中性概率，然后在风险中性的世界中求解资产收益的期望，给出资产价格。之后我们给出布莱克斯科尔斯公式也是基于这个思想。

下面就给出无套利定价的基础，首先就用数学语言描述一下：
假设存在两期，在1期中对于资产市场来说，用数学语言描述就是支付矩阵$Payoff\ Matrix$，每一行代表一个状态，每一列代表一个资产。
$X=\begin{bmatrix}
 x_1^1 &  x_1^2  & \cdots  & x_1^J\\
 x_2^1&  x_2^2 & \cdots  & x_2^J\\
\vdots &  \vdots & \cdots  & \vdots\\
 x_S^1 &  x_S^2 & \cdots  &x_S^J
\end{bmatrix}$

既然有$J$种资产，那就意味着在0期存在$J$种价格，$P=[p_1,p_2,...,p_J]$。然后存在一个组合，可以记为$\theta=[\theta_1,\theta_2,...,\theta_J]^T$，对这$J$种资产的持有量，即对于$\theta_i$来说，其单位是资产的数量，不是钱。比如$\theta_1=1$意味着存在1单位资产$x_1$。
作为一个组合，它就有现在的价格和未来的$payoff$，它未来的$payoff$为：
$$X\ \theta=\begin{bmatrix}
\sum^J_{j=1}\theta_j\cdot x_1^j\\
\sum^J_{j=1}\theta_j\cdot x_2^j\\
 \vdots\\
\sum^J_{j=1}\theta_j\cdot x_S^j 
\end{bmatrix}$$

同时这个组合现在的价格为：
$$P\ \theta=\begin{bmatrix}
\sum^J_{j=1}\theta_j\cdot p_j\\
\sum^J_{j=1}\theta_j\cdot p_j\\
 \vdots\\
\sum^J_{j=1}\theta_j\cdot p_j 
\end{bmatrix}$$

之前我们一直用无套利的思想来给出资产的定价，所以在这里我们要严格的给出套利的定义:
套利：定义15.1：$Arbitrage$
(1)$P\ \theta\le 0$
(2)$X\ \theta\ge 0$
(3)$At\ least\ one \ strict \ inequality$

套利具体的是指一个组合，即市场中存在一个$\theta$组合，这个组合要满足上述(1)(2)两个条件，并且上述两个条件中有一个是严格不等号，即这两个不能同时取等号。对于这个数学的描述解释一下到底是什么意思。
对于这个定义可以讲出三中套利：
(1)$\ type \ 1：$
$P\ \theta < 0，X\ \theta=0$.
$X\ \theta$是一个向量，一个向量为0意味着这是一个零向量，即这个组合在未来是一个0支付。
而$P\ \theta < 0$是两个向量的乘积，换句话说就是乘出来一个数，代表了这个组合现在的价格。也就是说，在0期这个组合给你一笔钱，在未来他的收益是为0。所以说这就是白捡钱的机会，这就是一个套利。


(2)$\ type \ 2：$
$P\ \theta = 0，X\ \theta > 0$.
$X\ \theta$是一个向量，一个向量大于0，意味着这个向量中的$S$个元素中至少有一个大于0就可以了，并不要求其所有元素都大于0。
这个组合是什么意思呢？一个组合现在的价格为0，你随便可以拿到，不用付出任何代价。但是未来呢，他会给你带来正的支付，但是这种正的支付是不确定的，它不知道会在什么时候给你，但是这种不确定只是多或者少而已，它肯定不会让你亏钱。不会让你付出代价，但是在某些状态下还会带来正的支付。
所以说现在有一个不要钱的东西，未来还有可能带来正的支付，这就是一个套利。
所以说这两个不等式中只要有一个出现了严格不等号，那么就意味着说你发现了一个不需要任何成本就可以获利的方式。这就叫套利。

(3)$\ type \ 3：$
$P\ \theta < 0，X\ \theta > 0$.
也就是说，一个组合现在要给你钱，未来还是要给你钱，挡都挡不住的那种，显然这也是一个套利。

所以说上述的三个情况都是好事，所以是个人都会不断地寻找这种机会，所以这种机会一定是很难发掘的。结果就是市场中的套利机会就没有了(严格说没有了也不对，只能说很难找的到)。因此，假设市场不存在套利机会是对市场状况的一个非常贴近的描述。
既然市场中没有套利机会，那么就该想到套利和资产的价格以及payoff是密切相关的，如果市场中不存在套利机会，那么市场中的资产价格就因该满足某种特定的规律，这种特定规律就是我们马上要推导出来的无套利下的资产定价方程。

有关套利在多说几句：
(1)在套利的框架下，好像缺席了某个数据，即现实世界中不同情况发生的概率。因为套利机会发生与否和现实状态下各个情况发生的概率是无关的。正是因为这样没有用到真实世界的概率，所以我可以完全不在乎真实世界的概率，随便假设一个概率，甚至风险中性概率。
(2)给出三种套利的可能，这三种套利已经穷尽的所有套利的机会了。你可以想出各种套利，但是最终就会归结于这三种套利的某一种。
(3)无套利就是说这个市场中没有套利的机会了。没有这种捡钱的机会了，所以说套利是均衡的一个必要而非充分的条件。即市场如果是均衡的，那么市场一定是无套利的(均衡是所有人的效用都已经最大化了，不可能存在凭空给你资源的情况存在)；反之如果市场是无套利的，则不一定可以保证均衡(市场有可能不出清，供需有可能不相等)。

基于上述的条件，给出资产的价格

定义15.2
$state\ price\ vector$ 状态价格向量(就是阿罗证券的价格)
$\varphi=(\varphi_1,\varphi_2,...,\varphi_S)^T，\varphi_s>0，\forall s. \\ s.t.  \  \forall j，p_j=\sum_{s=1}^S\varphi_s x_s^j $

换句话说，状态价格向量就是一堆正数，这$S$个正数搞出来之后，市场中的任何一个资产，用这一堆状态价格向量里面的元素为权重，来对它未来各个状态下的支付做一个加权平均，就是这个资产现在的价格$p_j$。如果你可以找到这么一堆正数满足上述的条件，那么它就是一个状态价格向量。

其实这个形式在均衡定价中我们看到过，这个$\varphi_s$就是阿罗证券的价格。阿罗证券是只在特定情况下支付为1的证券，假设资产$j$在未来状态$s$的支付为$x_s^j$，用阿罗证券的价格乘以份额(因为这里阿罗证券在1期支付为1，份额等于资产$j$的支付)得到该资产现在的价格$p_j$。
所以综上，$\varphi_s$是阿罗证券的价格，故必须要求其为正数，不是正数就不对了，不符合我们的基本要求。往下，我们要证明一个定理，也是无套利定价的理论基础，这个定理叫做：**资产定价基本定理——$Fundamental\ Theorem\ of\ Asset\ Pricing$.**


$Fundamental\ Theorem\ of\ Asset\ Pricing$:
如果一个资产市场中没有套利机会$\\ \Longleftrightarrow $这个资产市场中一定存在一个状态价格向量，即：
$$No \ Arbitrage \Longleftrightarrow \exists \ \varphi $$.
当然反过来说也是成立的：如果你能找到一堆正数，使得其满足状态价格向量的要求，那么这个市场也一定是一个无套利市场。

这玩意的证明很复杂，但是证明的思路还是要说的，不然会有同学在未来使用到的时候心里会发虚。

为了证明这个定理，我们需要一个数学上的工具，当然这个数学上的工具也很重要，称之为超平面分离定理($Hyperspace\ Separation\ Theorem$)。

我在空间中(可以是任意维度的)，比如说是黑板上(二维)，任意的找两个分离的凸集$A$和$B$。(凸集：在集合中任找两个点，然后这两点做一根直线，如果这根直线上的所有点都还在集合之内，则称之为凸集)。你就可以切一刀(超平面)，将这两个凸集分开。
注：在二维平面上的超平面是一根直线。

这玩意用数学如何去描述它：

$\forall \ convex\ set \ A、B，A\cap B=\varnothing， \exists \ Liner\ function\ F(\cdot)\\ s.t. \ F(a)<F(b)，\forall a\in A，b \in B $

线性函数$F(\cdot)$存在一个性质：即$F(\mu x)=\mu F(x)，\mu \in R$
$f(x_1,x_2)=\alpha_1x_1+\alpha_2x_2；f(2x_1,2x_2)=2f(x_1,x_2)$.


下面我们用超平面分离定理来证明资产定价基本定理。从无套利证明存在状态价格向量。

$Proof：\Rightarrow $
构造两个集合：$$A=\{(-\sum_{j=1}^Jp_j\theta_j,\sum_{j=1}^Jx_1^j\theta_j,...,\sum_{j=1}^J x_S^j \theta_j)|\theta_j \in R,\\ \forall j=1,2,...,J \}$$

A集合中的元素是$S+1$维的向量，换句话说每个向量都有$S+1$个元素。
其中，向量的第一个元素是$\theta$这个组合它在0时刻的价格的负数($-price\ of\ \theta$)；后面这$S$个元素就是$\theta$这个资产组合在资产市场里面它未来的payoff($payoff \ of\ \theta$)

定义集合$B$，且集合$B$也包含$S+1$维的向量，向量里面每一个元素都是非负的。
$$B=\{(b_0,b_1,b_2,...,b_S)| b_i\ge 0，\forall i =0,1,...,S   \}$$

验证一下这两个集合是否为凸集？
即是否满足 $\forall\  a_1,a_2\in A， \alpha a_1+(1-\alpha)a_2\in A，0<\alpha<1$.
可以验证上述两个集合都是凸集。

那么我们可以得到当$N.A$成立的时候，$\rightarrow$ $A$与$B$的交集为：$A\cap B=\{0\}，\{0\}=(0,0,...,0)^T$.

反证法可知，如果$A$与$B$的交集不为零向量的话，对于集合$B$来说存在一个向量，其各元素均不为零，且至少存在一个元素大于零。而将这个条件带入$A$集合中可知，一旦出现这种情况就意味着出现了三种套利情况中的任何一个，即存在套利，矛盾。
所以说，$A\cap (B-\{0\})=\varnothing$，显然$A$为凸集，$B-\{0\}$也为凸集，就可以找到一个超平面，即
$$\exist \ F(x)=\alpha_0 x_0+\alpha_1x_1+...+\alpha_Sx_S\\s.t. \ F(a)<F(b)，\forall a\in A，b\in B-\{0\} $$

且对于$a\in A$，有$\mu a\in A$，对于$\mu \in R$均成立。则$Claim\ ：\forall \ a\in A，F(a)=0$.
反证法：如果 $\exist a_0\in A，s.t.\ F(a_0)>0，则\underset{\mu \to \infty}{lim}F(\mu a_0)=\underset{\mu \to \infty}{lim}\mu F(a_0)=+\infty$.推出矛盾。


对于 $\forall \ b \in B-\{0\}，F(b)>F(a)=0$.
$F(b)=\alpha_0 b_0+\alpha_1b_1+...+\alpha_Sb_S$
要使得上式对于任何的$b$都是大于零的，且$b_i$可以任选(取$b_0=1,b_1=0,b_2=0,...,b_S=0$)，就可以推出$\alpha_0,\alpha_1,...,\alpha_S$均大于零。

$$F(a)=0 \rightarrow -\alpha_0\sum_{j=1}^Jp_i\theta_j+\alpha_1\sum_{j=1}^Jx_1^j\theta_j+...+\alpha_S\sum_{j=1}^Jx_S^j\theta_j=0$$

对于上述的组合，我们可以选择不同的资产，比如就只单单选择第一种资产持有量为1，让其他资产均为0。
所以可以推出来，任给一个资产$j$存在：
$$\forall j，-\alpha_0p_j+\alpha_1x_1^j+...+\alpha_Sx_S^j=0 \longrightarrow \\ \alpha_0p_j=\alpha_1x_1^j+...+\alpha_Sx_S^j \longrightarrow \\ p_j=\sum_{s=1}^S\frac{\alpha_s}{\alpha_0}x_s^j$$

此前我们推出$\alpha_0,\alpha_1,...,\alpha_S$均大于零，因此，$\frac{\alpha_s}{\alpha_0}$就是状态价格向量，即为$\varphi_s$。
当然你可以说，对于$\frac{\alpha_s}{\alpha_0}$具体是什么形式我还不知道，但是可以说状态价格向量是正数且这个东西存在就可以了。

所以上述证明证明了其充分性，对于必要性其实比较好证明，也就是说当资产价格可以写为$p_j=\sum_{s=1}^S\frac{\alpha_s}{\alpha_0}x_s^j$时，就不存在上述的三种套利的情况，因此，市场就是无套利的。

所以，第一资产定价基本定理($1st\ FTAP$)
$$No \ Arbitrage \Longleftrightarrow \exists \ \varphi $$

无套利可以推出存在状态价格向量。

现在我们在引入第二资产定价基本定理($2nd\ FTAP$)：
$$Complete\ market，\ No \ Arbitrage \Longleftrightarrow \exists \ ！\varphi $$

在完备市场中，无套利可以推出存在**唯一**的状态价格向量。
因为我们假设处于完备市场中，所以最后得到的结论就是$Complete\ market，\ No \ Arbitrage \Longleftrightarrow \exists \ ！\varphi$。

所以以后只要提及完备市场和无套利，就相当于告诉我们存在唯一的状态价格向量，所谓状态价格向量可以将资产价格表示成为这样的形式，且所有资产价格均可以写成$p_j=\sum_{s=1}^S\varphi_s x_s^j$.

但是上述我们证明的一大堆和风险中性定价没有关系呀。别着急，关系来了。

假设无风险资产未来的payoff为1，也就是说无风险资产在未来各个状态下的支付均为1。而无风险资产现在的价格为未来payoff的折现，即$e^{-r}$，因此就存在这么一个等式：$e^{-r}=\sum_{s=1}^S\varphi_s\cdot 1$。所以无风险资产0时刻的价格就等于未来各个状态的状态价格之和。

现在我们就定义这个东西，对于任意一个状态$s$，存在一个$q_s$使得：$$q_s=\frac{\varphi_s}{\sum_{s=1}^S\varphi_s}=e^r \varphi_s$$


所有状态的$q_s$之和为1，且对于任意资产存在：
$$p=\sum_{s=1}^S\varphi_s x_s\\=e^{-r}\sum_{s=1}^Se^{r}\varphi_sx_s=e^{-r}\sum_{s=1}^Sq_sx_s\\=e^{r}E^Q(\tilde{x})$$

因为$q_s$之和为1，可以将其视之为概率。可以将$q_sx_s$写成期望的形式。只不过这不是用真实世界中的概率$p$计算的期望，而是用我定义出来的，在另外一个世界(风险中性世界)中的一个东西$q$所计算出来的期望。

风险中性世界和我们的现实世界的联系表现为：风险中性世界里面的资产支付矩阵和价格矩阵和现实世界是一样的。但它和现实世界不一样的是，各个状态发生的概率不是真实世界中发生的概率$p$，而是我定义出来的风险中性概率$q_s$。
所以说，根据上面的等式一路等过来：
$$p=\sum_{s=1}^S\varphi_s x_s=e^{-r}\sum_{s=1}^Se^{r}\varphi_sx_s=e^{-r}\sum_{s=1}^Sq_sx_s\\=e^{r}E^Q(\tilde{x})$$

对于真实世界中资产的定价$p$，就等于我们在风险中性世界下面，未来的支付算一个期望，并将未来的支付折现到现在。这就是为什么风险中性定价为什么可以这么做的原因。所以上述等式关键的一步在于第一个等号，为什么$p$可以等于这么一个玩意。所以我们前面证明了这么长的一个定理。


所以当告诉你在完备市场上不存在套利机会的时候，市场里面一定存在状态价格向量，使得可以把资产价格表示为这样的形式。然后能够表示被这样的形式，那就一定可以构造一个风险中性世界，使得资产的价格等于这个风险中性世界中这个资产未来支付的期望，用无风险利率贴现到现在。

所以我们在做风险中性定价就是无套利定价时候，具体操作怎么做呢？第一，你首先验证这个市场是不是完备的，第二，验证市场上是否存在着套利机会。如果不存在套利机会，如果不算的话就你应该知道根据第二资产定价基本定理，这个市场里面存在的一个唯一的状态价格向量，把所有资产价格表示为未来payoff(未来支付)的一个加权平均存。

既然存在状态价格向量，就一定存在一个风险中性概率。
所以，第一步就说只要无套利，我就马上知道存在风险中心概率。第二步，利用现在现有已有的资产的价格信息，来把这个风险中性概率算出来。在上一节课里面，我们在第三种方法中，先用股票的价格来算出了风险中性概率$q$。第三步，用你算出来这个风险中性概率来给你要定价的资产来算它未来支付的期望，然后再用无风险利率贴现到现在。就完成定价就完成定价。

这就是风险中性定价它的一个idea。理论就这么简单啊，理论其实说白了就这么就这么一行式子。

那接下来我们来分析一下，这个风险中性概率$q$，它是个什么样的意思？它和现实世界的概率存在什么样的联系？我们给他一个相对直观的印象。

$$p=\sum_{s=1}^S\varphi_s x_s$$

在C-CAPM中，我们对资产定价给出这么一个式子：
$$p=\sum_{s=1}^S\pi_s\delta\frac{u'(c_{1,s})}{u'(c_0)}x_s$$

这是我们上半学期的C-CAPM里面，也就是一般均衡理论里面我们给出定价方程。其实你会发现这个定价方程啊。它其实符合我前面说这个状态价格向量的这么一个形式。

他不是偶然的它不是偶然的，它必须是要满足这个形式，所以说在C-CAPM中，我把这个状态价格向量用别的思路(解一般均衡)，把状态价格向量都具体形式都给描述出来了，具体形式就是$\pi_s\delta\frac{u'(c_{1,s})}{u'(c_0)}$，所以我对这个市场里面资产价格有了很深入的了解。而在无套利定价里面呢，因为这个状态价格一开始是不知道的，所以我只能通过已有的资产价格的信息来把状态价格向量给它推出来。

值得注意的是，这里的无套利定价和之前的C-CAPM是两条并行的道路，也就是说，无套利定价并不是说一定要C-CAPM才能推出来，而是可以独立存在的。只不过现在我需要用C-CAPM这个东西来给大家解释一下这个风险中性概率的一个具体的含义。


在C-CAPM的状态下，我明确的知道状态价格向量是什么东西了，现在来看这个$q_s$是什么状况。
$$q_s=\frac{\varphi_s}{\sum_{s=1}^S\varphi_s}\\=\frac{\pi_su'(c_{1,s})}{\sum_s\pi_su'(c_{1,s})}$$

如果我们有C-CAPM，我们就可以把这个中风险中性概率的具体形式描述出来。所以我们来看这个风险中心概率，$q_s$是风险中性概率，$\pi_s$是真实世界的概率。所以他们不是完全没联系，二者之间是存在联系的。风险中性概率是对真实世界概率的一种扭曲，那些边际效用比较高的状态，(就是阿罗证券价格比较高的状态)，也就说消费比较稀缺的状态，在计算风险中性概率的时候，就会人为的把那个把它的概率要加大。所以如果$u'(c_{1,s})$比较高，所以算出来的$q_s$就比较大。而会人为的去降低那些消费不那么稀缺、消费边际效用比较低的 状态的概率。所以风险中性概率，它是基于不同状态的这个消费的稀缺程度，由这个边际效用来衡量、来刻画，根据这个消费稀缺程度来对不同状态的概率(真实世界概率)做一些扭曲，增大那些消费稀缺状态的发生概率，减少那些消费不稀缺的状态的概率，然后得到一个风险中性概率。
所以这个风险中性概率和真实世界的概率不是完全没关系，是存在关系的。

上述就是我们对资产定价这个理论的一个基本描述。这里面其实有很多概念，最后我们把这些概念给大家再梳理一遍。

在C-CAPM里面就已经推出来了：

$$p=E[\tilde{m}\tilde{x}]=\sum_{s=1}^S \pi_s m_s x_s=\sum_{s=1}^S\varphi_s x_s=e^{-r}\sum_{s=1}^S q_sx_s=e^{-r}E^Q[\tilde{x}]$$

此时，$\tilde{m}(m_s=\frac{\varphi_s}{\pi_s})$称为随机折现因子(SDF)。

如果学过概率论的话，$\pi_s$是概率，然后$m_s$像是一个密度。$m_s$又叫做状态价格密度 $State\ Prize \ Density$。同时又有另外一个名字叫状态价格核$state\ price\ kernel$。当然还有个名字叫做定价核$pricing\ kernel$。
所以 随机折现因子=状态价格密度=状态价格核=定价核

其中，$\varphi_s$又称为状态价格$state \ price$，也是阿罗证券的价格$price\ of\ Arrow \ Security$。

重要的部分就是上面这一行式子。这排式子就是我们上半学期的主体内容，也是风险中性定价的这个理论的基础。

所以你会发现上节课所说的APT，它是一个过渡的东西，从它发展的历程来看，APT它其实是一个独立发展。

然后我们是这一套理论，即风险中性定价这套理论。它的发展是起源于布莱克-斯科尔斯公式的推导，就是布莱克-斯科尔斯公式推出来之后，然后大家才发现这个东西里面存在一些有趣的东西。后面就是有很多人的努力，才开始就把这个风险中性定价的套理论体系给构建起来。

所以我们从现在开始直到后面，我们要给期权定价，给美式期权定价，再到布莱克斯科尔斯公式的推导，这些东西都是基于这个框架。
实际上，这个理论框架和APT有很大的区别。虽然都用到了无套利的思想，但这今天我们讲的这个东西才是无套利定价的一个核心的理论的基础。

所以以后我们给给所有资产定价很简单。先基于已知的资产价格来推导出风险中性概率，然后在风险中性概率下面去求未来支付的期望，然后再用无风险利率贴现。以后我们碰到的所有资产，在无套的定价里面都这么定价的啊，包括布莱克-斯科尔斯公式都是在干这个事情。推导风险中性概率，然后计算那个期望。只不过当资产价格设定的比较复杂之后，这个风险中性概率的推导以及期望的求出不是很好求的，在这个地方会比较复杂。但是它的核心思想是简单的，所以这就是我们这个无套利添加的理论基础。


最后呢，我们要讲一个东西，就我们回到一开始提的那个问题。就你给我讲资产定价，最后你给我讲了一个风险中性定价$risk\ neutral\ price$。那为什么能假设人是风险中性呢？现在我通过几黑板的数学我告诉你，就是可以假设有个风险中性的世界，在风险中性世界里面求一个期望，它就是我们现实世界的资产价格。数学就摆在这，但是数学只是第一步，很重要一步就是你要从感情上要接受它，要说服自己能够从直觉上来理解，在给资产定价的时候，假设所有人是风险中性。这个我们最后要讲的，同时这点又比较重要。

给资产定价的时候，风险偏好当然是重要的。我们类比一下，去给汉堡可乐套餐定价。这个汉堡和可乐的价格当然是会受到人们口味偏好的影响的。如果大家都特别喜欢吃汉堡喝可乐，那肯定汉堡和可乐的价格也比较高，可能一个汉堡一个可乐都两块钱。但如果说大家都很健康啊，就远离垃圾食品，要吃健康食品，不怎么爱吃汉堡，不怎么爱喝可乐，那汉堡和可乐价格就会比较低一些。所以汉堡的价格和可乐的价格当然是会受到人们口味偏好的影响，这点没有任何问题。

在现实中也是类似的，我们对应到资产。资产价格，比如就股票价格，比如现在就茅台，茅台的股价到底是500块钱，1000块钱当然会受到人们是不是爱喝茅台，以及说人们是不是对这个风险的厌恶度有多高这个东西的影响。

风险偏好确实会影响到资产价格，但是在无套利定价里面我们研究的课题是什么？我们研究课题说：给定了汉堡的价格和可乐的价格之后，汉堡可乐套餐的价格是多少，这是我们研究的问题。那么只要是没有套利机会的，那么汉堡可乐套餐的价格就应该等于汉堡的价格加上可乐的价格，不管这个汉堡和可乐价格是一块钱还是两块钱。它这个套餐的价格只要是无套利的都一定等于汉堡的价格加上可乐的价格。如果大家爱吃汉堡，可能汉堡可乐分别是两块钱，那么汉堡可乐套餐应该是4块钱；如果大家都不爱吃汉堡不爱喝可乐，汉堡可能一块钱可乐一块钱，那么汉堡可乐套餐价格就是两块钱。但不管汉堡的价格是一块钱两块钱，你套餐的价格和汉堡与可乐价格之间，只要是无套利的，就被联系起来。所以当我们关注的是汉堡可乐套餐的价格时，(假设给定了汉堡的价格和可乐价格)，我们关注的问题是说给定这两个价格之后，我们来给汉堡可乐套餐定价的时候，我们就可以不关心人们到底是不是爱吃汉堡喝可乐，口味就不是我要关心的事情了。因为无套利就套利就会存在与否，与人们的口味是没关系的。在真实世界中，一个套利机会是否存在，跟你这个人是不是风险厌恶的没关系。因为，什么叫套利？套利是无风险给你一笔钱的机会。那么只要存在套利机会，风险厌恶的人和风险中性的人都会想办法去把这个套利机会运用起来。所以只要这个市场是无套利的，那么在风险厌恶的人看来就是无套利的，在风险中性的人眼里看来这个市场仍然是无套利的。所以当我们研究的课题说是给定了一些资产价格之后，再定出另外一些与它相关资产价格的时候，只是通过无套利益来研究这两类资产之间的相互关系的时候，这个人是不是风险厌恶的，风险厌恶程度有多高是不重要的，因为套利机会的存在与否不取决于你的风险偏好程度。所以风险厌恶与否，风险厌恶程度的高低，会决定你已知资产的价格的高低，这是没问题的。但是那不是我要研究的课题，我研究的课就给定了这些资产价格之后，(即基于这个市场里面风险偏好度，给出了股票和债券价格之后)，我要定出期权的价格。在这一步里面，我就不需要考虑风险偏好度了。所以在我们的这个定价理论体系中，在风险中性定价里面，或者要相对定价理论体系中，我们就可以假设世界是风险中性。因为风险偏好已经在我们的已知条件里面，已知条件是指：已知资产的价格里面已经被包含进去了。而我们要考虑的只是套利机会的存在与否，无套利的这一种状态把不同资产价格之间联系起来，这时候就可以假设所有人都有风险中性了。


所以为什么我们在研究资产定价的时候，我们去假设所有人的风险中性。这是因为我们是在做相对定价。风险偏好度已经作为已知条件被包含在已知资产价格里面。所以我们在这个前提下面，我们再来做后面的东西就不需要考虑风险偏好。所以这是为什么我们在均衡定价里面，当我从无到有定出所有资产价格的时候，我必须要花很多钱来讨论人的风险厌恶程度这个问题。而在我们下半学期这个无套利分析里面，我就不考虑什么风险厌恶的程度了，因为用不着。因为我们现在做的是相对定价，不是绝对定价。所以我希望通过这一番的这个阐述，大家应该现在可以从直觉上理解了，为什么我们可以用风险中性定价来给资产定价，为什么可以假设所有人都是风险中性的。

以后我们定价，就直接跳到这里的一行式子中。所以定价非常简单，所以我们上节课那第三种定价方法多简单。用股票价格算一个风险中性概率$q$出来，再用这个$q$算期望。就这么简单，所以这个无套的定价，你说很复杂吗？其实我觉得一点不复杂。

只不过后来呢以后呢，他去用这套理论来去刻画不同的资产的走势，就你一只资产价格走势，你要用不同的数学模型去刻画它，使得你的数学模型与现实世界能够尽可能贴合，这个数学工具用的比较复杂。所以你已知资产的价格给的这个模型比较复杂之后呢，你去推导这个风险中性的概率$q$以及在风险中性世界上面算这个期望就会变得比较复杂。但那种复杂在我看来都是数学层面技术性的复杂，真正的核心的思想，无套利定价思想其实非常简单，就这一行式子。

##第十六讲
回顾：
今天我们就沿着上节课给出的那个理论的体系，即风险中性定价或者称为无套利定价的一个理论体系。回顾一下，对于任何一个资产$p$，根据资产定价第二基本定理，在完备市场假设下的资本市场有：

$$p=\sum_{s=1}^S\varphi_s x_s=e^{-r}\sum_{s=1}^Se^{r}\varphi_sx_s=e^{-r}\sum_{s=1}^Sq_sx_s\\=e^{r}E^Q(\tilde{x})$$


这个$\varphi_s$，就是这个阿罗证券的价格，也是我们的状态价格向量，这个等式是由我们的$fundamental\ theorem\ of\ asset\ pricing$来保证的。这个就是我们上一课主要内容。那有了这个东西之后，后面就简单了。最后就把它演转换成为在风险中性世界下，我们在这个上标Q，求期望的这么一个问题。这就是风险中性定价理论的核心。所以我们以后来做资产定价，就两件事。当然，首先去确认市场是完备的，保证我们的状态价格向量是存在而且唯一的。之后，第一件事就是找出风险中性概率$q$。这一步就是用已知的资产价格来找出它。找出这个风险中性的概率$q$之后，那么资产定价就演变为一个求期望的问题。

今天我们就按照以上思路来实际的去给资产定价。所以今天下半节课我们就给大家实际演示我们怎么用这套方法来给现在的上证50ETF期权定价，待会就看看这个期权现在多少钱，然后这个期权的价格究竟应该怎么去计算。

但是要算它我们还要再走一步。目前为止，我们讲的都是单期的模型。单期模型只有两个时点，0时刻和1时刻。但这个东西和现实显然差的有点远，资产价格总是在不断在变化的。所以今天我们要把这个单期模型的拓展到多期模型。(实际上我们在上上讲中，引子给出的那个例子里面的第3种方法，已经是用这个方法求得这个资产价格。关键它是单期模型。)在多期模型中，资产价格它可以有多次变化，股票价格可以一会涨一会落。，那么在这样的环境下面，资产价格怎么怎么来确定？所以今天我们要做的就是把我们这个把我们上上讲的这个引子从单期拓展到多期。也就是说在多期的情况下这个期望是如何计算的。


但是拓展到多期存在一个很重要的东西就必须要引入进来，这个东西就是信息(Information)。因为单期就很简单，单期模型我们就说未来是不确定的，我们在现时刻对1时刻有个预期就好了。但是预期在零时刻做出之后就不需要再改了。因为1时刻下，不确定就消除了。但如果是多期的话呢，那么这个东西显然不一样，这个信息是会发生变化的。

举个例子，比如这是今天today，然后明天是tomorrow，后天是day after tomorrow。然后，我们关心的就是天气的状况。显然我知道今天天气是什么样的。那明天呢？天气可能有两种可能性，一种可能性它是明天出太阳了：sunny；另一种可能是明天下雨了，rainy。所以说，在今天我是不知道明天下雨还是出太阳了，这是我不知道的，所以明天有两种可能性。但是到明天之后，我还是不知道后天是会下雨还是出太阳，所以后天其实还有两种可能性。后天也可能是sunny，也可以是rainy。

但是我们来看后天这个东西：明天晴天，后天晴天 和 明天下雨，后天晴天。这是两个不同的事件。所以在这样的情况下，信息是会会随时间的变化而变化的。在0时刻的时候，也就是今天，我既不知道明天会怎么样，也不知道后天会下雨还是出太阳。然后到明天的时候，我就知道明天到底是下雨还是出太阳，但是我还是不知道后天会怎么样。

但很显然呢，从今天到明天的时候，这个信息是发生变化的。就是，我多知道一些东西，尽管我不是都知道。但我多知道一些东西，这种变化就信息。信息在发生变化。这个是我们以前没碰到过的，虽然我们在单期模型中把它忽略掉。但在这个地方我们就必须要把这个问题拿出来详细解释，就我需要把这个信息变动的过程要给它刻画出来。

为什么要刻画信息的变动？因为信息的变化会改变资产的价格。想想我们对一个公司的股票进行估价，当然对公司越了解，估价就肯定会发生变化。假设公司新的信息出来了，比如你以为这个公司是个好公司，后来发现这公司财务是在作假的，那显然你对这个公司这个评价就会发生重大的变化。所以这种信息的变化对资产价格肯定是存在影响的。


在多期模型中(实际上就是动态模型)，在动态模型中，我们就必须要把信息的变化给他描述出来。所以在这个地方，今天、明天和后天。在这个框架下，我们来看怎么来刻画它的信息。


![](image/2022-02-07-16-32-36.png)


首先，如果要说世界所处的所有状态的话，这地方就有4个状态，分别是S1、S2、S3和S4。也就是说：明天和后天都出太阳，记为SS，以此类推。这四个状态是不一样的。虽然只有下雨和出太阳两种可能性，但存在两天。最后实际上是存在四种不同的可能性。

然后假设我们处在明天这个时间点，知道明天是下雨了，但是我们不知道后天是下雨还是出太阳。所以说我们还是知道一些东西，即，如果我们知道明天下雨，那么就意味着世界只可能处在S1或者S2这两个状态中，不可能处于S3和S4的状态下。但是在这个里面到底是S1还是S2？我还不知道。如果明天是下雨的，世界要么处在S3状态要么处于S4状态，但是我不知道具体是S3还是S4。显然我在明天的时候，我比在今天知道的东西要多。我今天只知道世界有可能会处在S1、S2、S3、S4状态里面的某一个。但到明天这个时间点，我至少可以把一半的可能性排除掉了。今天晴天，所以我知道要么S1要么S2；今天下雨，所以我知道要么S3要么S4。比在今天这个信息肯定是多了。到后天的时候，我就明确的知道世界到底处在1234这4种状态里面具体的哪个，所以信息是在发生变化的。

那信息的变化怎么体现出来呢？这个信息的变化就在于我对世界最终落在哪一个状态的了解越来越清晰了。我知道世界在这个4个状态里面一个。比方我们假设明天是出太阳的，然后到了明天，我知道世界在S1和S2里面。然后到了后天，后天又出太阳了，我就知道世界其实最终是在S1这个状态。所以我在不断的收缩我的这个范围，我越来越清晰的知道我处在哪个状态，直到最后我把这个状态知道之后，所有信息我都知道。


所以这个过程我们来看那个信息是怎么体现出来的，就在于我对这个世界可能处在的状态的范围越来越收缩越来越收缩，这表明我对世界可都处在的状态，信息越来越多了。所以这个过程怎么用数学语言来描述它，所以引入一些新的概念。第1个概念呢叫做$event$：事件。$Event$就是状态的集合，所以在这个里面其实有两个$event$，我可以把这个定义为$e_1={S_1,S_2}$和$e_2={S_3，S_4}$。第1个event就是S1和S2所处的集合。这一部分用语言来描述它就是说：明天出太阳，但还没到后天。明天出太阳用数学语言就是$e_1$来描述它。那么$e_2={S3、S4}$这个事件就是明天下雨了。这个$e_1$和$e_2$存在一个很好的特性，$e_1$和$e_2$的交集是空集，然后他们的并集，即，$e_1$和$e_2$的并集是这个状态空间$S$。实际上正好把这个状态空间划成两块，把这个饼正好切成两块了，不多也不少。所以对于这种东西，就几个集合合起来是全集，然后相交是空集，我们就把它叫做一个划分：$partition$。这个划分我们就用$F$来表示，可以把它写成$F={e_1,e_2}$。划分就是说我把这个状态空间再分成几块，我就往下进入，我不知道精确到哪一个状态会发生。但是呢，我会知道是在哪一个集合里面发生事情。


补充一下对于互斥的理解:
假设存在两个事件，事件$e_1={S_1,S_2,S_3}$和事件$e_2={S_2,S_4}$。比如说世界最后就是处在$S_2$这个状态里面，显然就意味着说事件$e_1$发生了。那么，我能不能说事件$e_2$就肯定不会发生呢?你是说不出来的。所以这个地方强调两个事件它不互斥。因为它不互斥，这个信息就给的不够清晰。所以呢，我们在数学描述的时候还是要求：所有的事件最后要形成一个划分。因为如果是划分，我知道某个事件一旦发生了，就能够把其他事件给排除。这样的话就能够把事情的状态信息不断的缩小。这个划分随着时间的推移，信息越来越多，就表现为我对这个划分越来越精细。

最开始我只知道$e_0={S_1,S_2,S_3,S_4}$是一个划分，世界只可能处在这四种状态里面，但是具体是哪个状态我一点信息也没有。然后到了明天，我就知道世界要么处于$S_1,S_2$中，要么处于$S_3,S_4$中。到了后天就明确的知道世界是处于哪个状态了。所这4个状态，其实也是这个状态空间的一个划分。因为这4个状态合起来等于整个状态空间，而4个状态之间显然是互斥的。所以随着我们获得的信息越来越多，这个划分就越划越细。这样的话我就对这个世界状态的了解也就越来越清晰。这是我们对信息的一个要求。当然你数学上可以给个模型说这个划分它不是越来越精细的，但是当我们在用划分来描述整个经济时，我们要求这个划分越来越细。为什么要求划分越来越细？因为我们知道，人是有记忆的。你知道的东西，你不会忘记。所以如果划分不是越来越细，那就意味着你忘记了一些东西。

所以这个基于对它的一个更加详细的描述，所以这个划分它是个变化，是一个随时间变化的，并且这个东西是越来越精细的。所以对于这种东西，(即随时间变化，且越来越精细)，我们把它叫成数学上的另一个名字：过滤($Filtration：{F_t}$)。


所以这个${F_t}$这个划分来描述信息集，所以以后你看见这个${F_t}$你就应该知道这是$T$时刻的信息。这其实是我想我想告诉大家的，这是我们想讲的。


然后呢，我们来讲一个东西，一个资产价格，比如说一个股票价格$p$。当我们说一个东西是随机变量的时候，也就说，这个东西它的取值是状态的函数，即不同的状态它的取值不一样。

所以要引入这个概念：可测$measurable$。即一个随机变量相对一个信息集，相对于划分是可测。也就是说相对这个$F_t$是可测的。比如说，我知道了我处在哪个哪个划分里面的时候，(比如我知道我处在S1、S2这个这个事件$e_1$里面，或者我处在S3、S4这个事件$e_2$里面)，当我知道我处在某个事件里面的时候，我就知道这个随机变量的取值，这就是可测的概念。



什么意思呢？当我知道我处在这个$e_1$或者$e_2$这两个事件里面的某一个的时候，我应该知道这个随机变量的取值。也就意味着说这个随机变量在S1和S2这两个状态取值应该一样的；同理，在S3和S4这个状态取值应该是一样的。这才能说这个随机变量对他是可测的。

否则的话呢，比如说这个随机变量在状态S1的时候，它取值是4，在状态S2的时候，它取值是5。这时我告诉你，现在知道事件$e_1$发生了，世界可能处在S1或者S2状态中的某一个，你能知道这个随机变量取值什么吗？你不知道。因为随机变量取值有可能是4，也有可能是5。所以，我们要求的就说：一个随机变量对于一个划分是可测的，你才能够用这个。实际上也就是说，你知道了这个信息之后，然后你知道这个对应的相关的随机变量，(比如这个资产价格)，它的取值应该是多少。否则这个资产价格它就是神秘的，它决定于一些你不知道的东西。

我看大家都听得很迷惑，迷惑也是正常的。所以最后你就记住一个东西，以后我写这个$F_t$就表示这是一个信息集，然后这个信息集会随时间变化而变化，所以这个$F$要加个下标$t$，你记住这个东西。




现在我们来进入下一个问题，如果我们要运用一开始说的这一套定价方法，前面有个很重要的一步，即资产的价格可以被状态价格向量表示。而价格向量的存在是要求市场是完备的。
在这个地方啊，整个世界有4个状态。如果是一个静态一期模型，我们就要求资产的数目至少要比状态的数目不少，也就是说至少等于状态数目，你市场才有可能是完备的。而那在这个地方，我们是有4个状态，那是不是我们需要4个资产才能够形成完备市场呢？答案是否定的。

现在给大家一个结论，不予以证明。在这个世界中，事件的发生是以一种树图的形式。比如某个节点引出两支分叉，就表明在这个节点往后有两种可能性。所以它有这么一个idea，即：如果一个市场如果是动态完备的，即一个$Dynamic\ Complete\ Market$是怎么形成的呢？就要求这个市场里面有长存资产。长存资产：这个资产的payoff持续有支付。不是说到某个时候这个资产支付完之后，他就没有支付，这个资产就结束了。反而说我有长存资产，这个资产的支付可以一直到最后都有支付。

所以如果你这个市场里面存在长存资产，那么这个长存资产的数目，只要不少于你节点分叉出来的这个数目的上限，这个市场就是动态完备的。

具体是什么意思？比如在这个动态里面，每个结点都往外分出两个分叉来。但有可能一个节点能够分出更多的分叉。比如这个节点分成三个分叉。所以在这个描述该动态场景的树状图中，分叉最多的结点是哪个？显然是这个存在三个分叉的结点。所以只要你的长存资产的数目不低于3，这个市场就是动态完备的。

其实我想说的point就是：以后我画出这样的图，这样多期的树状图，最后我们可能会画出十几二十期的树状图。最后树木会很惊人，但即使树木这么惊人，只要我一直都是用二叉树，那么我两个资产就可以让它形成一个完备的市场。

所以说，以后我们所假设的都是完备市场。在完备市场里面第二资产定价基本定理是可以用的，也就是说存在着唯一的状态价格向量。上述这些都是我们的一些数学准备。



所以接下来我们就来开始实战的描述。举个例子，篮球比赛，北京对阵辽宁。7局4胜。假设北京队胜利为W失败为L，这个过程我们用二叉树把它描述出来。

![](image/2022-02-08-13-41-00.png)

第3场比赛的时候就已经是这个8个状态.那第7场比赛之后，就是2的7次方那么多个状态。所以在这种情况下，你会发现这个状态就变得难以分析，以指数的数量增加。所以这就叫维度的诅咒。碰到维度诅咒，一般我们就没法处理了，因为这个需要计算的数量会变得非常的大。所以今天我们会采取一个办法，也是我们在资产定价里面会用的办法。就是如果不在乎你输赢的顺序，而只在乎你赢了多少场，输了多少场。那么就可以把一些节点给它合并起来。比如说7场比赛里面，到底是谁最后赢了4场。至于说它是先赢还是后赢，这不重要，我只在乎他赢了多少场。所以就不存在顺序的概念，仅仅是数量的概念，将一些结点就可以合并起来。

![](image/2022-02-08-13-48-09.png)


在第1场的时候存在2个节点，第2场存在3个节点，第3场4个节点，第100场的时候存在101个节点。所以这时候这个节点数目就大大的下降了。所以每一个节点都只分两叉，称为二叉树$binary\ tree$，但是把一些节点合并之后，称为合并的二叉树$combined\ binary\ tree$。


再往下就是要在这样一个动态的过程中去算一个期望。假设北京和辽宁打比赛，每场北京赢得比赛的概率是0.6，输比赛的概率是0.4，且每一场都是这样。假设就是3局2胜。问题是，在一开始的时候，北京赢得这个3打2胜比赛的概率是多少？这其实是一个求期望的问题。假设我们有个赌局，北京赢了3打2胜赢了就得一块钱，如果输了就获得0块钱。那么北京在这个比赛里面赢得3打2胜比赛的概率，就是这个赌局给你的期望的回报。所以我们现在就要求这个期望。所以这个问题看起来就并不是那么简单，如果只是一场你可以说很容易，那就是0.6。但是两场就变得更困难了。如果是100场，那简直就好像看起来不可分析了。但是存在一个方法可以把这个问题变得非常的简单，要运用到另外一个数学工具，即叠期望定理。



介绍叠期望定理之前，先强调一下，之前我们写期望都直接这么写$E(\tilde{x})$。但其实这么写是不对的或者说不严格的，因为这个期望你必须要明确它是在什么信息下面求的期望。举个例子说，一开始算北京获胜的概率是一个数。但是如果我知道了北京第一场已经胜利了。那显然，北京获胜的概率就不一样，因为第一场都胜利了，北京获胜概率应该上升了。所以你会发现，对这个赌局最后的支付期望，在不同的节点计算都不一样，因为信息在发生变化。所以以后再写这个期望的时候，就必须要把做期望时候的这个信息集写出来。这才是严格的写期望的方法。 $E(\tilde{x}|F_t)$。$F_t$就是我所掌握的信息，因为信息总是随着时间的变化而变化。所以可以将其简写为$E_t(\tilde{x})$，这就表示我是在$t$时刻做的期望。


现在来介绍叠期望定理。即在$t$时刻对一个随机变量做的期望等于在$t$时刻，对$t+1$期，这个随机变量做的期望的期望。
$$E_t(\tilde{x})=E_t[E_{t+1}(\tilde{x})]$$

虽然看起来没什么意思，但是用起来看看。


![](image/2022-02-08-14-23-34.png)

在第2个时间点上计算北京队获胜的期望可得：$E_2[\tilde{x}]$，如图中第2个时间点上红色字体所表示。

如何计算第一个节点上的期望问题？可以通过叠期望定理得到：$E_1[\tilde{x}]=E_1[E_2(\tilde{x})]$，在得到$E_1[\tilde{x}]$之后，在通过相同的方式得到$E_0[\tilde{x}]=0.648$。
所以看起来这个问题很复杂，但用叠期望定理之后，它就给你变成一个逆向的，每次都是非常简单的单期求期望的问题。从尾巴开始一路倒推就把前面这个算出来了。而且在这个过程中你不仅算出了在0时期的期望，还算出在各个节点上面北京队取胜的概率。你会发现，北京队取胜的概率随着你获得信息的变化而变化。所以这个叠期望定理的使用的方法看起来很简单，但用起来确实很很管用。上述已经完成了数学工具的准备。将这个多期的状态描述成为合并二叉树，也会在合并二叉树里去计算期望。




接下来我们要做的就是来算一个例子，算这个期权定价。

假设一开始股票价格为$S_0$，股票在第1期有可能上涨成为$uS_0$，也有可能跌成$dS_0$。第2期有可能连续上涨两次，成为$uuS_0$，也有可能上涨一次下跌一次成为$udS_0$。也有可能连续下跌两次成为$ddS_0$。总的来看，就是一个合并的二叉树。在每一个$period$股票都有可能变成原来的$u$倍或者变成原来的$d$倍。且前面的这个乘法因子在每一个节点都有，在每一个节点都一样。然后如果我们最后只关心的股票的价格是多少，那么无论是先涨再跌还是先跌再涨都不重要，最后都走到同样的位置。所以在这种情况下我们用这种合并二叉树来给资产定价。此时资产一定有一个性质


同样对于一个衍生品，衍生品在0时刻的价格为$C_0$，有可能变成$C_u$和$C_d$，之后也有可能变成$C_uu$、$C_ud$和$C_dd$。 衍生品的价格取决于股票的价格，所以如果用这样的合并二叉树来给这个这个衍生品定价的时候，一定有个前提条件。即衍生品的价格只取决于当期的股票的价格，而不取决于股票它是怎通过哪条路径到达这个价格的。比如我们看到的欧式期权和美式期权就可以用这种合并二叉树来描述。但是并不是所有的期权都可以通过这个合并二叉树进行计算，比如说存在一些期权如回望期权，它的这个支付可能取决于，这个期权从开始到这个结束过程中，股票价格所达到的最高点的价格，对于这样的期权是存在路径依赖的。哪怕最后股票价格都是相同的，从不同的路径走过来，最后期权的价格是不一样的。所以这种期权你就不能用合并二叉树，如果需要计算这种期权，你就乖乖的回到原式的二叉树来计算。

当然还有另外一个资产，就是无风险资产。无风险资产的回报，假设无风险在产在第0期为1，在第1期为$e^r$，在第二期为$e^{2r}$。

这个市场中存在两种资产，即无风险资产和股票，也就是说这是一个完备的市场。即这个市场是动态完备的，因为这个市场里面每个阶段最多引出来的叉数是2，然后有2个长存的资产：一个是股票，一个债券。所以长存资产的数目不低于这个分叉中最多节点的分叉数。所以这是一个动态完备的市场。

假设$u-2$，$d=0.5$，$e^r=1.25$，$S0=100$，对于一个欧式看涨期权$Call$来说，其行权价格为$K=100$，这个期权的$payoff$为$max=\{S-K,0\}$。

![](image/2022-02-08-15-54-31.png)

所以这个$C_0$应该怎么算？第1步，计算风险中性概率。用已知资产的价格来算风险中性概率。对于每一个节点上股票价格涨跌的幅度是一样的，所以你用任何一个节点来算都可以。用第0个结点来算风险中性概率。$100=S_0=e^{-r}[q\cdot200+(1-q)\cdot50]$，解出$q=0.5$，所以解出风险中性概率为0.5。
之后开始计算期望，期望是反着计算的。逆向递推进行计算。在最后一个分支处。利用资产定价基本定理计算期权的价格为：$C_u=\frac{1}{1.25}[300\cdot0.5+0\cdot0.5]=120$、$C_d=0$。此时，$C_0=\frac{1}{1.25}[120\cdot0.5+0\cdot0.5]=48$。所以期权在0时刻的价格为48元。

如果是一期的期权(One\ period\ call)：假设期权行权价格还是$K=100$，此时$C'_0=\frac{1}{1.25}[100\cdot0.5+0\cdot0.5]=40$

这里就可以看出，如果期权行权的时间比较晚，存续的时间比较长，这个期权的价格会变贵。因为很简单，期权是一个保险。就是说：亏是亏不到哪里去的，但是给你一种获利的机会。所以你这个时间拉得越长，股价总是不断的在发生波动，波动越来越大。那么你拖的时间越长，波动幅度越来越大，反而它把坏的情况都给你保险保掉，你就不会承受坏的情况带来损失。但好的情况，越来越多的收益你就会得到。所以它这个保险存续时间越长，带给你的这个好处就越多，买权存续时间越长它的价格越高。上述就是在两期的情况下计算出的期权的价格，多期的期权价格计算就是用Excel来计算了。


再讲一个重要的概念：定义一个东西为$Deflated\ asset\ price$贴现的资产价格。即资产价格除以当期的无风险资产的比值。例如贴现的股票价值$\hat{S_t}=\frac{S_t}{e^{rt}}=e^{-rt}S_t$。相当于用无风险利率将这个股票的价格贴现到0时刻来，这就叫贴现的股票价格。对任何一个资产都是可以做这个事情的。比如贴现的衍生品价格、或者是贴现的无风险资产的价格，自然这就是1。
计算这么一个东西：在1时刻，u这个节点，计算在2时刻的贴现股票价格的期望，当然是在风险中性概率下求解。
$$E_u[\hat{S_2}]=q\hat{S_{uu}}+(1-q)\hat{S_{ud}}=q\cdot e^{-2r}uuS_0+(1-q)e^{-2r}udS_0\\=e^{-r}\cdot e^{-r}[q\cdot uuS_0+(1-q)udS_0]\\=e^{-r}uS_0=\hat{S_u}$$

类似的可以计算在1时刻，d这个节点，计算2时刻的贴现股票价格的期望为：
$$E_d[\hat{S_2}]=\hat{S_d}$$

这两个式子可以合并起来写成：在1时刻对2时刻 贴现股票价格的期望(在风险中性概率的前提下)等于1时刻贴现股票价格，不管你1时刻是在u这个节点还是在d这个节点。
$$E_1[\hat{S_2}]=\hat{S_1}$$

类似的也可以计算在0时刻算2时刻贴现股票价格的期望就应该等于0时刻算1时刻的贴现股票价格的期望，同时也等于0时刻的贴现股票价格。
$$E_0[\hat{S_2}]=E_0[\hat{S_1}]=\hat{S_0}$$
所以这里存在一个非常有趣的性质，在风险中性概率下面，你对资产的未来贴现价算期望，这个期望就等于你现在 在做计算的这个时点上 这个资产的贴现价格。所以在1时刻来计算2时刻贴现股票价格的期望，就等于1时刻股票的贴现价格。在0时刻来算1时刻贴现股票价格的期望就等于0时刻股票的贴现价格。这个东西叫做鞅，即：Martingle。

鞅其实是一个随机过程，这个随机过程你在任何一个时间点上对这个随机过程(一系列随机变量)的未来做期望，这些期望就等于它现在的取值。

在随机过程这个领域内，鞅是一个非常重要的一个随机过程，所以对与鞅，存在非常多的数学结论。所以我们发现，在风险中性概率的条件下，资产的贴现价格可以化成为一个鞅。数学家们整出的一堆关于鞅的结论都可以套上去了。直接套上去就可以分析资产价格了。这就是风险中性概率非常好的地方，它可以将所有资产的贴现价格，不光是股票、衍生品的贴现价格，都转换为鞅。这就是风险中性概率。所以风险中性概率($Risk\ neutral\ prob$)又有另外一个名称：等价鞅测度($Equivalent\ Martingale\ Measure$)。所以风险中性定价又称为鞅方法($Martingale\ Approach$)。

这就是我们对多期二叉树定价的一个简单的分析。当你把这个多期二叉树推到无穷期，就可以得到这个期权的定价收敛到布莱克-斯科尔斯公式上面了。所以这是第一种推导布莱克-斯科尔斯公式的一种方法。

现在我们来看一下实际的例子：
实践的详细内容在金融经济学二十五讲中有详述。


##第十七讲：

上节课介绍了二叉树定价，有了这个就可以为我们现实中的期权定价。今天沿着上节课的思路继续往下走。衍生品定价很简单，就是逆向递推，其中的数学思想就是叠期望定理。不断地求期望，从尾巴向前推，直至求出资产的价格。现实中会有些资产你可能找不到它的尾巴，比如说美式期权。欧式期权存在一个到期日，只能在到期日选择是否行权。美式期权是从签订的时间开始直至到期日随时均可以行权，有可能签订几天之后所有者就行权了，这期权就结束了，这个时候如何进行逆向递推？还有一种资产，比如买房的按揭贷款。经常性的有人会提前还款，合同是签订的20年，而很有可能过了十年借钱人把钱就换完了。这种终结日不确定的资产应该如何定价是我们今天需要研究的问题。所以今天的内容涉及一个概念：最优停时($Optimal\ Stopping$)。比如，美式期权什么时候行权？按揭贷款什么时候还款？

所以我们使用这个理论来对两类资产进行定价。一个是美式期权($American \ Options$)和按揭贷款($Mortgage$)。上述讨论的环境还是在二叉树里面，只不过在其中要添加一些东西，在每个节点需要去判断是不是要把这个东西给结束掉。

先来给美式期权定价进行定性分析：什么样的美式期权有可能会被提前行权？什么样的美式期权就不会被提前行权。有一个结论可以该诉大家，**如果美式期权的标的物是一个不分红的股票，那么这个美式买入期权它一定不会被提前行权，它一定会被持有到期，充当一个欧式期权。**

如何看出这一点？考虑期权的买卖平价关系：
$C+Ke^{-rT}=P+S_0$，其中$C$表示一个$Call$，$Ke^{-rT}$表示在到期日为行使这项权利所准备的一笔钱。$P$是指一个$Put$，$S_0$是买入一只股票。

等式的左右两边是两个资产组合，在期权到期日时，其支付是$max\{S_0,k \}$完全相同的，所以其现在的价格是相同的。这就形成了一个买权和卖权的平价关系。这个对于欧式期权成立，但是对美式期权未必成立，但是我们可以使用这个，定性的分析对标的是不分红股票的美式买权的行权日。

将上述的买卖权平价关系改写一下可以得到，分析每一时刻的美式期权买权的价格为：
$C_t=(S_t-K)+P_t+K(1-e^{-r(T-t)})$
所以买权的价格可以表示为三块。
1、$intrinsic\ value\ S_t-K$
对于买权来说，只有当你的标的物的价格大于你的行权价，你才会去行权。这才是一个实值期权。当然虚值期权是指上述这个玩意小于零，所以不会去行权。
2、卖权的价格显然大于零
3、加上一笔钱，这笔钱是期权的行权价格减去行权价的贴现值，显然这个式子也是大于零的。
综上，期权的买权价格一定是大于其$intrinsic\ value$，显然期权的价格肯定是大于行权时的收益$intrinsic\ value$，这就意味着你应该持有该期权，不去行权。所以**对于没有分红的股票的美式期权买权就等价于同样标的的欧式期权买权**。

但是，如果股票存在分红的话，那就不一样了。假设现在股价是20元，但是期权的行权价是10元。假设股票明天告诉你每股分红20元，之后该股票清盘，这种情况下你还能不行权吗？你肯定会行权了。

但是为什么我们要提及这个问题？上面是数学的冰冷推导，从感性的角度来理解一下。
假设我有一个股票价格10元，又有一个美式买入期权，行权价为10元。即：$S_0=10,K=10$。在某个时刻股票价格上涨到$S_t=1000$，正常人的思维是都涨到1000元了，这不赶紧行权，万一股票价格跌回10元不是亏大了，但是这时数学告诉你不应该行权，应该继续等下去。数学的推导是否和直觉相违背？一方面，如果股票价格下降，现在行权能获得一部分收益，但是万一股票再继续上涨，那么是不是又亏了一大批钱没赚到？

期权是一个保护，将期权这个不确定的玩意换成了一个确定的东西，你消除了不确定性，即消除了未来的风险，但是你同样也消除掉了未来可能的收益。

再往下考虑，股价都涨到1000元了，你凭什么会预期股票价格还会继续往上涨而非下跌？其实，对于股票来说，当股票处于1000元这个位置时，市场上好的预期和差的预期因该是各占一半的，即一半的人认为会往下跌，一半的人会认为会往上涨。假设不是这样，所有人都预计这只股票会下跌，这只股票就一定不会处于1000元这个点位上。1000元本身就是市场对于这只股票正面的观点和负面的观点达成平衡所形成的价格。

不能光看到当我行权的时候，我可以将我的收益给锁定了，但是同时你也要注意到，行权之后，你未来可能的收益也被同时抹去了。
所以上述的讨论只是对不分红的股票的美式买权所进行的讨论。

另外一种，即美式卖权，即使标的的资产是不分红的股票，他也极有可能提前行权。与买权不一样，只要股票的价格在不断地往上涨，可以说买权的收益是无限的。但是卖权的收益是存在上限的。此时期权卖权的收益就是行权价格。比如说，假设股票的价格为0元，行权价格为10元，此时你的收益撑死就是10元。因此卖权的收益是存在上限的。所以某段时间内，卖权的行权价格为10元，而此时股票价格已经跌成了0.01元，你说你不行权？怎么可能呢？再跌又能跌到哪里去呢？所以卖权是有可能被提前行权的。

对于美式期权来说，行权的时间是不一定的。有些时候它就会一直持有到行权日，但是有些期权就会提前行权。所以说这个时候来给它定价，利用上节课的二叉树来给它定价，就必须先确定一个问题，这个期权行权的时间是什么时候，然后再来讨论行权的时候它的支付是多少，然后再来按二叉树模型来求解期权的价格。所以一开始就要解决一个问题，这个期权什么时候停止？

所以之后我们要采取一套听起来十分高大上，但是实际操作却没有那么复杂的一套理论，即动态规划(Dynamic program)。

首先我们给出一个例子：比如一个赌局，假设一个盒子，盒子中有40个同质的球，其中有20个红球，20个绿球。且这个盒子是封闭的，你看不见里面的内容。你可以去摸这个球，假设摸到的是红球，就给你1元钱。假设你摸到的是绿球，就扣你1元钱。你可以不断地摸球，当然你也可以随时就停止。直到你摸完这40个球，这个赌局就结束了。这个赌局的期望收益是多少？对一个风险中性的人来说(此人仅考虑期望收益)，他是否会参与这个赌局？

显然，这个赌局是不会让你亏钱的，这个赌局的期望收益是正的。大不了你可以一直摸球，直到所有的球都被摸完，你的收益是0。
但是还有可能，你的运气一直特别好，一开始摸得红球比绿球多，那就意味着你挣钱了，比如说你摸了8个红球，3个绿球，那就意味着你挣了5块钱，那还等什么？赶紧跑了呗，结束赌局。

综上，赌局是不可能让你亏钱，但是还是可以给你带来正的收益，所以这个赌局带来的期望收益是正的，不论是风险中性还是风险厌恶的人都应该去参与这个赌局。但是我们现在就想知道这个赌局能带给人们的期望收益是多少？当然，想要回答这个问题，就应该回答，这个赌局我摸到什么程度就应该结束了。比如很简单的一种情况，假设我摸到20个红球，我就该直接结束了。但是又没有这么好的运气。假设我连续摸了三个红球，你结束还是不结束？
所以这个时候你就不应该拍脑袋决定了，你应该计算后得出结果。

这个时候我们定义一个值函数$Define \ Value\ function：V(R,G)$，这个函数中存在两个自变量，一个是$R$代表盒子中剩余的红球的数量，$G$代表盒子中剩余的绿球的数量。$V(R,G)代$表当盒子中所包含的 球的个数，这个赌局给你带来的期望收益。即，$Expected\ payoff$。所以这个函数会随着$R$和$G$的变化而变得不同。对于我们这个赌局，其实就是要计算$V(20,20)$，即盒子里剩下20个红球和20个绿球的时候，这个赌局带给我的期望收益是多少？

但这个东西似乎是比较难计算的，假设我们从简单的情况来计算，当让还是使用逆向思维来计算。如果盒子里面一个球都没有了，则此时$V(0,0)=0$。如果盒子里面存在一个红球和零个绿球，那么可以说此时这个赌局的$V(1,0)=1$。如果盒子里只有一个绿球没有红球的时候，此时这个赌局的$V(0,1)=0$，因为当你知道盒子里面存在一个绿球的时候，你就不会继续这个游戏了，所以这个赌局带给你的期望收益是零。将上述的问题再拓展一下：假设盒子里面存在R个红球和零个绿球，也就是说此时$V(R,0)=R$，把盒子里面的红球拿干净就完事了。如果盒子里面只存在G个绿球，没有红球，那么可以说这个赌局带给你的期望收益为$V(0,G)=0$。当然你是怎么知道盒子里面到底有几个球呢？显然你把你摸出来的球数一数就知道盒子里面还剩下几个球。

这些都很简单，但是求解$V(20,20)$需要将递推式给写出来。当我一个赌局里面存在R个红球和G个绿球，那么我需要求解$V(R,G)$到底是多少。但是我一下写不出来，需要将其在继续推推导一下。

假设你有R个红球和G个绿球，你摸到红球的概率为$\frac{R}{R+G}$。且摸到红球之后你就会得到一块钱。得到一块钱之后，剩下的赌局就是$R-1$个红球和$G$个绿球。此时赌局的期望为$V(R-1,G)$。同理可得，以$\frac{G}{R+G}$的概率摸到绿球，此时你就会损失一块钱，且你面临的赌局的期望就是$V(R,G-1)$。因此，当盒子里面存在R个红球和G个绿球时，你再摸一个球，你的期望收益。但是如果期望收益是负的，那么你就可以结束赌局，不摸了。所以你需要比较这个期望收益和零之间的大小关系。
$$V(R,G)=\\max\{0,\frac{R}{R+G}[1+V(R-1,G)]+\frac{G}{R+G}[-1+V(R,G-1)]\}$$

所以上述就是这个值函数的值，没有直接给出一个具体的表达式，但是却给出了一个相邻值函数的递推关系式。将$V(R,G)$表示为$V(R-1,G)$和$V(R,G-1)$这两个值函数的函数。然后接下来怎么处理呢？因为我们是知道$V(0,0)、V(0,1)、V(1,0)$的值，逆向递推推过去就可以求出$V(20,20)$的值了。

假设我们开始计算$V(1,1)$，可知
$$V(1,1)=max\{0,\frac{1}{2}[1+V(0,1)]+\frac{1}{2}[-1+V(1,0)]\}\\=max\{0,\frac{1}{2}\}=\frac{1}{2}$$
上述计算地意义是，如果你这个盒子中只剩一个红球和一个绿球的时候，你就去摸。摸出红球你就结束，摸出绿球你就继续摸球，直至绿球也被摸出来，结束赌局。所以你的期望收益是$\frac{1}{2}$，即$\frac{1}{2}$的概率第一把摸到红球得到一元钱，也存在$\frac{1}{2}$的概率摸到绿球，之后再摸红球，获得0元的收益。

以此类推：
$$V(1,2)\\=max\{0,\frac{1}{3}[1+V(0,2)]+\frac{2}{3}[-1+V(1,1)]\}\\=0$$
上述计算的含义是，如果盒子里面存在一个红球和两个绿球，不论你摸还是不摸都拿到零。

$$V(2,1)\\=max\{0,\frac{2}{3}[1+V(1,1)]+\frac{1}{3}[-1+V(2,0)]\}\\=\frac{3}{4}\\V(2,2)=max\{0,\frac{1}{2}[1+V(1,2)]+\frac{1}{2}[-1+V(2,1)]\}\\=\frac{2}{3}$$

将上述的计算结果列成一个表格，可以写为：
$$\begin{matrix}
  & G=0 & G=1 &G=2 \\
 R=0 & 0 & 0 &0 \\
 R=1 & 1 & \frac{1}{2} & 0\\
 R=2 & 2 & \frac{4}{3} &\frac{2}{3}
\end{matrix}$$
什么时候应该停止这个赌局，当期望支付等于零的时候就应该停止这个赌局。所以在取零的位置就因该停止。所以当盒子中有0个红球1个绿球的时候就应该停止。当盒子中有0个红球和2个绿球的时候就应该停止。当然虽然计算比较繁琐，但是思想是比较简单的。通过计算机计算可得$V(20,20)=2.296$，显然只是一个正的期望效用。这个正的2.296正是这个赌局里面随时停止的这个期权的价值。为什么？因为没有这个随时停止的权利，这个赌局确定的给你带来的期望收益是0，但是一旦存在这个随时停止的权利，这个赌局给带来的期望效用为2.296。这个权利的价值就是2.296。

所以通过这个例子既可以很好的看出在动态规划里面停时是如何计算的。关键就是上述这个递推关系式，上述递推关系式就是著名的贝尔曼方程。其思想就是将大的优化问题拆解成了小的优化问题。不断拆解下去，将小的优化问题解决之后就可以解决大的优化问题了。$V(20,20)$我是不会算，但$V(0,1)$和$V(1,0)$是可以计算的，通过这中间的衔接方程就可以解决$V(20,20)$这个大的优化问题。并且在这其中的过程中我因该什么时候停止都计算的非常清楚。最优停时我也是知道的。

所以就将这个应用到美式期权定价上面去，看看美式期权如何定价。对于标的资产是不分红的股票的美式买权(Call)来说是和欧式期权价格是一样的，所以我们来给美式卖权(Put)定价。

我们来给出前提条件：

股票价格$S_0=100$元，当股票上涨就变成$S_u=200$元，股票下跌就变成$S_d=50$元。$S_{uu}=400，S_{ud}=100，S_{dd}=25$。对于无风险债券的回报为$e^{r}=1.25$。所以$u=2，d=\frac{1}{2}$，所以风险中性概率等于$q=\frac{e^r-d}{u-d}=\frac{1}{2}$。

假设我们给一个美式卖权定价(Put)定价。假设到期日为2时刻，行权价格为$K=100$。
计算European Put价格：
显然欧式卖权的未来的支付$p'_{dd}=payoff=max\{ K-S_{dd},0\}$，此时$p'_{ud}=0，p'_{uu}=0$。在风险中性概率的世界中，根据二叉树来计算$p'_{d}=\frac{1}{1.25}[0.5\cdot75]=30$，同理$p'_{u}=0$。可以计算出欧式卖权在0时刻的价格为：$p'_0=\frac{1}{1.25}[0.5\cdot30]=12$。所以欧式的卖出期权如果其行权价格为100的话，他现在的价格为12元。

计算American Put价格：
显然，美式期权在2时刻行权的话其收益和欧式期权的收益是一样的。在1时刻，当股票价格为200元的时候你是不会主动行权的，因为此时行权什么都拿不到。因此唯一有可能提前行权的时刻是在1时刻股票价格处于$S_d=50$的时候，此时美式卖权是一个实值期权。问题是，在这个地方美式卖权会不会提行权？此时美式卖权的价格$p_d=max{50,\frac{1}{1.25}[0.5\cdot75]}=50$。

前面的代表的是现在行权的话美式卖权可以获得的收益；后面表示的是如果不行权，你在未来的期望收益的折现值(在风险中性概率的前体下)只有30块钱。换句话说，如果你不行权，这个期权的价格会跌倒30块钱，你说你现在行不行权？显然行权。所以这里的期权的价格为50元而非30元，因为此时你行权了。

这事在0时刻的时候，因为此时股票价格为100元，如果行权你拿到的payoff是0，所以肯定是不会行权了。此时，$p_0=max\{0,\frac{1}{1.25}[0.5\cdot50]\}=20$。所以上述就是美式卖权在零期的价格为20元。

综上所示，比较美式卖权和欧式卖权的价格可以看出：欧式卖权为12元；美式卖权为20元。这里美式卖权的价格就是比欧式卖权的价格要高，为什么价格要高，因为提前行权了，给你了更多的灵活性。而且你也确实在1时刻的一个节点上提前行权了，既然你提前行权了，拿的就比持有到期的期权的收益要高，所以其价格就比欧式期权的价格要高。

这是我们两期的二叉树，在多期的二叉树之中，我们就应该在Excel中计算我们是否应该行权？当然也只有在期权是实值的时候才会考虑行权的问题，虚值的时候还考虑个毛线的行权。在实值情况下去判断这个期权是否应该去行权。公式不变，但是在期权实值的情况下增加一个判断的过程。所以这个判断加上以后，你就可以去计算美式卖权的期权价格。

讲完美式期权定价，我们来讲一讲类外一个东西，即按揭贷款。
$Mortgage$：买房时候大家都会遇到的问题，一般的人显然一下子无法拿出来一大笔现金，此时你就需要去银行借一点钱。自然你不能全去借款，自己还是需要掏一点钱出来的，这部分钱称之为首付($down\ payment$)。剩下的钱是找银行借的，但是一部分钱是找银行借的，一部分的产权就抵押给银行了。因为这个抵押贷款数额比较巨大，且借款时间都比较长，银行不可能借给你钱那么长时间不收取利息。所以本金和利息会逐渐的要求你返还。还款分为等额本金(Even Principal Payments)和等额本息(Even Total Payments)还款。

对于两种还款方式来说：
等额本金还款法是指每一期还的本金都是一样的，但是因为你不断的归还本金，你所欠银行的本金越来越少，每期还的利息从一开始的比较多，直至快结束时越来越少。

等额本息还款法是指每个月返还相同的本金+利息，直至这笔贷款全部还完。具体的来说是指每一个返还的本金是逐渐增加的，前期主要返还的是利息，后面利息越还越少，本金还的越来越多。

上述只是对按揭贷款的一个简单的介绍。按揭贷款有一个特点，其中含有一个期权即(embedded option of advance payment)，也就是说其中含有一个提前还款的期权。为什么必须要存在这么一个期权？因为对于房子来说，我买了之后很有可能是需要将来卖出去的。但是如果我买房子是产权被抵押了，即产权不在我手里时，我想卖是卖不掉的。也就是说，如果其中不含有这个期权的话，我的房子被抵押给了银行，我就会存在20年至30年的时间无法卖房子。这个的约束就是太大了，这样的话就不会有人愿意向银行借款。所以因为有这种买房的可能性，所以银行必须给大家一个权利，我如果想卖房，我就可以提前将房子的贷款给还了然后再去卖房。所以这个按揭贷款之中存在一个期权。因此要给按揭贷款估价，就变得十分复杂，有可能这个人就提前还款了。所以说，我们现在来计算如何给按揭贷款定价。为什么要给按揭贷款定价，因为银行需要将按揭贷款卖出去回收现金然后在发新的按揭贷款。比如资产证券化。资产证券化就要求给抵押贷款定价。

重要的问题是抵押贷款在什么时候会被提前还款？当然卖房子的时候就会考虑提前还款。还有一种可能性是利率下降的时候，如果你是以5%的利率向银行借钱，然而央行的利率基准下调了，变成了2%，此时你就有动力提前还款，以更低的利率借款。

所以我们在这里就要计算抵押贷款的价值是如何受利率变化的影响？所以要给出一个利率的走势。对于抵押贷款来说，它其实是一个有关利率的衍生品。之前看的期权是股票的衍生品，但是标的物是利率的衍生品其实较股票的衍生品来说是非常庞大的。所以要计算利率的衍生品，首先要把底层资产，也就是利率的变动给刻画出来。同样我们还是使用二叉树。

假设市场无风险利率在0期的时候为$r_0$，在1期和2期的利率分别为$r_u、r_d、r_{uu}、r_{ud}、r_{dd}$。这里给出在风险中性条件下上涨和下跌的概率为$q$。

并且假设剩余的未还本金($unpaid\ principal$)为：$B_0、B_1、B_2$。
其中$B_{t-1}-B_{t}$是我在这一段时间内需要偿还的本金数量。还有一个变量$\bar{r}$为贷款的借款利率，之所以加上一个横线，是因为我们假设这个贷款利率是不变的，当然也是为了简单起见。所以$\bar{r}B_{t-1}$就是我本期需要偿还的利息数量(interest payment)。所以我在$t$时刻需要支付的本金和利息的总和为$B_{t-1}-B_{t}+\bar{r}B_{t-1}$($total \ payment \ at\ t$)。这就是我们在$t$时刻需要支付的总和。

现在我们就要计算这个按揭贷款的价值。$Define\ value\ function\ V_s——value\ of\ mortgage\ after\ total\ payment\ at\ node\ s$(在节点$s$处，支付完了本期支付总和之后的抵押贷款的价值)
在这个节点之后，我就可以引出两个节点分别称为$V_{su}$和$V_{sd}$。这就表示在未来一期利率上涨和利率下降这两种情况下值函数的值。


我们从简单的情况来计算：
1、假设我们不可以提前还款($No\ advance\ payments$)，那么值函数可以写为(风险中性概率下的资产的定价方程)

![](image/2022-02-10-17-50-07.png)

$$V'_s=\frac{1}{1+r_s}[q(\bar{r}B_s+B_s-B_{su}+V'_{su})\\+(1-q)(\bar{r}B_s+B_s-B_{sd}+V'_{sd})]$$

在$V_s$这个节点(这一期的本息已经支付之后的抵押贷款价值)计算下一个su状态下，他需要给的支付包括：1、下一期的本息，即，$\bar{r}B_s$这一期未偿还的本金乘以利率得到下一期的利息+$+B_s-B_{su}$下一期需要偿还的本金。2、完成了下一期本息支付之后，按揭贷款剩余的价值$V'_{su}$。同理，对于另一状态sd来说，将上述的过程再走一遍，得到$V'_s$的完整的表达式。

这里假设我们采取等额本金还款法，每一期所还的本金数量是一样的，换句话说，无论未来的利率到底是如何变化的，每一期还款的本金数量相等，即$B_{su}=B_{sd}$。所以这个式子可以再写一步为：
$$V'_t=\frac{1}{1+r_t}[q(\bar{r}B_t+B_t-B_{t+1}+V'_{tu})\\+(1-q)(\bar{r}B_t+B_t-B_{t+1}+V'_{td})]$$
这是不存在提前还款情况下的贝尔曼方程。

假设可以提前还款($Advance\ Payments\ allowed$)：
如果可以提前还款的贝尔曼方程：
$$V_t=min\{B_t,\frac{1}{1+r_t}[q(\bar{r}B_t+B_t-B_{t+1}+V_{tu})\\+(1-q)(\bar{r}B_t+B_t-B_{t+1}+V_{td})] \}$$

假设我们计算一个具体的例子：
假设风险中性概率$q=0.5$，在0时刻的利率为$r_0=0.04$，在1时刻和2时刻的利率分别为：$r_u=0.08，r_d=0.02，r_{uu}=0.16，r_{ud}=0.04，r_{dd}=0.01$。假设初始借钱的总数$B_0=100$。采用等额本金还款法，且$B_1=50；B_2=0$。换句话说，每一期还款为50，分两期还完。且$\bar{r}=0.05$。在上述的假设前提下，这个按揭贷款在0时刻值多少钱？

![](image/2022-02-10-19-53-33.png)

首先我们知道，在最后这几个节点上面，剩余的本金数量为0，本金已近还完了。所以在最后几个节点上，还完本金之后啥也没有了，这个时候按揭贷款的价值等于0，即$V_{uu}=V_{ud}=V_{dd}=0$。

然后计算两种情况：不可以提前还款和可以提前还款

不可以提前还款：
在$V_u$这个节点，我在$u$这个节点完成当期的本息支付之后，贷款当期剩余的价值为:
$$V'_u=\frac{1}{1+0.08}[0.5\times(0.05\cdot50+50-0+V_{uu})\\+0.5(0.05\times+50+V _{dd})]=48.6$$

同理可得：$V'_d=51.47$，所以$V'_0=101.00$

可以提前还款：
在$V_d$这个节点，此时利率降低到0.02。而银行的合同上写的借款利率是0.05，从直觉上来说可能会提前还款。在$d$这个节点完成当期的本息支付之后，贷款当期剩余的价值为:
$$V_d=min\{50, \frac{1}{1+0.02}[0.5\times(0.05\cdot50+50-0+V_{ud})\\+0.5(0.05\times+50+V_{dd})]\}=50$$
在上述的比较中，右边这一坨的东西的值大于50，所以说再取最小值之后等于50，也就是说他会选择提前还款。
此时$V_u=min\{50,48.61\}=48.61$，再计算$V_0=100.29$。显然，$V_0=100.29<V'_0=101$。

为什么$V_0<V'_0$?如果按揭贷款有提前还款的权利，这个期权是给借款人的。借款人如果要动用这个权利，即提前还款是对借款人有利的。显然对借款人有利，也就是对放贷人(银行)不利。所以提前还款总是在银行不希望他还钱的时候。比如说，当利率为0.02的时候，银行将钱投在别的地方获得不了太高的利润，银行是希望按揭贷款可以帮他赚取更高的利润，但是这个时候借款人就会找银行来给他提前还款，所以按揭贷款提前还款总是在银行不希望它提前还款的时候来主动还款。

但是在利率涨到0.08的时候，银行是希望贷款人提前还款的，因为此时将资金回收再以0.08的利率贷出去实现收益。但是此时借款人都不傻，不会来提前还款的。所以在银行希望他提前还款的时候别人是不会来提前还款的。所以提前还款的权利是给借款人的，这个权利是有价值的，他让借款人受益，当然就让银行受损，所以提前还款权利的存在就降低了抵押贷款的价值。但是没关系，即使你降低了抵押贷款的价值，但是我还是可以计算抵押贷款到底值多少钱。而算的核心就是最优停时，其实就是计算的每一步都判断一下是否应改停时。所以多期的也可以计算，无非是在Excel中每一步增加一个判断的过程，到底是不是应改停止。

最后，再做两点评论。
有关按揭贷款的价值计算也是近几十年的发展，原来人们是计算不出来按揭贷款到底值多少钱的。因为这个东西你不会给期权定价，你就不会给按揭贷款定价。所以不要觉得期权是人为创造的，他是有他的实际需求的。按揭贷款是一个非常传统的项目，但是给按揭贷款定价也就是近几十年的事情，也就是在期权定价体系建立起来之后，人们才逐渐的可以给按揭贷款定价。那能够给按揭贷款定价之后人们才可以把按揭贷款给卖出去值多少钱，这个按揭贷款的市场就发展起来了，通过资产证券化将按揭贷款打包卖出去。但是这也催生了一些问题，比如在按揭贷款不可以被定价的时候，这东西银行要持有终生的，一直在资产负债表上趴着，直至按揭贷款被完全还完，所以银行发放按揭贷款还是非常谨慎的，要分析这个按揭贷款能够按期归还的可能性有多高。一旦这个东西可以被定价甚至打包交易之后，银行发了按揭贷款之后转手就卖掉，这个东西就从他的资产负债表上出去了，这个时候银行发放按揭贷款就没有以前那么审慎了，又因为美国在次贷危机之间，房地产市场一直蓬勃生长，每个人都想参与这个市场之中，带来投资机会。这个时候银行就大量的发放次级的按揭贷款(向没有什么还款能力的人发放贷款)($NINJA$忍者贷款($No\ income\ ,No\ Job\ ,No\ Asset$))。在房价上涨的时候，这个问题其实不大，还不了钱大不了银行把房子收回在转手卖出去，反正房价还是在不断上涨的。但是一旦房价大规模下跌，那些人就开始不还贷款了，不断违约，基于这些次级贷款的MBS就开始不断违约，引发次贷危机。所以说，次贷危机与金融技术和理论的发展存在一定的关系，但是也不能全面的否定金融理论和技术发展。


还有一点是，在给按揭贷款定价的时候，期权对于按揭贷款定价是存在很大的影响的，有这个期权和没有这个期权按揭贷款的差别是很大的。但是期权的价值又取决于拥有期权的这个人会不会去主动地行权，万一有些人太笨了，不会提前还款。或者是太有钱了，不在乎这点小钱。所以说，不同的人在面对利率变化的时候，是否会行使提前还款的概率是不同的。或者换一种说法，不同的人对利率的敏感性是不一样的。

假设这么一种情况，银行放了100亿的贷款出去，中间因为利率下来了，有一半的人提前还款了，所以贷款的规模就收缩一半。后来利率又涨回到原来的水平了，因为有一半人提前还款，所以贷款的规模从100亿降到了50亿。那么我的问题是是不是**剩余的50亿贷款的市场价值**就是之前**100亿贷款市场价值**的一半？显然不是，剩余的50亿贷款的市场价值会高于100亿贷款市场价值的一半，为什么？因为对利率敏感的人会提前还款，剩下没有提前还款的人就相对来说没有那么利率敏感。他们动用提前还款期权的概率就比较小，所以期权的价值就比较小，所以对贷款的负面影响就比较小。所以本金从100亿收缩到50亿，但贷款的价值下降的幅度不会超过50%，50亿的贷款价值会比之前的100亿贷款价值的一半要多，因为借款人的平均利率敏感性已经发生变化了，平均的利率敏感性已经下降，因为那些特别敏感的人已经提前还款了，剩下的人不太会提前还款了。

所以如果你对借款人是否会提前还款倾向估计的比市场估计的要准，那就意味着你给按揭贷款定价就比别人更准，也就是说你可以进行套利获得收益。美国就有机构干这个事，通过考虑各种因素来对按揭贷款进行定价，从市场的错误定价上面获得收益。


##第十八讲：
Black—Scholes-Merton Formula
我们的无套利定价的理论体系是从资产定价的基本定理出发，找出存在的风险中性概率也即等价殃测度。然后把资产的定价问题归结为一个在风险中性世界下求期望的问题。今天就是把这套理论运用到连续时间模型里面来推导布莱克斯科尔斯公式。但事实上，在历史上，我们之前学习的这些定价理论都是在B-S公式出来之后才逐渐的被人们所发掘。在B-S公式出来之前，大家对衍生品定价都是凭感觉的，并不知道这玩意到底是如何定价的。所以说他是开启衍生品定价一切的东西。

所以我们今天的任务是推导这玩意。所以，今天的板书会存在很多的数学推导。但是却要有耐心。今天的推导分为五个部分：

1、正态分布、对数正态分布($Normal，log-normal$)
2、在前期二叉树定价的时候我们是如何给资产定价的？首先我们给出标的资产(股票)未来运动的数学描述，基于这个数学描述去给出与这种资产相关的衍生品的价格，所以这里也一样，要给出期权的定价公式，就该给出股票在连续时间下数学描述。这个数学描述就是布朗运动(Brownian Motion)(Wiener process)
3、接下来就要研究股票价格的运动，在高数中研究一个东西的运动就要在非常短的时间内，这个运动是什么样子的这就是微分。同样还要注意这些非常短的运动累积起来的效果是什么样子的，这是积分。所以要通过微积分来研究运动，但是确实在随机的状态下面研究微积分，所以要使用随机微分和随机积分。(Stochastic Differentiation(Ito's lemma)，Integration)
4、推出一个偏微分方程，即Black-Scholes partial Differentiation Equation，解这个方程，就可以推出B-S公式
5、Martingale Method to B-S 鞅方法求解B-S公式


第1部分：正态分布和对数正态分布
1、Central Limit Theorem(中心极限定理)
假设一个随机的事情受到大量因素的影响，且这些因素中没有一个是占主导性的。如果是这样的话他的分布就是正态分布。

对于一个正态分布$Normal$，随机变量$x \sim \phi(\mu,\sigma^2)$，密度函数可以写为：$f(x)=\frac{1}{\sqrt{2\pi\sigma^2}}e^{-\frac{(x-\mu)^2}{2\sigma^2}}$。当然还是可以标准化为标准正态分布。令$t=\frac{x-\mu}{\sigma},t\sim \phi(0,1),f(t)=\frac{1}{\sqrt{2\pi}}e^{-\frac{t^2}{2}}$。定义标准正态分布的分布函数为$N(U)=P_r(t\le U)$，即$t$小于$U$时所取得概率。即在图像中是当$x$取$U$左边的区域的面积。上述图像是以0为对称轴，他有这么一个性质，$N(-U)=1-N(U)$。

前人使用正态分布来估计资产价格，但是存在问题，因为正态分布是可以取到负数的，但是资产价格显然不能为负数。所以为了保证资产价格总是为正的，我们就假设股票价格的对数服从正态分布。这里就引入一个概念，对数正态分布(log-normal)。
其实这里的意思是，股票价格对数的变化 服从正态分布。
即$log\ S_T-log\ S_0 \sim \Phi(\mu,\sigma^2)$，可以写为
$$log\ S_T-log\ S_0=log(\frac{S_T}{S_0})=log(1+\frac{S_T-S_0}{S_0})\approx\frac{S_T-S_0}{S_0}$$

上述近似是假设$\frac{S_T-S_0}{S_0}$为无穷小量的时候给出的近似。所以股票价格的对数差分是什么意思呢，就是股票价格的变化率。所以我们把股票价格的变化率将其描述为一个正态分布。

假设$log\ S_T-log\ S_0=x$，就有$S_T=S_0e^x$，此时$x$服从正态分布。然后未来我们是要对股票价格求期望，这个期望中就含了一个以自然常数为底的一个指数，对这个玩意如何求期望?即我们要计算$E(e^x)$。(这不就是随机变量函数求期望吗？)

显然这个期望就等于：
$$E(e^x)=\int_{-\infty}^{+\infty}e^x\frac{1}{\sqrt{2\pi\sigma^2}}e^{-\frac{(x-\mu)^2}{2\sigma^2}}dx$$
(上述积分是否可以通过$\Gamma$函数来求解？)
令变量代换$t=\frac{x-\mu}{\sigma}$可得：
$$E(e^x)=e^{\mu+\frac{1}{2}\sigma^2}\int_{-\infty}^{+\infty}\frac{1}{\sqrt{2\pi}}e^{-\frac{(t-\sigma^2)}{2}}d(t-\sigma^2)\\=e^{\mu+\frac{1}{2}\sigma^2}$$

写的更清晰一点：若$log\ x \sim \phi(\mu,\sigma^2)$，则$E(x)=e^{\mu+\frac{1}{2}\sigma^2}$。

第2部分：
给出对股票价格在连续时间下的一个数学描述。在离散时间下的数学描述就是二叉树。现在的问题是我们要把这这个问题推广到连续时间下进行讨论。这里我们需要一个数学的模型来模拟连续时间下的股价。

这里就有一个历史发展的过程。1827年一个生物学家Brown就发现花粉在水中做着不规则的运动，这个运动就称为布朗运动。到1905年，爱因斯坦认为水分子在做不规则的运动，使得花粉在不断地做着不规则的运动。到了1923年数学家维纳Wiener就给出了这个随机运动的数学模型，所以这个随机过程就叫维纳过程。

为什么花粉的运动和股价存在联系，因为划分的运动是随时受到大量的不确定的因素影响。有大量的水分子在撞击，且每个水分子都不是起主导性的作用的，所以水分子的随机的撞击使得布朗运动中就有一种正态分布的概念出来了，就是正态分布。同理，股票价格也是如此，在同一时刻存在大量的因素来影响着股票价格。比如这个人有这样的消息，那个人有那样的想法，都会对股票价格产生影响。但是又没有一个因素起决定性作用的情况下就会使得股票价格的运动和花粉微粒的运动是类似的。所以我们可以将描述花粉微粒的运动过程的维纳过程可以用来描述我们的股票价格运动，这样就建立起联系了。

但是，从数学上建立维纳过程是很复杂的。这个估计得学习到高等概率论才会给你讲述，这里我们就给出一些直观的映像，不追求数学的严谨，尽可能的将其中的数学思想给体现出来。

所以从离散时间开始推导出布朗运动。布朗运动是离散时间下的随机游走的连续化。什么是随机游走？Random Walk。给出一堆随机变量，且这些随机变量都是独立同分布的，即$\varepsilon_t\sim\phi(0,1)$。
假设我有一系列随机变量$\{Z_t\}$，且$Z_1-Z_0=\varepsilon_0，Z_{t+1}-Z_t=\varepsilon_t$。所以$Z_t$是如何定义的？两个$Z_t$之间的差是一个随机变量。这个随即变量还是服从正态分布的，且相互之间还是独立的。$Z_t$就叫随机游走。当然你也可以将其理解为一个位置，每个时刻他都会从正态分布里面拿一个实现值出来，如果是正的，他就朝着正的方向走多少距离，如果是负的，就朝着负的方向走多少距离。每次都是从标准正态分布中随机的抽取，抽出来是多少就移动相应的距离。所以这个移动的轨迹看起来就是随机的，这个过程就叫做随机游走。这个随即游走他是一系列的随机变量。你看到一些随机变量第一反应就是计算均值和方差。计算期望$E(Z_t-Z_0)=E(\sum_{j=1}\varepsilon_{t-j})=0$所有的随机变量都是独立的且均值为0，故上述的期望也是0。他的方差为$Var(Z_t-Z_0)=E(\sum^{t}_{j=1}\varepsilon_{t-j})^2=t$。所以这个随机变量的标准差就是$\sigma(Z_t-Z_0)=\sqrt{t}$。在之前讲二叉树的时候，为什么那个时候会出现根号？现在我们可以解释了，一个随机游走的变量他的方差随时间的推移而线性的拓展，而他的标准差随时间的平方根拓展。
上述是随机游走的过程，将这个过程写的更为一般化可以写为：
$$Z_{t+\Delta}-Z_{t}\sim \phi(0,\Delta)$$

在离散时间里面，随机游走可用上述的表达式来表示，此时$\Delta$取的是正整数。而现在我们将其扩展到连续时间，此时我们就要求$\Delta$是正数就可以了，不一定是正整数。所以取正数的时候他就变成一个连续的时间了。所以把离散的随机游走连续化就变成一个布朗运动了。

所以给出一个定义：布朗运动：
Definition：18.1
${X(t),t\ge 0}$这是一个连续的随机变量，随着$t$的连续变化，这个随机变量的取值在不断地连续变化。这个东西叫做布朗运动，如果它满足以下的条件：
1、$Process\ with\ independent\ increments$(独立增量过程)
2、$\forall s,t>0，X(s+t)-X(s)\sim \phi(0,\sigma^2t)$
3、$Continuous$

解释一下第一点的问题，什么叫独立增量过程？

![](image/2022-02-11-17-24-43.png)

假设存在一条时间轴，上面存在不同的点，假设存在$X(1)、X(2)、X(3)、X(4)$，且$X(2)-X(1)$和$X(4)-X(3)$是两个服从正态分布的随即变量。独立增量过程讲的是，如果这两个随即变量对应的时间段是不重合的，没有交集的。那么这两个随机变量就是相互独立的。这就叫做独立增量过程。什么时候有关系？如果两个随机变量所对应的时间段相交，那么就有相关性了。

第3部分：
研究这个布朗运动或者说是维纳过程。研究这个运动，就要从微分和积分两个方面来研究。先讲随机微分($stochastic\ Differentiation$)。
对布朗运动的微分：$d_{zt}=\underset{\Delta\to 0}{lim}Z(t+\Delta)-Z(t)$
因为$\Delta>0$，所以取极限是从上面来趋于0的。上述微分在离散的条件下对应的就是$\varepsilon_t$。

但是上述的微分也是一个随机变量，即$d_{zt}$也是一个随机变量。这个时候我们就要看看这个微分的期望和方差到底是什么？
按照布朗运动的定义可知，$X(s+t)-X(s)\sim \phi(0,\sigma^2t)$，即$E(d_{zt})=0，dt=Var(d_{zt})=E[d_{zt}-E(d_{zt})]^2=E[d_{zt}]^2$，而$d_{zt}$的量级为$\sqrt{t}$。也即$d_{zt}\sim \sqrt{t}$。

有上述布朗运动的微分，就可以得到一些非常有趣的结论，比如说**布朗运动这个运动处处是连续的，但是处处不可导**。理论上说，$\frac{d_{zt}}{d_{t}}=\underset{\Delta\to 0}{lim}\frac{\sqrt{\Delta}}{\Delta}$显然上述极限不存在。所以传统意义上的导数就是不存在的。

所以通过布朗运动可以描述各种不同的的随机运动的过程。比如利用$d_{zt}$可以表示下述的随机运动：
$d_{xt}=\mu dt+\sigma d_{zt}$ 带漂移的布朗运动

上述的$d_{xt}$可以看成是$x$位置的变化，这个位置是由两部分组成，一部分是由$\mu dt$漂移项组成，后面这个是叠加的扰动$\sigma d_{zt}$。即是由一个确定性变化加上一个不确定的扰动组成的。
而我们用的更多的，也是接下来推导B-S公式所需要使用的随机变化是几何布朗运动。
股价的变化率，即$\frac{d_{S_t}}{S_t}=\mu dt+\sigma d_{zt}$服从布朗运动，这就叫做几何布朗运动。也可以写成$d_{S_t}=\mu S_t dt+\sigma S_td_{zt}$。接下来用它来描述我们的股价。

给出布朗运动之后，如果一个质点在做布朗运动，那么它的函数在做什么样的运动？比如说股价是在按照上述给出的微分的形式做运动，那么衍生品的价格是股票价格的一个函数，那么衍生品的价格会做着什么样的运动？把它的运动以微分的形式给写出来。这就是随机微分的法则。回答这个问题的工具就是伊藤引理(Ito's Lemma)。

伊藤引理：记住这么一个表格：
$$\begin{matrix}
  & d_{zt} & d_t\\
 d_{zt} & d_t & 0\\
 d_t & 0 & 0
\end{matrix}$$
即$d_{zt}\times d_{zt}=0，d_{zt}\times d_t=0，d_{t}\times d_t=0$

假设我现在有一个$x$做布朗运动，那么$y_t=f(x_t)$做着什么样的运动？
$d_{xt}=\mu dt+\sigma d_{zt}$
伊藤引理告诉我们将$y_t$按照泰勒展开展开到二阶，然后按照上面的表格将$(d_{zt})^2$变成$d_t$就可以了。
$$dy_{t}=\frac{\partial f}{\partial x} d_{xt}+\frac{1}{2}\frac{\partial^2 f}{\partial x^2} (d_{xt})^2\\=\frac{\partial f}{\partial x}(\mu dt+\sigma d_{zt})+\frac{1}{2}\frac{\partial^2 f}{\partial x^2} (\mu^2d_{t}d_{t}+2\mu\sigma d_{t}d_{zt}+\sigma^2(d_{zt}d_{zt}))\\d_{y_t}=(\frac{\partial f}{\partial x}\mu+\frac{1}{2}\frac{\partial^2 f}{\partial x^2} \sigma^2)d_t+\frac{\partial f}{\partial x}\sigma d_{zt}$$

伊藤引理告诉我们，当$x$在做布朗运动，那么$y_t=f(x_t)$作为$x$的函数，也在做着布朗运动。只不过$y_t$的漂移项和随机扰动项变得不一样了。所以有了伊藤引理，我们可以将 以布朗运动为自变量的 函数的运动给写出来了。所以伊藤引理是随机微分中的微分法则。因为伊藤引理的存在，所以在搞金融的时候喜欢使用连续时间，连续时间比离散时间要简单，因为伊藤引理使得很多在离散时间中近似的东西变成严格相等。



接下来进入另外一个方面，随机积分。在无穷小的时间里面用微分来描述随机变量的运动。现在我们想知道这些运动在一段时间里面累积起来的总体的效果是什么?这就是随机积分的问题。
$Stochastic\ Integration$：
$$\int_{t=0}^{T}d_{zt}=\underset{\Delta\to0}{lim}[(Z_{\Delta}-Z_0)+(Z_{2\Delta}-Z_{\Delta})+...+(Z_{T}-Z_{T-\Delta})]\\=Z_{T}-Z_{0}\sim \phi(0,T)$$

所以在随机积分和随机微分之中，$d_{zt}$和$\int_{t=0}^{T}d_{zt}$都是一个随机变量，且均服从正态分布。

对于同一个随机运动，既可以通过微分的形式去描述它，也可以通过积分的形式去描述它。如何用积分的形式加以描述？即对上述的微分形式求积分可得。
漂移布朗运动就变成：
$$\int_{t=0}^{T}d_{xt}=\int_{t=0}^{T}\mu d{t}+\int_{t=0}^{T}\sigma d_{zt}\\X_{T}-X_{0}=\mu T+\sigma \int_{t=0}^{T}d_{zt}\\X_{T}=X_{0}+\mu T+\sigma \int_{t=0}^{T}d_{zt}$$

所以这个随机运动的积分就被解出来了，$X_{T}$等于$X_{0}+\mu T+\sigma \int_{t=0}^{T}d_{zt}$，所以上述的$X_{T}$是一个随机变量，因为其中含有一个随机积分。且服从$X_{T}\sim \phi(X_0+\mu T,\sigma^2T)$。


第4部分：
介绍完了数学基础，现在我们来推导B-S公式。
假设我存在两个资产，一个是股票，以微分形式给出股价运动的方程。假设股价变动时几何布朗运动，即$d_{S_t}=\mu S_tdt+\sigma S_td_{zt}$。一个是无风险债券，即为$d_{Bt}=rB_tdt$。因为债券是给定的，所以不存在后面的随机扰动项。我们现在想求一个衍生品的价格，即为$C_t=f(t,S_t)$。现在我们推导衍生品的价格。

回忆之前我们做过的计算衍生品价格的方式，第一种办法中，我们通过股票和衍生品构建出一个无风险组合，既然是无风险组合就应该等于无风险债券的收益率。这个地方同样的思路，用股票和衍生品构建一个无风险的组合。

$Risk\ free\ portfolio：\ Stock \ Derivative :(D,-1)$
其中，股票和衍生品的数量分别为$D$支股票和-1个衍生品。
这个组合的价值就应该等于：$V(t,S_t)=-f(t,S_t)+DS_t$。现在我们要求这个组合是一个无风险的组合，什么意思？组合的价值不随股票价格的变化而变化，翻译成数学语言就是$\frac{\partial V}{\partial S_T}=0$。而$\frac{\partial V}{\partial S_T}=-\frac{\partial f}{\partial S_T}+D=0$，也即为：$D=\frac{\partial f}{\partial S_T}$。


现在来看这个组合价值的微分：
$$dV(t,S_t)=-df(t,S_t)+\frac{\partial f}{\partial S_T}d_{S_t}\\=-[\frac{\partial f}{\partial t}dt+\frac{\partial f}{\partial S_t}d_{S_t}+\frac{1}{2}\frac{\partial^2 f}{\partial S_T^2}(d_{St})^2]+\frac{\partial f}{\partial S_T}d_{S_t}\\=-\frac{\partial f}{\partial t}dt-\frac{1}{2}\frac{\partial^2 f}{\partial S_T^2}(\mu S_tdt+\sigma S_td_{zt})^2\\=-\frac{\partial f}{\partial t}dt-\frac{1}{2}\frac{\partial^2 f}{\partial S_T^2}\sigma^2 S_t^2(d_{zt})^2\\=-(\frac{\partial f}{\partial t}+\frac{1}{2}\frac{\partial^2 f}{\partial S_T^2}\sigma^2 S_t^2)dt$$

既然它是一个无风险组合，就意味着：
$$dV(t,S_t)=rV(t,S_t)dt\\-(\frac{\partial f}{\partial t}+\frac{1}{2}\frac{\partial^2 f}{\partial S_T^2}\sigma^2 S_t^2)dt=(-rf+r\frac{\partial f}{\partial S_T}S_t)dt\\\frac{\partial f}{\partial t}+rS_t\frac{\partial f}{\partial S_t}+\frac{1}{2}\sigma^2 S^2_t\frac{\partial^2 f}{\partial S_T^2}=rf$$

上述是一个有关$f$的二阶偏微分方程，给出方程的约束条件，求解微分方程。假设给一个$European\ Call$定价，当到期日时，$f(T,S_T)=max\{S_T-K,0 \}$，结合上述的偏微分方程就可以解出来B-S公式。

所以上述的$\frac{\partial f}{\partial t}+rS_t\frac{\partial f}{\partial S_t}+\frac{1}{2}\sigma^2 S^2_t\frac{\partial^2 f}{\partial S_T^2}=rf$被称为$B-S \ PDE$。

但是这个二阶偏微分方程是不一定有解的，即使有解也不一定可以解的出来。但是比较好的是这套理论体系是布朗搞花粉搞出来的。所以除了搞金融的这帮人会研究这个，玩物理的分子物理学界也会对这个感兴趣。所以B-S在得到这个方程的时候，他们不会解，但是他们发现物理学家把这个方程给解出来了。这个方程在物理学中就是热扩散方程。所以这就是第二种推导B-S公式的方法，求解偏微分方程求解B-S公式。

第三种求解$B-S$公式：鞅方法

债券价格：$d_{Bt}=rB_tdt$
对债券价格的对数求微分：$d(log\ B_t)=\frac{1}{B_t}d_{B_t}=rdt$
再对上式求积分可得：
$$\int^{T}_{t=0}d(log\ B_t)=\int^{T}_{t=0}rdt\\log\ B_T-log\ B_0=rT\\ B_T=B_0e^{rT}$$


股票价格：$d_{S_t}=\mu S_tdt+\sigma S_td_{zt}$
对股票价格的对数求微分(伊藤引理(展到二阶项))：
$$d(log\ S_t)=\frac{1}{S_t}d_{S_t}-\frac{1}{2}\frac{1}{S^2_t}(d_{S_t})^2\\=\mu dt+\sigma d_{zt}-\frac{1}{2}\frac{1}{S^2_t}\sigma^2S^2_tdt\\=(\mu-\frac{1}{2}\sigma^2)dt+\sigma d_{zt}$$

类似的，对等式两边求积分可得：
$$\int_{t=0}^{T}d(log\ S_t)=(\mu-\frac{1}{2}\sigma^2)\int_{t=0}^{T}dt+\sigma\int_{t=0}^{T}d_{zt}\\log S_t-log \ S_0=(\mu-\frac{1}{2}\sigma^2)T+\sigma\int_{t=0}^{T}d_{zt}\\S_T=S_0+exp[(\mu-\frac{1}{2}\sigma^2)T+\sigma\int_{t=0}^{T}d_{zt}]$$

此时，股票价格等于零时刻的股票价格乘上一个自然常数为底的一个指数。指数上的这一坨是一个呈正态分布的变量，所以股票价格满足的是一个对数正态分布。

由对数正态分布的性质可知：
若$x\sim \phi(\mu,\sigma^2)$，则$E(e^{x})=e^{\mu+\frac{1}{2}\sigma^2}$。
考虑上面求出来的东西可知，$(\mu-\frac{1}{2}\sigma^2)T+\sigma\int_{t=0}^{T}d_{zt}$服从的正态分布为$\phi((\mu-\frac{1}{2}\sigma^2)T,\sigma^2T)$。代入可得股票价格的期望为:
$$E(S_T)=S_0e^{(\mu-\frac{1}{2}\sigma^2)T+\frac{1}{2}\sigma^2T}=S_0e^{\mu T}$$
但是我们计算出来贴现的股票价格不符合鞅性，因为如果按照无风险利率去贴现结果是不对的。但是他不是一个鞅很正常，因为上述的期望是在真实世界中做的。

在我们的假设中，存在两个资产，且是一个完备市场，又不存在套利机会，所以一定存在一个等价鞅测度，在这个等价鞅测度下，所有资产的贴现价格都是鞅，所以在这里我们直接引用这个结论。

从无套利且完备市场，就一定可以推出存在唯一的一个等价鞅测度。在这个等价鞅测度下，股票的贴现价格都是鞅。即：
$$\hat{E}(S_T)=S_0e^{rT}$$
注意上述的期望是在等价鞅测度下做出的，所以会有一个帽子。且在等价鞅测度下，这个$e^{rT}$上的字幕是$r$。
反之，我们会想到，当股票价格等于什么会使得其期望满足鞅性？可得：
$$S_T=S_0\ exp[(r-\frac{1}{2}\sigma^2)T+\sigma\int_{0}^{T}\hat{d}_{zt}]$$

和之前求出来的式子相比可知：这两个式子的差别在连个地方，一个是漂移项不再是$(\mu-\frac{1}{2}\sigma^2)T$，而是$(r-\frac{1}{2}\sigma^2)T$。第二个不同之处在于$\hat{d}_{zt}$是在等价鞅测度下面的布朗运动。所以我们给出了在等价鞅测度下面的股票价格。


接下来要算的期权($Call$)价格为$C_0=e^{-rT}\hat{E}[max\{ S_T-K,0\}]$，接下来就要计算$\hat{E}[max\{ S_T-K,0\}]$这个期望。
在等价鞅测度下面，股票价格是服从正态分布的，即：$log\ S_T\sim \phi[log \ S_0(r-\frac{1}{2}\sigma^2)T,\sigma^2T]$，均值变了，但是方差没有变。(戈萨诺夫定理保证)。
为了好算，定义$log \ S_T=a+bu$，且$u\sim\phi(0,1)$。且
$a=log S_0+(r-\frac{1}{2}\sigma^2)T$
$b=\sigma\sqrt{T}$
$a+\frac{1}{2}b^2=log S_0+rT$

现在要知道一个阈值，什么时候期权会行权？
$S_T=e^{a+bU}=K\\ U=\frac{logK-a}{b}=\frac{logK-logS_0-(r-\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}}$

现在来求解这么一个期望：
$$\hat{E}[max\{ S_T-K,0\}]=\int_{U}^{+\infty}(e^{a+bu}-K)\frac{1}{\sqrt{2\pi}}e^{-\frac{u^2}{2}}du\\=\int_{U}^{+\infty}\frac{1}{\sqrt{2\pi}}exp[-\frac{1}{2}(u-b)^2+a+\frac{b^2}{2}]du-K[1-N(U)]\\=e^{a+\frac{1}{2}b^2}\int_{U-b}^{+\infty}\frac{1}{\sqrt{2\pi}}exp[-\frac{(u-b)^2}{2}]d(u-b)-KN(-U)\\=e^{a+\frac{1}{2}}[1-N(U-b)]-KN(-U)\\=S_0e^{rT}N(b-U)-KN(-U)$$


$$C_0=e^{-rT}\hat{E}[max\{ S_T-K,0\}]=S_0N(b-U)-e^{-rt}KN(-U)$$

$$C_0=S_0N(d_1)-e^{-rT}KN(d_2)\\d_1=b-U=\frac{log \ ( S_0/K)+(r-\frac{1}{2}\sigma^2)T}{\sigma\sqrt{T}}\\d_2=-U=d_1-b=d_1-\sigma\sqrt{T}$$

这就是我们看到的$Black-Scholes\ Formula$。


##第十九讲：
今天讲的是无套利定价理论的最后一讲，所以之前给大家复习一下，无套利理论的大致框架是什么样的。
在一个完备的市场里面，且无套利的情况下，由资产定价基本定理可知存在一个唯一的状态价格向量$\varphi$，使得其可以用来给所有资产定价。所有资产的价格可以表示为：$p=\sum_s\varphi_s x_s$，即其价格等于以状态价格为权重的，未来支付的加权平均。这个式子对所有资产都成立，自然对无风险资产也是成立的。无风险资产现在的价格应该等于$e^{-r}$，在未来的支付为1。所以可以得到：$e^{-r}=\sum_s \varphi_s$。这里我们可以定义一个$q_s=\frac{\varphi_s}{\sum_s \varphi_s}=e^r \varphi_s$。

将$p$改写为：$p=e^{-r}\sum_s e^r\varphi_sx_s=e^{-r}\sum_sq_sx_s$。按照定义，各个$q_s$相加起来等于1。所以，我们将其视之为概率，即风险中性概率。资产定价转换成一个在风险中性世界中求期望的问题。即$p=e^{-r}E^Q[\tilde{x}]$。

在动态世界里面，我们还是遵循上述的思路，只不过我们采用了一个叠期望定理，更容易的求期望。$E_t(\tilde{x})=E_t(E_{t+1}(\tilde{x}))$。有可能在t时刻求解期望比较困难，但是在t+1时刻求解期望是一个比较简单的。所以将一个比较难计算的问题转换为一个个比较简单的小问题。从尾巴上一个一个推过来，即逆向递推，比如在二叉树中的使用。

在动态过程中，还有一个特性。即在$t$时刻对一个资产的贴现价格(无风险利率贴现)求期望$E_t[e^{r(T-t)}S_T]=S_t$。这就是资产价格的鞅性。这也被称为是鞅方法。

上节课我们还是沿着这个东西，把资产价格运动的方程写出来。股票价格是布朗运动，无风险资产按照无风险利率增长。
$\frac{d_{S_t}}{S_t}=\mu dt+\sigma d_{zt}\\ \frac{d_{B_t}}{B_t}=rd_t$
按照这个前提下面，我们给出了期权的价格为：在风险中性概率下，(等价鞅测度下)去算的一个期望。(欧式买入期权)
$$C_0=\tilde{E}[max\{ S_T-K,0\}]=B-S\ Formula$$

这就是我们之前几讲的主要内容，定价的各个方面几乎都完善了。这一讲我们从别的方面进行展开。沿着资产定价基本定理的方向展开。如果说一个市场是完备的且还是无套利的，就存在着唯一的状态价格向量，来将资产价格表现为这样的形式：$p=\sum_s\varphi_s x_s$

但是这个形式可以被理解为右面这里是一个组合，是组合的价值。可以被认为是阿罗证券的组合(阿罗证券只在某个状态有1单位支付的证券)。所以如果是一个阿罗证券的组合，那么阿罗证券的数量由这个资产在各个状态下的payoff决定的。所以这个式子$\sum_s\varphi_s x_s$可以被认为是阿罗证券的组合的价值。所以说我可以把一个资产的价值表示为一个阿罗证券组合的价值。那说明，我用阿罗证券复制了这个资产，所以阿罗证券组合的价值等于资产的价值。为什么可以用阿罗证券复制资产呢?前提是你的这个市场中需要有所有的阿罗证券，所以也就是我们的前提假设，市场完备。 当我用阿罗证券组合来复制这个资产的payoff时，如果这个市场是无套利的，那么你就可以用阿罗证券组合的价值来给这个资产定价。

所以，我们所说的无套利分析，其中有一个非常核心的概念就是replication(复制)。一开始，我们的市场中是不存在阿罗证券的，只是存在大几种资产，构成了一个完备的市场。因为如果是完备市场，我们可以通过这些资产构建出阿罗证券。当我们说：“在完备市场中，任何一种资产价格都可以被阿罗证券组合所表示”其实也就是等价于说“在完备市场中，任何一种资产价格都可以被市场中所有的资产所复制出来”。所以，复制的概念就出来了。

所以复制的概念要求你得先有一个东西，并且还得存在一个价格，这样我就可以复制这个玩意给其他的资产定价，也就是说这是一个相对定价。(不可能从无到有的给一个东西定价，毕竟是复制出来的东西)。

复制完成了定价之后，我除了给出定价之外，我还得到一个副产品，即我知道如何通过别的资产来复制这个资产。这个复制中每个资产的权重我是知道的。那既然我可以将一个资产给复制出来，那我就可以做另外一件事情，即对冲这个资产(Hedge)。

所以在无套利定价的最后一讲，我们就来讲一讲对冲(Hedge)。
我们用一个资产组合去对冲另外一个资产组合的头寸。为什么需要对冲？可以举个例子。对于买入期权来说，理论上来说收益可以是无限的，只要股票价格不断地上涨。对于期权所有者来说这当然是一个好事，但是对于卖出这个期权的人(即买入期权的空头)可是遭了秧了，他的收益可以说是负无穷。显然对于他来说风险是非常大的。那他就要考虑采取一些办法来控制风险。不光是期权，资产价格都是在波动起伏中的，但凡你持有资产，你就将自己暴露在资产的价格变化所带来的风险之中。控制风险就要对冲。假设我是资产的多头，我就暴露在资产价格的风险之中了。那再搞出一个空头，这两个对冲一下就没有了，这是一种对冲的方法。

我们先来谈及几种不成功的对冲思路：
1、$naked\ position$(不对冲)：假设你是一个买入期权的空头，持有这个空头，并祈祷最坏的情况并不发生。
2、$covered\ position$(抵补头寸)：假设你是一个买入期权的空头，为了防止股票价格升高给你带来亏损，你直接买一张股票，万一股价上升，在期权上赔的钱可以用股票价格上涨来抵消。但是这种方式存在一个问题，即你只是规避了股价上涨的风险，那股票价格下跌呢？你不还是亏损？
3、$Stop-loss\ strategy$(止损策略)：既然抵补头寸会在股票价格下跌的时候带给我风险，那么这么搞不就行了：在股票价格大于$K$(行权价格)的时候买入，在股票价格低于$K$的时候卖出。一直盯着股票价格变动并在适当的时候买入和卖出股票，就能完美的解决问题。换句话说，当我卖出的期权处于实值状态的时候，我就采取$cover\ position$。在虚值状态下，我就将标的资产卖掉。
但是，这个策略就存在一个问题：第一，你不一定在$K$处可以将股票买入和卖出。第二，存在交易成本的问题，买卖股票是需要费用的。第三，虽然都是在$K$处买卖股票，但是资金是有时间价值的，买卖股票的资金的现值的总和未必是零。第四，假设股票就在$K$处来回的折腾，你还能不停的做交易吗？

这就是我们马上要讲的$Delta \ Hedge$：如何对冲衍生品？
$\Delta=\frac{\partial C}{\partial S}$是衍生品价格相对于标的资产价格的偏导数。(注：$\Delta$这个字母在金融中就特指的是这个含义)

在一个单期二叉树中：

![](image/2022-02-12-17-03-19.png)

假设无风险利率为$e^{r}$，之前在计算衍生品价格的时候，我们用股票和无风险资产来复制了衍生品。那是我们假设组合中包含$\Delta$数量的股票和$B$单位的无风险资产。所以，当股票价格变成$uS_0$时，组合的$payoff$就等于$\Delta u S_0+e^rB=C_u$，类似的，当股票价格变成$dS_0$时，组合的$payoff$就等于$\Delta d S_0+e^rB=C_d$。
此时这个组合就复制了这个衍生品，联立这两个式子可以得出：

$\Delta u S_0+e^rB=C_u\\\Delta d S_0+e^rB=C_d\\\Delta=\frac{C_u-C_d}{(u-d)S_0}\\B=\frac{uC_d-dC_u}{e^r(u-d)}$

上面是衍生品价格的变化，下面是股票价格的变化。所以其实就是这个偏导数。这个偏导数是什么含义？如果我要用标的资产和无风险资产去复制一个衍生品的话，那么这个复制组合中标的资产的数量就是这个偏导数，也即为$\Delta$。
同时，我们也可以对任意一个资产，比如我现在有一个衍生品的空头，我要去对冲这个空头，因为如果股价上涨我会亏损的很大。此时，最完美的方式是我再去购买一个期权的多头，这样两个一抵消，我就彻底的规避了风险。但是这样太傻，卖出期权又买入期权，花了手续费还没挣着钱。但是如果我通过复制的方式构建一个组合，这个组合可以对冲我这个期权空头，这样也可以控制我的风险。但是这么做是如何赚钱呢？假设我卖期权一个期权赚10元，我再构造一个组合，成本是8元。中间的差价是2元。虽然不多，但是禁不住期权卖的数量的庞大，依旧可以挣钱。

但是$Delta\ Hedge$存在一个特点，即这个$\Delta$在不同股价下面的具体数是不一样的，即它是随股票价格的变化而变化的。如果你要复制一个期权，你复制的组合是要持续去调整的，即这个$Hedge$是一个动态的过程，即$Dynamic\ Hedge$。

下面我们来看看这个$Dynamic\ Hedge$到底是怎么玩的。例如：假设股票价格为100元，假设是两期模型，在两种情况下，股票价格要么翻一番，要么减半。现在我卖出了一个买入期权，行权价格为100元，所以可以得到在第2期的$payoff$。
假设无风险利率为$e^{r}=1.25$，风险中性概率为$q=0.5$。
我们可以计算出期权的价格。
![](image/2022-02-12-17-34-54.png)

现在的问题是，我们如何构建出一个组合来去复制这个期权。当然，对于复制的组合来说，不仅仅是在第2期的节点上与期权的现金流相等，还要求这个组合在所有的6个节点上都要和这个期权的现金流是一样的，这样我们才可以说复制了这个期权，这样这个组合才可以对冲掉这个期权的头寸。

首先看一下这个期权的现金流，在uu这个节点上，期权的空头是亏损300元的，在ud这个节点上亏损额为0，在dd这个节点上亏损额也为0。在u和d这两个节点上，因为期权是没有到期，所以不存在现金流。在初始节点0上，因为我卖出一个期权，我获得48元正的现金流。

所以如何去复制这个期权？用$Delta\ Hedge$。
在每个节点计算$\Delta$，则在u这个节点计算$\Delta_u=\frac{C_{uu}-C_{ud}}{(u-d)S_u}=\frac{300-0}{400-100}=1$。在d这个节点计算$\Delta_d=\frac{C_{ud}-C_{dd}}{(u-d)S_d}=0$。同理可以计算出$B_u=-80,B_d=0$
在0时刻这个节点上$\Delta=\frac{C_u-C_d}{(u-d)S_0}=\frac{120-0}{200-50}=0.8$，同理$B_0=-32$。

所以，我们可以得出，在0时刻，我需要构建的组合为0.8股股票加上欠款-32元。在u结点处，我需要构建的组合为1股股票加上欠款-80元。在d结点处，我需要构建的组合为0股股票加上0元。

我们来验证一下，这个组合是否可以完美的付支出期权的现金流。
在0时刻，此时期权带给你的是正的48元的现金流，而如果我去购买0.8股股票，花费为80元，同时又借入32元。总的支出金额为48元，即资金流出了48元。所以卖期权赚了48元，买股票和借款花了48元，现金流相抵了。
同理，在u这个节点。因为我已近卖出了一个期权了，且手头上持有0.8股股票和借款32元。此时，我需要多买入0.2股股票，此时花费为40元。同时我还要还上一期32元的借款，加上利息我一共要还$32\times1.25=40$元。综上我花费了80元。此时我还要借入80元的现金。所以此时我的现金流就是0。

同理，在d这个节点，此时我股票的仓位为0，卖掉之前的股票挣40元，同时我还要还上一期32元的借款，加上利息我一共要还$32\times1.25=40$元。此时我的现金流为0。

在uu节点，此时期权已经到期了，这个组合是存在1股股票和80元的借款。在uu时刻，股票价格为400元。之前借的80元借款在本期需要偿还$80\times1.25=100$元。此时我卖股票赚到400元，减去还借款的100元，得到现金流为正的300元，正好将期权给我带来的300元的损失给对冲掉了。

在ud节点上，此时期权已经到期了，这个组合是存在1股股票和80元的借款。在ud时刻，股票价格为100元。之前借的80元借款在本期需要偿还$80\times1.25=100$元。此时我卖股票赚到100元，减去还借款的100元，得到现金流为0元。

同理在dd节点上也是如此。

因此我们看到，通过不断地调整组合，也就是不断地调整$\Delta$和$B$的取值，我们可以不断地复制组合，我就完美的把之前的期权所带来的现金流给对冲掉了。至于我挣钱的地方，就在初始买期权的地方，假设我不卖48元，我可以买50元，或者更黑心一点的可以买60元。这个期权的价格和真实的价格之间的差距就是你赚的钱，所以这个钱是没有风险的，是一个稳定的收益，即稳赚不赔。所以你靠这个去做生意是可以将生意做大的。
所以上述的东西就是$Dynamic\ Hedge$或者说称为$Dynamic \ Arbitrage$，当然业界也是这么用的。

上述是对一个衍生品做的$Delta\ Hedge$，当然你也可以将同样的思路运用在一个组合上面，对一个组合做$Delta\ Hedge$。算一个组合的$Delta$，比如一个组合$\Delta_\pi$就等于这个组合中各类资产的$\Delta$的加权平均。即$\Delta_\pi=\sum_{i=1}^N w_i \Delta_i$，其中$w_i$是资产的数量，比如多少张期权合约之类的。这就是一个组合的$\Delta$。对组合做对冲的时候，你可以用组合的$\Delta$去构建对冲这个组合的组合。因为每个资产的$\Delta$都是随时间的变化在不断变化，所以这个组合的$\Delta$也是随时间的变化而不断变化。对组合做$\Delta$对冲也是需要随时的进行动态调整。

还有一点呢，你要是拿股票做对冲是比较麻烦的，交易也不是那么方便，成本还比较高。现实中，我们在对冲期权的时候，我们使用股指期货来对冲期权。所以这里面我们就是交易的股指期货，而股指期货对应的是大盘变动，而期权的标的股票变动与大盘的变动还不是一样的，所以你要用股指期货对冲你的组合时，那么股指期货所选择的数量就取决于你的组合的$\beta$。简单来说，这个组合的$\beta$越大，即组合变动对大盘变动的敏感性很高，你要对冲这个组合所需要的股指期货的数量就比较多，反之，如果$\beta$比较小，单位组合所需要的股指期货的数量就比较小。思想是这样，具体的内容讲义上有。最后我们观察一点，$Delta\ Hedge$这个组合有一个特点，就是追涨杀跌。一开始是0.8股股票，股票价格一涨就多买，股票价格一跌，就抛售，其行为有点像散户。但是人家是对的。但是如果大家都在用$Delta\ Hedge$，就有可能出问题，有可能放大市场的波动。

现在回过头来看一看$Delta\ Hedge$，我用了$\Delta$这么多的股票和$B$这么多的债券，当然这都是在不断变化着的。把一个期权空头的风险完全对冲掉了。假设我们把这三个资产都组合到一起，有$\Delta$这么多的股票，有-1个期权和若干的债券。由这三个资产所构成的组合$\pi$的价值为$\pi=\Delta S-C+B_t$
那么这个组合的$\Delta_\pi=\frac{\partial \pi}{\partial S}=\Delta-\frac{\partial C}{\partial S}=\frac{\partial C}{\partial S}-\frac{\partial C}{\partial S}=0$
所以，当我们在做$\Delta$对冲的时候我们在做什么？其实我们是把我们要对冲的资产和我们构建起来的组合合并起来构成一个$\Delta$为0的组合。当这个组合的$\Delta$为0，就意味着这个组合的价值不因为标的资产价格的变化而变化。你就把标的资产价格变化所带来的风险给规避了。所以这种组合被称为$Delta\ neutral$，所以当我们在做$Delta$对冲的时候，其实我就要把我持有的所有资产调整为$Delta\ neutral$的一个组合，这样就规避了标的资产价格波动所带来的风险。所以$Delta$不是一个随便用的字母，他指的是衍生品或者是组合对标的资产价格的敏感性。而$\Delta$对冲就要根据$Delta$的变动来持续的调节组合中资产的比例。

所以，如果这个组合的$Delta$一直不变，那还是挺好的。但是如果$Delta$不断地、频繁的在变化，那么我就要不断地去调整我的组合。所以这个东西是由什么控制呢？就由我的$\frac{\partial \Delta}{\partial S}$来决定$\Delta$对标的资产价格的变化有多敏感？其实也就是衍生品价格对标的资产价格的二阶偏导数。
$$\Gamma=\frac{\partial \Delta}{\partial S}=\frac{\partial^2 C}{\partial S^2}$$

$\Gamma$就是组合的$\Delta$对标的资产价格的敏感性。所以$\Gamma$大的组合，就说明$\Delta$变动的越快，你去做调整就需要更频繁。反之，调整的越不频繁。但在现实中，你调整组合的速度是存在极限的。你不能说什么时间想调就调，哪怕买的是股指期货还有一个买卖的过程。所以现实中，调整组合的速率是存在上限的，这也是取决于不同投资者交易速度的能力，比如某些投资者的量化投资可能速度会很快，但是也还是存在一个上限；还有一些投资者调节速度会很慢。但是，当你在调节组合的时候，你就是在买卖资产，这个买卖会带来交易成本的，当你在很快的调节组合时，交易成本也在不断的增加。在现实中，$Delta\ hedge$的调整也不是特别快的。当你的组合里面的$\Gamma$很大，可能你调好一个$Delta\ hedge$，然后一下子这个组合的$Delta$突然变得非常大，你需要的对冲组合和你手里面的这个组合差别很大。这个时候就出现了一个对冲的误差$Hedge\ Error$。所以从某种程度上来说，$Gamma$反映了你的对冲误差。所以$Gamma$越大的组合你的对冲误差就越大。那显然你面临的风险越大。所以当我们把一个组合调节为$Delta\ neutral$之后，我们还希望这个组合的$Gamma$也小一点，最好$Gamma$为0，这样我就不用去修正我的对冲组合，我的$Hedge\ Error$为零。这是在理想的情况下。但是未必做得到，你可以无限的接近它。所以调整完了$Delta$之后你就可以去调整$Gamma$。类似的，不仅可以调节一个期权的$Gamma$，对于一个组合来说也是如此。所以称之为$Gamma$对冲。

那么如何调节$Gamma$？假设标的资产是股票，那么问题是股票的$Gamma$为多少？显然，$\frac{\partial S}{\partial S}=1$，再求一次偏导后得到的数字是零，即调节组合的$Gamma$增加或者减少标的资产股票的数量是没用的，因为它不影响$Gamma$的取值。只有添加一些非零的$Gamma$，比如说衍生品，期权之类的东西来调节组合的$Gamma$。

假设一个组合的$Gamma$为$\Gamma$，此时我再向其中添加一些期权，假设期权的$Gamma$为$\Gamma_A$，那么这个整体的组合的$Gamma$为$\Gamma+w_A\Gamma_A$，和之前一样是加权平均。此时，可以解出添加期权的数量$w_A=-\frac{\Gamma}{\Gamma_A}$。但是问题是，若果你将组合中添加入期权使得组合的$\Gamma$变成零，你如何保证组合的$\Delta$不变？显然此时组合的$\Delta$会变动的。所以，你再相应的加入股票，即标的资产。因为股票的加入不改变$\Gamma$的取值，使得这个组合的$\Delta$回到零。这样你就得到一个$Delta\ neutral$和$Gamma\ neutral$的组合。这样的话你就保护你的另外一种风险。如果说$Delta$对冲是对冲掉了股票价格小变化带来的风险，那么$Gamma$对冲是对冲掉了股票价格大变化带来的风险。为什么？因为如果一个组合的$Gamma$不是零，当股票价格变化非常大的时候你的$Delta$对冲的误差会非常大。那么股票价格变化非常大的风险你光靠$Delta$对冲是对冲不掉的。但是你把$Gamma$调成零了，即使股票价格大幅度变化，你的$Delta$对冲的误差也不会特别大。所以就把股票价格大变化的风险也对冲掉了。但是现实中，想要找到合适的期权去调节组合的$Gamma$不太容易，有可能成本还是很贵的。(期权买的时候数量很大，且卖期权的这帮家伙还会收取一部分手续费)。所以呢，一般来说，$Delta$对冲是每天都做的，同时监控你的组合的$Gamma$，如果不是特别大，那就放着。如果$Gamma$非常地大，那就得动一下，调整一下$Gamma$，之后再调一下$Delta$。

这里有两个东西，一个是$Delta$，一个是$Gamma$。共同点是二者均为希腊字母。所以这是有意为之的。在金融学中有一个名称：$Greek\ Letters$。希腊字母就是组合的价值对各种乱七八糟参数的一阶、二阶导数。也就是说这些希腊字母反映的是这个组合对各种参数变动的敏感性。所以这个$Delta$反应的是组合的价值对标的资产的敏感性。而这个$Gamma$反应的是组合的价值对标的资产的二阶的敏感性。还有一个东西，比如$Vega$是组合的价值对波动率的敏感性。即$\nu =\frac{\partial\pi}{\partial \sigma}$。当我要把一个组合调成$Vega\ neutral$时，和调节$Gamma\ neutral$类似，股票的$Vega$为零，为什么，因为在给定的股票价格$S_t$，既然是给定的价格就与历史的波动率和未来预计的波动率是无关的。但是我们来考虑一下，假设股票价格给定，未来股票价格的波动率可能非常大，也可能非常小。但是我们可知当未来股票价格的波动率越大地时候，以这个股票为标的的期权可能越值钱，反之波动率越小，期权越不值钱。可知，期权的价格是受到未来股票的波动率影响的。所以期权的$Vega$不等于零。
但是股票的$Vega$为零。显然，调节$Vega$和调节$Gamma$一样，调节期权，然后再添加股票，将组合的$Delta$调成零，当然可能调完之后$Gamma$不等于零，大不了再调节$Gamma$，使得整个组合的三个希腊字母都为零。所以，类似的希腊字母非常多，比如：$\Theta=\frac{\partial\pi}{\partial t}$，$\rho=\frac{\partial \pi}{\partial r}$，$Speed=\frac{\partial \Gamma}{\partial S}=\frac{\partial^3 \pi}{\partial S^3}$.
需要明确的是，这些希腊字母是组合对于某些因素的敏感性。既然组合对于某些因素敏感，也就是说你这个组合暴露在某些因素的风险之中。要去控制那些风险就要把这些因素给调下来，使其接近零。但是，理想情况是将所有的希腊字母调成零，但是这成本也太高了，所以现实中，只是每天将$Delta$调成零，安心睡觉。然后检测组合的各个希腊字母，风控部门给出每个组合的希腊字母的上限，如果在上限之下，可以不管，但是一旦超过，就要立刻调整，保证风险是可控的。当然注意不是所有希腊字母都是希腊文的，比如$Speed$，还有也不是所有的希腊文的都是希腊字母，比如$\beta$被用了。

再往下需要讲一个东西，即组合保险(Portfolio Insurance)。简而言之就是对冲的一个应用。比如说我有一个股票账户，我怕股票一旦价格下跌我的财富就缩水了，所以我想把股票价格下跌的风险给控制住，或者对冲掉。简单来说，你可以买一个卖出期权，这样你就可以把价格下跌的风险给规避掉。但是我们学过对冲可以知道，我们可以通过股票的操作策略来复制一个期权。我是想用期权去保护它，但是我又不是真的想买一个期权来保护它，而是通过一种交易策略来复制出一个期权，来保护我的股票账户的价值在股票价格下跌的时候不下降的太多。所以，这个组合保险就成为了一个股票操作的策略。这是一个投资策略，通过这个投资策略隐含的构造出了一个期权，来保护你这个账户的股票价值。但是这个策略是通过对冲的思想发展而来的。

下面看一个例子：
假设股价现在水平是100元，可能未来的价格上升为200元，也可能下跌至50元。无风险利率为$e^{r}=1.25$，风险中性概率为$q=0.5$。
![](image/2022-02-13-11-07-15.png)

假设我不想我的股票价格跌倒80元以下，我就去买一个$Put\ option$，行权价格为80元，即当股票价格跌到50元的时候行权，获得30元的收益，加上股价的50元，总计获得80元的总收入。
但是这么做是有成本的，我们计算一下期权的价格。
即：$C_0=\frac{1}{1.25}[0.5\times30+0]=12$元。最后，当股票价格跌倒50元时，你手里的钱总共为$80-12*1.25=65$元。所以你的总的财富保护在65元以上。

可能期权你买不到，所以我们可以考虑$Delta$对冲。计算$\Delta_0=\frac{0-30}{200-50}=-0.2$，也就是说，如果我要保证在第2期有至少80元的收益，我需要在第一期就卖出0.2股的股票，然后以无风险利率存入。这么操作之后，我所持有的股票数量为0.8股股票。这么操作之后，当我的股票上涨到200元的时候，我的股票价值$0.8\times200+20\times1.25=185$元。如果股票价格跌倒50元了，此时我的财富为$0.9\times50+20\times1.25=65$元。通过这样的手段，我可以将我下跌的风险给对冲掉了。

这种操作就叫做$Portfolio\ Insurance$。这只是单期，在多期的话就不断的做调整，将期权复制出来。反证你的组合一直受到期权的保护，这样你的组合就有了组合保险。思想使用期权来保护我的组合的价值，但是在操作上面就表现为是一种股票交易的策略。

但是这个$Portfolio\ Insurance$存在一个特性是追涨杀跌。和$Delta$对冲一样，当股票价格上涨的时候就买入，在股票价格下跌的时候就要卖出。组合保险在复制期权的时候就将这样的特点给带过来了。在上例中，当股票价格跌得更狠的时候，你就要卖掉更多的股票。也就是说，当你以组合保险的策略来操作时，他的特点是追涨杀跌。要是一两个人这么干，也就无所谓了。但是如果一群人都这么干了，那就会出问题了。在1987年10月19日，被称为黑色星期一。这一天没发生什么大事，但是美国道琼斯工业指数跌了20%，这是一个非常大的跌幅。为什么会这样？因为在上一周股票价格是跌了三天，累计跌了10%。跌幅主要是在上个星期五发生的。按照组合保险的策略，应该有120亿美元的股指期货被卖出，但是因为是在周末，没有全部完成交易，只完成了40亿美元的交易。所以在周一，人们都很清楚按照组合保险的算法，大概还有80亿股指期货需要抛出。既然预期会有那么多股指期货要卖出，大家都去卖，所以股票价格疯狂的跌。所以，$Portfolio\ Insurance$这个策略在1987年之后就没有那么流行了，因为大家认识到虽然叫做组合保险，但是如果大家都用这个策略的话就没有这么保险了，交易会变得非常拥挤。

那么这个东西和A股也有一定的联系，即2015年的股灾。在2015年，A股有一个新的业务叫做融资融券业务。简单的来说就是融资就是证券公司借钱给你炒股票，融券就是证券公司把证券借给你炒股票。随着融资融券业务的发展，股指走出了一个大的牛市。当然这也不是因为融资融券业务发展所造成的，但也是一个因素。但是证券公司在发放融资的时候是要保证资金的安全性，如果你的股票的价格低到一定的程度你就要追加保证金，如果不追加可能就要你强制平仓，或者将这个账户接管，卖出股票，收回资金。所以融资融券业务中，存在投资保险的逻辑，即券商为了保证自己资金的安全性，会强制的卖出股票换回资金的行为。在2015年6月份，宏观上金融市场资金堆积，形成价格泡沫。到2015年7月份，泡沫破灭了，股价开始跌了。组合保险追涨杀跌的特点得到体现，股指跌得就特别的快。跌其实没什么，但是问题是跌得特别的急，下跌的速度非常快。2007年股灾跌了70%，跌幅很大其实也没什么大事。但是2015年的不一样，在短时间内跌了30%。此时，市场陷入一种无流动性下跌。在2015年的时候，一千多支股票主动停牌了，因为看到跌得这么狠受不了，不交易了。剩下的几千多只股票千股跌停，你想卖股票是卖不掉的，证券公司想强制平仓？不可能的，无法卖出，随着股指的下跌而变成坏账。证券公司的坏账水平在3000-4000亿水平，所以证券公司大范围的现金困难。证券公司因为股价的下跌而资产负债表受到冲击。不光是证券公司，公募基金也是资金短缺，股市开市跌之后，基民们赶紧将自己的基金赎回，基金公司必须卖出一部分资产来回收资金，以应对基民的赎回需求，但是股票卖不出去，也面临着流动性的危机。所以基金公司开始变卖债券来获得资金，股市下跌致使债券市场也开始下跌。债券市场上的流动性也开始枯竭，此时债券也开始卖不动了。再不注入流动性，基金公司可能会面临无法满足赎回要求而技术性的破产。这也是A股市场上首次因为股价下跌，而导致的金融机构存在经营性的危机。

近几年，股票质押的风险也被经常提及，类似的，股票质押就是上市公司的股东将其股票质押给证券公司和银行来获取抵押贷款。但是一旦股价下跌，金融机构就会卖出股票，回收资金，和两融也是类似的。

至此，金融经济学的无套利定价讲完了，结合上学期的均衡定价，金融的核心就是定价，即金融理论的主干学习完毕。接下来我们要讲一些金融理论主干往上的一些叶子的部分。即金融摩擦的相关话题。但是主干的一个特点是其逻辑线索非常清晰，但是再看枝叶的时候，就会相对的散一些，根据其重要性讲一些内容。


















